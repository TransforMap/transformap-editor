!function(){"use strict";var e="undefined"==typeof global?self:global;if("function"!=typeof e.require){var t={},a={},n={},r={}.hasOwnProperty,i=/^\.\.?(\/|$)/,o=function(e,t){for(var a,n=[],r=(i.test(t)?e+"/"+t:t).split("/"),o=0,s=r.length;o<s;o++)a=r[o],".."===a?n.pop():"."!==a&&""!==a&&n.push(a);return n.join("/")},s=function(e){return e.split("/").slice(0,-1).join("/")},l=function(t){return function(a){var n=o(s(t),a);return e.require(n,t)}},d=function(e,t){var n=v&&v.createHot(e),r={id:e,exports:{},hot:n};return a[e]=r,t(r.exports,l(e),r),r.exports},c=function(e){return n[e]?c(n[e]):e},u=function(e,t){return c(o(s(e),t))},m=function(e,n){null==n&&(n="/");var i=c(e);if(r.call(a,i))return a[i].exports;if(r.call(t,i))return d(i,t[i]);throw new Error("Cannot find module '"+e+"' from '"+n+"'")};m.alias=function(e,t){n[t]=e};var p=/\.[^.\/]+$/,f=/\/index(\.[^\/]+)?$/,g=function(e){if(p.test(e)){var t=e.replace(p,"");r.call(n,t)&&n[t].replace(p,"")!==t+"/index"||(n[t]=e)}if(f.test(e)){var a=e.replace(f,"");r.call(n,a)||(n[a]=e)}};m.register=m.define=function(e,n){if(e&&"object"==typeof e)for(var i in e)r.call(e,i)&&m.register(i,e[i]);else t[e]=n,delete a[e],g(e)},m.list=function(){var e=[];for(var a in t)r.call(t,a)&&e.push(a);return e};var v=e._hmr&&new e._hmr(u,m,t,a);m._cache=a,m.hmr=v&&v.wrap,m.brunch=!0,e.require=m}}(),function(){var e;"undefined"==typeof window?this:window;require.register("fixtures/fixtures.js",function(e,t,a){"use strict";a.exports={listOfMediaFilesForPOI:[{mediaId:"d07d6ab3-4e3f-44ce-accc-b3efc96b3f04",ipfs:"QmVXmy59f5QqKDGyhpHbRiGnba5SfHaooDPCWhd8Xtgwz2",url:"https://ipfs.io/images/ipfs-illustration-history.svg",mimetype:"image/jpeg",name:"Chaotic connectome replacement image for the large image on the main screen",description:"some description",versionDate:"2017-07-30T16:01:34+00:00"},{mediaId:"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060",mimetype:"image/png",name:"Transformap Base",url:"https://base.transformap.co/images/transformap.png",versionDate:"2017-07-30T16:01:34+00:00"}],mediaFileMetadataBasic:{name:"some title",description:"some description",mimetype:"image/png",url:"https://base.transformap.co/images/transformap.png"},mediaFileMetadataComplete:{mediaId:"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060",name:"some title",description:"some description",mimetype:"image/png",url:"https://base.transformap.co/images/transformap.png",versionDate:"2017-07-30T16:01:34+00:00"},mediaFileMetadataCompleteDeleted:{mediaId:"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060",name:"some title",deleted:!0,description:"some description",mimetype:"image/png",url:"https://base.transformap.co/images/transformap.png",versionDate:"2017-07-30T16:01:34+00:00"},validAuthToken:{token:"d07d6ab3-4e3f-44ce-accc-b3efc96b3f04"},placeMetadata:{type:"Feature",properties:{name:"Bulgarian Food Bank","addr:country":"BG","addr:street":"бул. Васил Левски","addr:housenumber":"106","addr:postcode":"1000","addr:city":"София",POI_TYPE:"food bank",amenity:"social_facility","description:bg":"Организацията работи като свързващо звено между хранителната индустрия и социалните организации, за да увеличи многократно достъпа до хранително подпомагане в България. Тя създава системи за сигурност и контрол на храните, които постъпват като дарения.",website:"http://bgfoodbank.org","contact:email":"contact@bgfoodbank.org",organic:"no","fair-trade":"no",regional:"yes",free_keywords:"food bank;food waste",SSEDAS_PARTNER:"BILS",description:"The organisation acts as an interface between the food industry and social welfare organisations to increase access to food aid in Bulgaria. It sets up routines for guaranteeing that donated food is safe and properly managed.",type_of_initiative:"foodbank; recycling_foodwaste","contact:phone":"+3592 953 4100",social_facility:"food_bank"},geometry:{type:"Point",coordinates:[23.33513259888,42.69809702239]},_id:"2c10b95ea433712f0b06a3f7d310e7d5"},listOfMediaFileVersions:[{mediaId:"497123c0-f9d8-4e6c-acff-76ec9efcb265",name:"other version of the same file",versionDate:"2017-07-30T16:01:34+00:00",mimetype:"image.png",url:"https://base.transformap.co/images/transformap.png"},{mediaId:"c29c8d11-ec27-4fe1-9a23-dd10a3b37e11",name:"yet another version",versionDate:"2017-07-30T16:01:34+00:00",mimetype:"image.png",url:"https://base.transformap.co/images/transformap.png"}],listOfMediaFileVersionsUpdate:[{name:"other version of the same file",description:"a new description for the same file",versionDate:"2017-07-30T16:01:34+00:00",mimetype:"image.png",url:"https://base.transformap.co/images/transformap.png"},{mediaId:"497123c0-f9d8-4e6c-acff-76ec9efcb265",name:"a previous version of the same file",versionDate:"2017-07-30T16:01:34+00:00",mimetype:"image.png",url:"https://base.transformap.co/images/transformap.png"},{mediaId:"c29c8d11-ec27-4fe1-9a23-dd10a3b37e11",name:"yet another previous version",versionDate:"2017-07-30T16:01:34+00:00",mimetype:"image.png",url:"https://base.transformap.co/images/transformap.png"}]}}),require.register("fixtures/intercept_ajax.js",function(e,t,a){"use strict";var n=t("./fixtures.js");xhook.after(function(e,t){"GET"===e.method?(e.url.match(".*?/place/(.*)")&&(t.status=200,t.text=JSON.stringify(n.placeMetadata)),e.url.match(".*?/place/(.*)/media")&&(t.status=200,t.text=JSON.stringify(n.listOfMediaFilesForPOI)),e.url.match(".*?/media/(.*)")&&(t.status=200,t.text=JSON.stringify(n.mediaFileMetadataComplete)),e.url.match(".*?/media/(.*)/versions")&&(t.status=200,t.text=JSON.stringify(n.listOfMediaFileVersions)),e.url.match(".*?/auth/")&&(t.status=200,t.text=JSON.stringify(n.validAuthToken))):"POST"===e.method?(e.url.match(".*?/media/")&&(t.status=201,t.text=JSON.stringify(n.mediaFileMetadataComplete)),e.url.match(".*?/media/(.*)/versions")&&(t.status=201,t.text=JSON.stringify(n.listOfMediaFileVersionsUpdate)),e.url.match(".*?/place/")):"PUT"===e.method?(e.url.match(".*?/media/(.*)")&&(t.status=200,t.text=JSON.stringify(n.mediaFileMetadataComplete)),e.url.match(".*?/place/(.*)")&&(t.status=200)):"DELETE"===e.method&&(e.url.match(".*?/place/(.*)")&&(t.status=200),e.url.match(".*?/place/(.*)/media/(.*)")&&(t.status=200,t.text=JSON.stringify(n.placeMetadata)),e.url.match(".*?/auth/(.*)")&&(t.status=200))})}),require.register("initialize.js",function(e,t,a){"use strict";var n=t("lib/editor");document.addEventListener("DOMContentLoaded",function(){n(),console.log("Initialized app")})}),require.register("lib/auth_api.js",function(e,t,a){"use strict";function n(){return d}function r(){return void 0!==s}function i(e){if(s)return console.log("Auth token already available"),s;var t=l.createCORSRequest("GET",d);t.setRequestHeader("Content-Type","application/json"),t.send(),t.onreadystatechange=function(){if(4===t.readyState)if(200===t.status){var a=JSON.parse(t.responseText);e(a),s=a}else console.error(t)}}function o(e,t){if(!e)return console.log("logout: no authToken given"),!1;var a=l.createCORSRequest("GET",d);a.setRequestHeader("Content-Type","application/json"),a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(JSON.parse(a.responseText)):console.error(a))}}var s,l=t("./utils.js"),d=l.baseUrl+"/auth/";a.exports={getAuthEndpoint:n,isAlreadyLoggedIn:r,retrieveAuthToken:i,logout:o}}),require.register("lib/data_api.js",function(e,t,a){"use strict";function n(){return c}function r(e,t,a){if(!t)return console.error("updateOrCreatePOI: no data given"),!1;var n=d.createCORSRequest(e?"PUT":"POST",c+e);n.setRequestHeader("Content-Type","application/json"),n.send(t),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var e=JSON.parse(n.responseText);console.log(e),e.id?(a(e.id),alert("Save successful")):alert("Error: something wrent wrong on saving: "+JSON.stringify(e))}else console.error(n)}}function i(e,t){if(!e)return console.error("getPOI: no uuid given"),!1;var a=d.createCORSRequest("GET",n()+e);a.setRequestHeader("Content-Type","application/json"),a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(JSON.parse(a.responseText)):console.error(a))}}function o(e,t){if(!e)return console.error("deletePOI: no uuid given"),!1;var a=d.createCORSRequest("DELETE",c+e);a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(e):console.error(a))}}function s(e,t){if(!e)return console.error("retrieveMediaFilesForPOI: no uuid given"),!1;var a=d.createCORSRequest("GET",n()+e+"/media");a.setRequestHeader("Content-Type","application/json"),a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(JSON.parse(a.responseText)):console.error(a))}}function l(e,t,a){if(!e)return console.error("removeMediaFileFromPOI: no uuid given"),!1;if(!t)return console.error("removeMediaFileFromPOI: no mediaId given"),!1;var r=d.createCORSRequest("DELETE",n()+e+"/media/"+t);r.setRequestHeader("Content-Type","application/json"),r.send(),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(JSON.parse(r.responseText)):console.error(r))}}var d=t("./utils.js"),c=d.baseUrl+"/place/";a.exports={getDataEndpoint:n,createOrUpdatePOI:r,getPOI:i,deletePOI:o,retrieveMediaFilesForPOI:s,removeMediaFileFromPOI:l}}),require.register("lib/editor.js",function(e,t,a){"use strict";var n=t("./utils.js"),r=t("./red_fetch.js"),i=t("./translations.js"),o=t("./data_api.js"),s=t("./ui.js"),l=t("./map.js");window.translations=i;var d=["https://base.transformap.co/wiki/Special:EntityData/Q5.json","https://raw.githubusercontent.com/TransforMap/transformap-viewer/Q5-fallback.json"];"true"==='false'&&(console.log("integrating xhook and mocking ajax calls"),t("xhook"),t("../fixtures/intercept_ajax.js")),a.exports=function(){console.log("editor initialize start");var e=n.getUrlVars().place,t=i.selectAllowedLang(i.current_lang);console.log("lang on start: "+t),console.log(i.supported_languages),document.getElementById("plus").onclick=s.addFreeTagsRow,e&&o.getPOI(e,s.fillForm),s.addLanguageSwitcher(),i.fetchAndSetNewTranslation=i.fetchAndSetNewTranslation,r(d,i.initializeTranslatedTOIs,function(e){console.error("none of the lang init data urls available")}),document.getElementById("save").onclick=s.clickSubmit,document.getElementById("delete").onclick=s.clickDelete,document.getElementById("coordsearch").onclick=s.clickSearch,document.getElementById("newmedia").onclick=s.clickNewMedia,document.getElementById("loginbutton").onclick=s.clickLoginButton,document.onkeypress=s.stopRKey,document.getElementById("mediacancel").onclick=s.clickMediaCancel,document.getElementById("mediasave").onclick=s.clickMediaSave,l.initMap(),console.log("editor initialize end")}}),require.register("lib/map.js",function(e,t,a){"use strict";function n(e){var t=!!e&&{icon:new l},a={position:"bottomleft",draw:{polyline:!1,polygon:!1,rectangle:!1,circle:!1,marker:t},edit:{featureGroup:s,remove:!1}};return new d.Control.Draw(a)}function r(){return o}function i(){console.log("initMap start");var e,t,a,r,i='Map data by <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, under <a href="https://www.openstreetmap.org/copyright">ODbL</a>. ',u='POIs by <a href="http://solidariteconomy.eu">SUSY</a>, <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC-0</a>. ',m={};m.mapnik=new d.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:i+u,maxZoom:19,noWrap:!0}),m.stamen_terrain=new d.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com/">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. '+i+u,maxZoom:18,noWrap:!0}),m.stamen_terrain_bg=new d.tileLayer("https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.png",{attribution:'Map tiles by <a href="http://stamen.com/">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. '+i+u,maxZoom:18,noWrap:!0}),m.hot=new d.tileLayer("http://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png",{attribution:'Tiles courtesy of <a href="http://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>. '+i+u,maxZoom:20,noWrap:!0}),e||(e={"Stamen - Terrain":m.stamen_terrain,"Stamen - Terrain Background":m.stamen_terrain_bg,"OpenStreetMap - Mapnik":m.mapnik,"Humanitarian OpenStreetMap ":m.hot}),a||(a=m.mapnik),o=d.map("map",{zoomControl:!0,center:r||new d.LatLng(28.6,9),zoom:t||2,layers:a});var p=new d.Control.Layers(e);o.addControl(p);new d.Hash(o);return s=new d.FeatureGroup,o.addLayer(s),l=d.Icon.extend({options:{shadowUrl:null,iconAnchor:new d.Point(12,40),iconSize:new d.Point(25,40),iconUrl:"marker-green.png"}}),o.on(d.Draw.Event.CREATED,function(e){var t=e.layerType,a=e.layer;"marker"===t&&a.bindPopup(c),s.addLayer(a),o.my_current_marker=a,document.getElementById("_geometry_lon").value=a._latlng.lng.toFixed(6),document.getElementById("_geometry_lat").value=a._latlng.lat.toFixed(6),o.removeControl(o.my_drawControl),o.my_drawControl=n(!1),o.addControl(o.my_drawControl)}),o.on("draw:editmove",function(e){console.log("editmove"),console.log(e),document.getElementById("_geometry_lon").value=e.layer._latlng.lng.toFixed(6),document.getElementById("_geometry_lat").value=e.layer._latlng.lat.toFixed(6)}),o.on("moveend",function(e){var t=o.getCenter(),a="#"+o.getZoom()+"/"+t.lat+"/"+t.lng,n=document.getElementById("gotomap"),r=n.getAttribute("href");r.split("#");r=n.getAttribute("href").split("#")[0]+a,n.setAttribute("href",r);var i=document.getElementById("newbutton");i.setAttribute("href","./"+a)}),o.my_editableLayers=s,o.my_placeMarker=l,o.getDrawControl=n,o.updateMarkerFromForm=function(){var e=document.getElementById("_geometry_lat").value,t=document.getElementById("_geometry_lon").value;if(console.log("new lat: "+e+" lon: "+t),e&&t){var a=d.latLng(e,t);o.my_current_marker?o.my_current_marker.setLatLng(a):(o.my_current_marker=new d.marker([e,t],{icon:new o.my_placeMarker}),o.my_current_marker.bindPopup(c),o.my_editableLayers.addLayer(o.my_current_marker),o.removeControl(o.my_drawControl),o.my_drawControl=n(!1),o.addControl(o.my_drawControl)),o.panTo(a)}else console.log("no coords, remove marker"),o.my_current_marker.remove(),delete o.my_current_marker,o.removeControl(o.my_drawControl),o.my_drawControl=n(!0),o.addControl(o.my_drawControl)},document.getElementById("_geometry_lat").onblur=o.updateMarkerFromForm,document.getElementById("_geometry_lon").onblur=o.updateMarkerFromForm,console.log("initMap end"),o}var o,s,l,d=t("leaflet"),c=(t("leaflet-hash"),t("leaflet-draw"),"Press the edit button to move me. <img style=\"width:30px;height:30px;background-position:-150px -1px;background-image:url('images/spritesheet.svg');background-size: 270px 30px;\"> <br><br> Find it on the bottom left corner of the map.");a.exports={getMap:r,initMap:i}}),require.register("lib/mms_api.js",function(e,t,a){"use strict";function n(){return m}function r(e,t,a){if(!e)return console.error("createNewMEdiaFileForPOI: no uuid given"),!1;if(!t)return console.error("createNewMEdiaFileForPOI: no data given"),!1;var r=u.createCORSRequest("POST",n());r.setRequestHeader("Content-Type","application/json"),r.send(t),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(r.responseText):console.error(r))}}function i(e,t){if(!e)return console.error("retrieveMetadataForMediaFile: no mediaId given"),!1;var a=u.createCORSRequest("GET",n()+e);a.setRequestHeader("Content-Type","application/json"),a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(a.responseText):console.error(a))}}function o(e,t,a){if(!e)return console.error("retrieveMetadataForMediaFiles: no mediaId given"),!1;if(!t)return console.error("retrieveMetadataForMediaFiles: no data given"),!1;var r=u.createCORSRequest("PUT",n()+e);r.setRequestHeader("Content-Type","application/json"),r.send(t),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(r.responseText):console.error(r))}}function s(e,t){if(!e)return console.error("retrieveMediaFileVersions: no mediaId given"),!1;var a=u.createCORSRequest("GET",n()+e+"/versions");a.setRequestHeader("Content-Type","application/json"),a.send(),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t(a.responseText):console.error(a))}}function l(e,t,a){if(!e)return console.error("addMediaFileVersion: no mediaId given"),!1;if(!t)return console.error("addMediaFileVersion: no data given"),!1;var r=u.createCORSRequest("POST",n()+e+"/versions");r.setRequestHeader("Content-Type","application/json"),r.send(t),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(r.responseText):console.error(r))}}function d(e,t,a){if(!e)return console.error("setActiveMediaFileVersion: no mediaId given"),!1;if(!t)return console.error("setActiveMediaFileVersion: no versionId given"),!1;var r=u.createCORSRequest("POST",n()+e+"/versions/"+t);r.setRequestHeader("Content-Type","application/json"),r.send(),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(r.responseText):console.error(r))}}function c(e,t,a){if(!e)return console.error("uploadBlob: no mediaId given"),!1;if(!t)return console.error("uploadBlob: no blob given"),!1;var r=u.createCORSRequest("POST",n()+e+"/blob");r.setRequestHeader("Content-Type","multipart/form-data"),r.send(t),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?a(r.JSON.parse(responseText)):console.error(r))}}var u=t("./utils.js"),m=u.baseUrl+"/media/";a.exports={getMMSEndpoint:n,createNewMediaFileForPOI:r,retrieveMetadataForMediaFile:i,updateMedataForMediaFile:o,retrieveMediaFileVersions:s,addMediaFileVersion:l,setActiveMediaFileVersion:d,uploadBlob:c}}),require.register("lib/red_fetch.js",function(e,t,a){"use strict";function n(e,t,a,r){if(!e||Array!==e.constructor)return console.error("redundantFetch: argument is no array"),console.error(e),!1;var i=e[0];if("string"!=typeof i)return console.error("redundantFetch: url is no string"),!1;console.log("redundantFetch called, urls:"),console.log(e),e.shift();var o,s;0==e.length?(s=t,o=a):(s=t,o=function(i){n(e,t,a,r)});var l={url:i,cacheBusting:!(r&&r.cacheBusting===!1)};d(l).then(function(e){s(e),console.log("rfetch: success on "),console.log(e)},function(e){o(e),console.log("rfetch: fail on "),console.log(e)})}var r=function(e){return 200===e.status||0===e.status?Promise.resolve(e):Promise.reject(new Error(e.statusText))},i=function(e){return e.json()},o=function(){var e={},t=new Promise(function(t,a){e.resolve=t,e.reject=a});return e.then=t.then.bind(t),e["catch"]=t["catch"].bind(t),e.promise=t,e},s=function(){var e=o(),t=Array.prototype.slice.call(arguments);return window.fetch.apply(null,t).then(function(t){e.resolve(t)},function(t){e.reject(t)})["catch"](function(t){e["catch"](t)}),e},l=5e3,d=function(e){var t=s(e.cacheBusting?e.url+"?"+(new Date).getTime():e.url,{method:"get",headers:{Accept:"application/json"}}),a=setTimeout(function(){t.reject(new Error("Load timeout for resource: "+e.url))},l);return t.promise.then(function(e){return clearTimeout(a),e}).then(r).then(i)};a.exports=n}),require.register("lib/taxonomy.js",function(e,t,a){"use strict";function n(e,t){if(!e)return console.error("setFilterLang: no lang given"),!1;t||(t="Q8");var a="prefix bd: <http://www.bigdata.com/rdf#> prefix wikibase: <http://wikiba.se/ontology#> prefix wdt: <https://base.transformap.co/prop/direct/>prefix wd: <https://base.transformap.co/entity/>SELECT ?item ?itemLabel ?instance_of ?subclass_of ?type_of_initiative_tag ?interaction_tag ?needs_tag ?identity_tag ?wikipedia ?description WHERE {?item wdt:P8* wd:"+t+' .?item wdt:P8 ?subclass_of .OPTIONAL { ?item wdt:P4 ?instance_of . }OPTIONAL { ?item wdt:P15 ?type_of_initiative_tag }OPTIONAL { ?item wdt:P16 ?interaction_tag }OPTIONAL { ?item wdt:P17 ?needs_tag }OPTIONAL { ?item wdt:P18 ?identity_tag }OPTIONAL { ?item schema:description ?description FILTER(LANG(?description) = "'+e+'") }OPTIONAL { ?wikipedia schema:about ?item . ?wikipedia schema:inLanguage "en"}SERVICE wikibase:label {bd:serviceParam wikibase:language "'+e+'" }}';return"https://query.base.transformap.co/bigdata/namespace/transformap/sparql?query="+encodeURIComponent(a)+"&format=json"}a.exports={getLangTaxURL:n}}),require.register("lib/translations.js",function(e,t,a){"use strict";function n(){var e=window.navigator.languages?window.navigator.languages[0]:window.navigator.language||window.navigator.userLanguage;"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++)if(e[t].match(/-/)){var a=e[t].match(/^([a-zA-Z]*)-/)[1];if(e.indexOf(a)==-1){e.push(a);continue}}return e.indexOf("en")==-1&&e.push("en"),console.log(e),e}function r(){if(b=[],"en"!=_)for(var e=0;e<h.length;e++){var t=h[e];_!=t&&b.push(t)}console.log("new fallback langs: "+b.join(",")+".")}function i(){_="en";for(var e=0;e<h.length;e++){var t=h[e];if(v[t]){_=t;break}}d(_)}function o(e){var t;for(t in e.entities.Q5.labels)f.push(t);var a=f.join("|"),n='SELECT ?lang ?langLabel ?abbr WHERE{?lang wdt:P218 ?abbr;FILTER regex (?abbr, "^('+a+')$").SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }}';n="https://query.wikidata.org/bigdata/namespace/wdq/sparql?query="+encodeURIComponent(n)+"&format=json",$.getJSON(n,function(e){e.results.bindings.forEach(function(e){v[e.abbr.value]=e.langLabel.value,y[e.langLabel.value]=e.abbr.value,g.push(e.langLabel.value)}),g.sort(),i(),r(),g.forEach(function(e){var t=y[e],a=t==_?" class=default":"";console.log("adding lang '"+t+"' ("+e+")"),$("#languageSelector ul").append("<li targetlang="+t+a+" onClick='window.translations.switchToLang(\""+t+"\");'>"+e+"</li>")})})}function s(e){u([m.getLangTaxURL(e,"Q8"),"https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy."+e+".json"],p.fillTOIs,function(e){console.error("none of the taxonomy data urls available")},{cacheBusting:!1}),u([m.getLangTaxURL(e,"Q4"),"https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy."+e+".json"],p.fillTransforMapTax,function(e){console.error("none of the taxonomy data urls available")},{cacheBusting:!1})}function l(e){translations.initializeLanguageSwitcher(e);var t=translations.selectAllowedLang(translations.current_lang);translations.current_lang=t,s(t)}function d(e){$("#languageSelector li.default").removeClass("default"),$("#languageSelector li[targetlang="+e+"]").addClass("default"),_=e,window.translations.current_lang=e,window.translations.fetchAndSetNewTranslation(e),r(),console.log("new lang:"+e)}function c(e){if(console.log("selectAllowedLang("+e+") called"),e){if(f.indexOf(e)!=-1)return _=e;console.log("not in supported, try shorten");var t=e.match(/^([a-zA-Z]*)-/);if(t&&t[1]){var a=t[1];if(console.log("short: "+a),a&&f.indexOf(a)!=-1)return _=a,console.log("current_lang set to "+a),_}}return r(),_=b[0]&&f.indexOf(b[0])!=-1?b[0]:"en"}var u=t("./red_fetch.js"),m=t("./taxonomy.js"),p=t("./ui.js"),f=[],g=[],v={},y={},h=n(),_=h[0],b=[];a.exports={getLangs:n,initializeLanguageSwitcher:o,initializeTranslatedTOIs:l,supported_languages:f,browser_languages:h,current_lang:_,switchToLang:d,selectAllowedLang:c,fetchAndSetNewTranslation:s}}),require.register("lib/ui.js",function(e,t,a){"use strict";function n(e){if(k=e,k._deleted&&(document.getElementById("deleted").style.display="block"),k.properties)for(var t in k.properties)if(!/^_/.test(t)){var a=document.getElementById("_key_"+t),n=k.properties[t];if(a)a.value=n;else{for(var i=document.getElementById("freetags"),s=i.lastChild;3===s.nodeType;)s=s.previousSibling;var l=1===s.firstChild.nodeType?s.firstChild:s.firstChild.nextSibling;l.value=t;var d=1===s.lastChild.nodeType?s.lastChild:s.lastChild.previousSibling;d.value=n,o()}}if(r(k),k.geometry&&k.geometry.coordinates){var c=k.geometry.coordinates[0],u=k.geometry.coordinates[1];if(void 0===u||void 0===c)return void console.error("lat or lon empty");document.getElementById("_geometry_lon").value=c,document.getElementById("_geometry_lat").value=u;var m=F.getMap();m.my_current_marker=new L.marker([u,c],{icon:new m.my_placeMarker}),m.my_editableLayers.addLayer(m.my_current_marker),m.my_drawControl=m.getDrawControl(!1),m.addControl(m.my_drawControl),m.panTo(new L.LatLng(u,c))}else m.my_drawControl=m.getDrawControl(!0),m.addControl(m.my_drawControl);k.properties&&k.properties._id?(document.getElementById("_id").value=k.properties._id,$("#transformapapilink").attr("href",b.getDataEndpoint()+k.properties._id)):k._id&&(document.getElementById("_id").value=k._id,$("#transformapapilink").attr("href",b.getDataEndpoint()+k._id)),k.properties.osm&&$("#osmlink").attr("href",k.properties.osm)}function r(e){$("#media").html(""),b.retrieveMediaFilesForPOI(e._id,function(t){$(".relatedMediaTitle").text("Related media files ("+t.length+")");for(var a=0;a<t.length;a++){var n=$('<div class="row mediaFile '+t[a].mediaId+'"></div>'),i=$('<div class="row mediaInfo"></div>');t[a].name&&i.append("<b>"+t[a].name+"</b>"),t[a].description&&i.append("<p>"+t[a].description+"</p>");var o=$('<div class="row"></div>'),s=$('<a class="mediaOption remove">Remove</h4>');s.on("click",{metadata:t[a],currentData:e},function(t){var a=t.data;console.log("removeButton clicked for mediaFile with id:"+a.metadata.mediaId),confirm("Are you sure you want to delete this media file?")&&dataAPI.removeMediaFileFromPOI(a.currentData._id,a.metadata.mediaId,function(){$("."+a.metadata.mediaId).remove(),r(e)})});var l=$('<a class="mediaOption edit" data-toggle="modal" data-target="#mediaFileDialog" data-id="'+t[a].mediaId+'">Edit</h4>');l.on("click",{metadata:t[a],currentData:e},function(e){var t=e.data;console.log("editButton clicked for mediaFile with id:"+t.metadata.mediaId),$("#mediaFileDialogContent").find(".createOrUpdate").text("update"),$("#mediaFileDialogContent").find(".mediaId").text(t.metadata.mediaId),$("#mediaFileDialogContent").find(".name").val(t.metadata.name),$("#mediaFileDialogContent").find(".description").val(t.metadata.description),$("#mediaFileDialogContent").find("img").attr("src",t.metadata.url),$("#mediaFileDialogContent").find("img").show(),$("#mediaThumbUpload").hide(),$("#mediaFileDialogContent").find(".metadata").text(JSON.stringify(t.metadata))}),o.append(s),o.append(l),i.append(o);var d="https://s3.amazonaws.com/FringeBucket/image_placeholder.png";"image/png"!==t[a].mimetype&&"image/jpeg"!==t[a].mimetype||(d=t[a].url),n.append('<img class="mediaThumb" src="'+d+'"/>'),n.append(i),$("#media").append(n).append("<hr>")}})}function i(){$("#menu").append("<div id=languageSelector onClick=\"$('#languageSelector ul').toggleClass('open');\"><span lang=en>Choose Language:</span><ul></ul></div>")}function o(){for(var e=document.getElementById("freetags"),t=e.lastChild;3===t.nodeType;)t=t.previousSibling;var a=1===t.firstChild.nodeType?t.firstChild:t.firstChild.nextSibling,n=parseInt(a.id.slice(-1))+1,r=document.createElement("div"),i=document.createAttribute("class");i.value="row",r.setAttributeNode(i);var o=document.createElement("input"),s=document.createAttribute("class");s.value="form-control",o.setAttributeNode(s);var s=document.createAttribute("class");s.value="form-control";var l=document.createElement("input");l.setAttributeNode(s);var d=document.createAttribute("id");d.value="key"+n;var c=document.createAttribute("id");c.value="value"+n,o.setAttributeNode(d),l.setAttributeNode(c);var u=document.createAttribute("name");u.value="freetags",o.setAttributeNode(u),l.setAttributeNode(u.cloneNode(!0)),r.appendChild(o),r.appendChild(l),e.appendChild(r)}function s(e){if("string"!=typeof e)return[];for(var t=e.split(";"),a=0;a<t.length;a++)t[a]=t[a].trim();return t}function l(e){console.log("fillTransforMapTax called");var t=e.results.bindings,a=t[0].itemLabel["xml:lang"],n=[],r=[],i=[];t.forEach(function(e){if(e.subclass_of){var t={};t[a]=e.itemLabel.value;var o={item:e.item.value,label:t};"https://base.transformap.co/entity/Q146"==e.subclass_of.value?(o.needs_tag=e.needs_tag.value,n.push(o)):"https://base.transformap.co/entity/Q150"==e.subclass_of.value?(o.interaction_tag=e.interaction_tag.value,r.push(o)):"https://base.transformap.co/entity/Q176"==e.subclass_of.value&&(o.identity_tag=e.identity_tag.value,i.push(o))}}),$("#_key_provides").empty(),n.forEach(function(e){var t=$("<option>");if(t.attr("value",e.needs_tag),k.properties&&k.properties.provides){var n=s(k.properties.provides);n.forEach(function(a){a===e.needs_tag&&t.attr("selected","selected")})}t.append(e.label[a]),$("#_key_provides").append(t),$("#_key_provides").selectpicker("refresh")}),$("#_key_interaction").empty(),r.forEach(function(e){var t=$("<option>");if(t.attr("value",e.interaction_tag),k.properties&&k.properties.interaction){var n=s(k.properties.interaction);n.forEach(function(a){a===e.interaction_tag&&t.attr("selected","selected")})}t.append(e.label[a]),$("#_key_interaction").append(t),$("#_key_interaction").selectpicker("refresh")}),$("#_key_identity").empty(),i.forEach(function(e){var t=$("<option>");if(t.attr("value",e.identity_tag),k.properties&&k.properties.identity){var n=s(k.properties.identity);n.forEach(function(a){a===e.identity_tag&&t.attr("selected","selected")})}t.append(e.label[a]),$("#_key_identity").append(t),$("#_key_identity").selectpicker("refresh")})}function d(e){function t(e,t){return"https://base.transformap.co/entity/Q20"===e.item?1:"https://base.transformap.co/entity/Q20"===t.item?-1:e.type_of_initiative_tag&&e.type_of_initiative_tag.match(/^other_/)?1:t.type_of_initiative_tag&&t.type_of_initiative_tag.match(/^other_/)?-1:e.label[o]<t.label[o]?-1:1}$("#_key_type_of_initiative").empty();var a=[],n={},r=document.getElementById("_key_type_of_initiative"),i=e.results.bindings,o=i[0].itemLabel["xml:lang"];i.forEach(function(e){if(e.type_of_initiative_tag&&!n[e.type_of_initiative_tag.value]){var t={};t[o]=e.itemLabel.value;var r={item:e.item.value,label:t,type_of_initiative_tag:e.type_of_initiative_tag.value};a.push(r),n[e.type_of_initiative_tag.value]=r}}),a.sort(t),a.forEach(function(e){var t=document.createElement("option"),a=document.createAttribute("value");if(a.value=e.type_of_initiative_tag,t.setAttributeNode(a),k.properties&&k.properties.type_of_initiative){var n=s(k.properties.type_of_initiative);n.forEach(function(a){if(a===e.type_of_initiative_tag){var n=document.createAttribute("selected");t.setAttributeNode(n)}})}var i=document.createTextNode(e.label[o]);t.appendChild(i),r.appendChild(t),$("#_key_type_of_initiative").selectpicker("refresh")})}function c(){console.log("clickSubmit enter");for(var e=["_key_type_of_initiative","_key_name","_geometry_lat","_geometry_lon"],t=0;t<e.length;t++){var a=e[t],n=document.getElementById(a).value;if(!n||!n.length)return console.error("submit: field "+a+" empty"),alert("Error on submit: field "+a.replace(/^_key_/,"")+" is not allowed to be empty"),!1}var r={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[parseFloat(document.getElementById("_geometry_lon").value),parseFloat(document.getElementById("_geometry_lat").value)]}},i=document.getElementsByTagName("input"),o={keys:{},values:{}};console.log(i);for(var t=0;t<i.length;t++){var s=i[t];if("text"!==!s.type&&s.value&&s.id)if(console.log(s.id+": "+s.value),/^_key_/.test(s.id)){var l=s.id.replace(/^_key_/,"");r.properties[l]=s.value.trim()}else if(/^key[0-9]+$/.test(s.id)&&"freetags"===s.name){var d=s.id.replace(/^key/,"");o.keys[d]=s.value}else if(/^value[0-9]+$/.test(s.id)&&"freetags"===s.name){var d=s.id.replace(/^value/,"");o.values[d]=s.value}}console.log(o);for(var c in o.keys){var l=o.keys[c].trim();l&&o.values[c]&&(r.properties[l]=o.values[c].trim())}for(var m=document.getElementsByTagName("select"),t=0;t<m.length;t++){var s=m[t];if(/^_key_/.test(s.id)&&s.value)for(var l=s.id.replace(/^_key_/,""),p=0;p<s.children.length;p++){var f=s.children[p];f.selected===!0&&(r.properties[l]=(r.properties[l]?r.properties[l]+";":"")+f.value)}}for(var g=document.getElementsByTagName("textarea"),t=0;t<g.length;t++){var s=g[t];if(/^_key_/.test(s.id)&&s.value){
var l=s.id.replace(/^_key_/,"");r.properties[l]=s.value.trim()}}console.log(r);var v=document.getElementById("_id").value,y=JSON.stringify(r);console.log(y),b.createOrUpdatePOI(v,y,u),document.getElementById("deleted").style.display="none"}function u(e){document.getElementById("_id").value=e,$("#transformapapilink").attr("href",b.getDataEndpoint()+e),$("#osmlink").attr("href",$("#_key_osm").attr("value"))}function m(){var e=document.getElementById("_id").value;b.deletePOI(e,p),document.getElementById("deleted").style.display="block"}function p(e){console.log("Successfully deleted POI: "+e)}function f(){var e=document.getElementById("_key_addr:country").value,t=document.getElementById("_key_addr:city").value,a=document.getElementById("_key_addr:street").value,n=document.getElementById("_key_addr:housenumber").value,r="q=";a&&(n&&(r+=n+"+"),r+=a+","),t&&(r+=t+","),r+=e;var i="//nominatim.openstreetmap.org/search?"+r+"&format=json&limit=1&email=mapping@transformap.co";console.log(i),redFetch([i],function(e){if(console.log(e),1!==e.length)return console.error("error in Nominatim return data: length != 1"),void alert("Sorry, Nothing found");var t=e[0];"building"===t["class"]||"amenity"===t["class"]||"shop"===t["class"]||"place"===t["class"]&&"house"===t.type?(console.log("address found exactly"),document.getElementById("_geometry_lon").value=t.lon,document.getElementById("_geometry_lat").value=t.lat,document.getElementById("_geometry_lat").focus(),document.getElementById("_geometry_lon").focus(),F.getMap().setView(new L.LatLng(t.lat,t.lon),18)):(F.getMap().setView(new L.LatLng(t.lat,t.lon),18),console.log("address not found exactly"),setTimeout(function(){alert("Attention: The address was not found exactly, please place the marker manually!"),document.getElementById("_geometry_lon").value="",document.getElementById("_geometry_lat").value="",document.getElementById("_geometry_lon").focus(),document.getElementById("_geometry_lat").focus()},400))},function(e){console.log(e),alert("Sorry, Address search did not work")})}function g(e){var e=e||event||null,t=e.target?e.target:e.srcElement?e.srcElement:null;if(13==e.keyCode&&"text"==t.type)return!1}function v(){var e=$("#mediaFileDialogContent").find(".poiUUID").text(),t=$("#mediaFileDialogContent").find(".mediaId").text();if("create"==$("#mediaFileDialogContent").find(".createOrUpdate").text()){var a={name:$("#mediaFileDialogContent").find(".name").val(),description:$("#mediaFileDialogContent").find(".name").val(),versionDate:(new Date).toISOString()};if(I.getCurrentBlob()){x.uploadBlob(I.getCurrentBlob(),function(){a.url=blob.url,a.mimetype=blob.mimetype,x.createNewMediaFileForPOI(e,a,function(){$("#mediaFileDialog").modal("toggle")})})}else x.createNewMediaFileForPOI(e,a,function(){$("#mediaFileDialog").modal("toggle")})}else{var a=JSON.parse($("#mediaFileDialogContent").find(".metadata").text());if(a.name=$("#mediaFileDialogContent").find(".name").val(),a.description=$("#mediaFileDialogContent").find(".description").val(),I.getCurrentBlob()){x.uploadBlob(I.getCurrentBlob(),function(){a.url=blob.url,a.mimetype=blob.mimetype,x.addMediaFileVersion(t,a,function(){x.updateMedataForMediaFile(t,a,function(){$("#mediaFileDialog").modal("toggle")})})})}else x.addMediaFileVersion(t,a,function(){x.updateMedataForMediaFile(t,a,function(){$("#mediaFileDialog").modal("toggle")})})}}function y(){$("#mediaFileDialog").modal("toggle")}function h(){console.log("newMedia button clicked"),$("#mediaFileDialogContent").find(".createOrUpdate").text("create"),$("#mediaFileDialogContent").find(".poiUUID").text(k._id),$("#mediaFileDialogContent").find(".name").val(""),$("#mediaFileDialogContent").find(".description").val(""),$("#mediaFileDialogContent").find("img").hide(),$("#mediaThumbUpload").show(),$("#mediaFileDialogContent").find(".metadata").text(""),$("#mediaFileDialogContent").find(".mediaVersions").html(""),document.getElementById("mediaThumbUpload").addEventListener("change",I.handleFileSelect,!1)}function _(){w.isAlreadyLoggedIn()?w.logout(w.retrieveAuthToken(),function(e){$("#loginbutton").text("Login")}):w.retrieveAuthToken(function(e){$("#loginbutton").text("Logout")})}var b=t("./data_api.js"),x=t("./mms_api.js"),w=t("./auth_api.js"),F=t("./map.js"),I=t("./utils.js"),k={};a.exports={fillForm:n,addLanguageSwitcher:i,addFreeTagsRow:o,fillTransforMapTax:l,fillTOIs:d,map:F,clickSubmit:c,clickDelete:m,clickSearch:f,stopRKey:g,clickMediaSave:v,clickMediaCancel:y,clickNewMedia:h,clickLoginButton:_}}),require.register("lib/utils.js",function(e,t,a){"use strict";function n(e,t){var a=new XMLHttpRequest;return"withCredentials"in a?a.open(e,t,!0):"undefined"!=typeof XDomainRequest?(a=new XDomainRequest,a.open(e,t)):a=null,a}function r(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,a,n){e[a]=n.replace(/#.*$/,"")});return e}function i(e){var t=/.+?\:\/\/.+?(\/.+?)(?:#|\?|$)/;return t.exec(e)[1]}function o(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?a:3&a|8).toString(16)});return t}function s(e,t){var a=e.target.files,n=new FileReader;n.onload=function(e){var t=e.target.result;d=t,console.log("Storing current asset's binary content in memory: "+d)},n.onerror=function(e){console.error("File could not be read! Code "+e.target.error.code),ui.currentBlob=void 0};for(var r,i={binary:["image/png","image/jpeg"]},o=0;o<a.length;o++)r=a[o],null!==r&&i.binary.indexOf(r.type)>-1&&n.readAsArrayBuffer(r)}function l(){return d}var d,c='//transformap-data.apps.allmende.io';a.exports={createCORSRequest:n,getUrlVars:r,getUrlPath:i,generateUUID:o,handleFileSelect:s,getCurrentBlob:l,baseUrl:c}}),require.register("test/data_api.tests.js",function(e,t,a){"use strict";var n=t("assert"),r=t("../lib/data_api.js");describe("DATA API",function(){describe("getDataEndpoint",function(){it("should return https://data.transformap.co/place/",function(){var e=r.getDataEndpoint();n.equal(e,"https://data.transformap.co/place/")})}),describe("createOrUpdatePOI",function(){it("should return false if no data is provided",function(){var e=r.createOrUpdatePOI("some_uuid",void 0,function(){});n.equal(e,!1)})}),describe("getPOI",function(){it("should return false if no uuid is provided",function(){var e=r.getPOI(void 0,function(){});n.equal(e,!1)})}),describe("deletePOI",function(){it("should return false if no uuid is provided",function(){var e=r.deletePOI(void 0,function(){});n.equal(e,!1)})}),describe("retrieveMediaFilesForPOI",function(){it("should return false if no uuid is provided",function(){var e=r.retrieveMediaFilesForPOI(void 0,function(){});n.equal(e,!1)})}),describe("removeMediaFileFromPOI",function(){it("should return false if no uuid is provided",function(){var e=r.removeMediaFileFromPOI(void 0,"some_media_id",function(){});n.equal(e,!1)}),it("should return false if no mediaId is provided",function(){var e=r.removeMediaFileFromPOI("some_uuid",void 0,function(){});n.equal(e,!1)})})})}),require.register("test/mms_api.tests.js",function(e,t,a){"use strict";var n=t("assert"),r=t("../lib/mms_api.js");describe("MMS API",function(){describe("getMMSEndpoint",function(){it("should return https://data.transformap.co/media/",function(){var e=r.getMMSEndpoint();n.equal(e,"https://data.transformap.co/media/")})}),describe("createNewMediaFileForPOI",function(){it("should return false if no uuid is provided",function(){var e=r.createNewMediaFileForPOI(void 0,{name:"test"},function(){});n.equal(e,!1)}),it("should return false if no data is provided",function(){var e=r.createNewMediaFileForPOI("some_uuid",void 0,function(){});n.equal(e,!1)})}),describe("retrieveMetadataForMediaFile",function(){it("should return false if no mediaId is provided",function(){var e=r.retrieveMetadataForMediaFile(void 0,function(){});n.equal(e,!1)})}),describe("updateMedataForMediaFile",function(){it("should return false if no uuid is provided",function(){var e=r.updateMedataForMediaFile(void 0,{name:"test"},function(){});n.equal(e,!1)}),it("should return false if no data is provided",function(){var e=r.updateMedataForMediaFile("some_uuid",void 0,function(){});n.equal(e,!1)})}),describe("retrieveMediaFileVersions",function(){it("should return false if no mediaId is provided",function(){var e=r.retrieveMediaFileVersions(void 0,function(){});n.equal(e,!1)})}),describe("addMediaFileVersion",function(){it("should return false if no mediaId is provided",function(){var e=r.addMediaFileVersion(void 0,{name:"test"},function(){});n.equal(e,!1)}),it("should return false if no data is provided",function(){var e=r.addMediaFileVersion("some_media_id",void 0,function(){});n.equal(e,!1)})}),describe("setActiveMediaFileVersion",function(){it("should return false if no mediaId is provided",function(){var e=r.setActiveMediaFileVersion(void 0,{name:"test"},function(){});n.equal(e,!1)}),it("should return false if no versionId is provided",function(){var e=r.setActiveMediaFileVersion("some_media_id",void 0,function(){});n.equal(e,!1)})}),describe("uploadBlob",function(){it("should return false if no mediaId is provided",function(){var e=r.uploadBlob(void 0,"some binary content",function(){});n.equal(e,!1)}),it("should return false if no blob is provided",function(){var e=r.uploadBlob("some_media_id",void 0,function(){});n.equal(e,!1)})})})}),require.register("test/utils.tests.js",function(e,t,a){"use strict";var n=t("assert"),r=(t("../lib/data_api.js"),t("../lib/utils.js"));describe("UTILS",function(){describe("getUrlPath",function(){it("should return expected path",function(){var e="https://data.transformap.co/place/",t=r.getUrlPath(e);n.equal(t,"/place/")}),it("should return expected multi-valued path",function(){var e="https://data.transformap.co/place/1234/media",t=r.getUrlPath(e);n.equal(t,"/place/1234/media")})}),describe("generateUUID",function(){it("should return the expected format xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",function(){var e=r.generateUUID();n.equal(e.length,36),n.equal(e[14],"4")})})})}),require.alias("assert/assert.js","assert"),require.alias("process/browser.js","process"),require.alias("util/util.js","sys"),e=require("process"),require.register("___globals___",function(e,t,a){})}(),require("___globals___");