{"version":3,"sources":["app/initialize.js","app/lib/editor.js","app/lib/getUrlVars.js","app/lib/map.js","app/lib/red_fetch.js","app/lib/taxonomy.js","app/lib/translations.js"],"names":["editor","require","document","addEventListener","console","log","initMap","getUrlVars","redFetch","taxonomy","translations","window","map","endpoint","module","exports","urlVars","dataUrls","place","test","normalizedPlace","replace","length","createToiArray","toiString","toiArray","split","i","trim","startLang","selectAllowedLang","current_lang","supported_languages","typeOfInintiatives","toiHashtable","fillTransforMapTax","data","dataArray","results","bindings","itemLabel","needs","interactions","identities","forEach","entry","subclass_of","label","value","currentObject","item","needs_tag","push","interaction_tag","identity_tag","$","empty","newOption","attr","currentData","properties","provides","needs_array","need","append","interaction","interactions_array","interact","identity","identity_array","fillTOIs","toiSelect","getElementById","type_of_initiative_tag","labelCompare","a","b","match","sort","createElement","optionValue","createAttribute","setAttributeNode","type_of_initiative","tois","toi","newSelected","createTextNode","appendChild","addFreeTagsRow","freetags","lastRow","lastChild","nodeType","previousSibling","keyNode","firstChild","nextSibling","newNr","parseInt","id","slice","newRow","divClass","newKey","bootstrapClass","newValue","keyId","valueId","elementName","cloneNode","fillForm","placeData","_deleted","style","display","key","field","valueNode","geometry","coordinates","lon","lat","undefined","error","my_current_marker","L","marker","icon","my_placeMarker","my_editableLayers","addLayer","my_drawControl","getDrawControl","addControl","panTo","LatLng","_id","osm","e","menu","initializeTranslatedTOIs","Q5data","initializeLanguageSwitcher","nowPossibleLang","fetchAndSetNewTranslation","lang","getLangTaxURL","cacheBusting","createCORSRequest","method","url","xhr","XMLHttpRequest","open","XDomainRequest","clickSubmit","requiredFields","alert","parseFloat","allInputs","getElementsByTagName","freeTags","keys","values","element","type","name","nr","keynr","allSelects","childCounter","children","child","selected","allTextareas","uuid","sendData","JSON","stringify","setRequestHeader","send","onreadystatechange","readyState","status","retJson","parse","responseText","onclick","clickDelete","confirm","clickSearch","country","city","street","housenumber","querystring","query","successData","result","class","focus","setView","setTimeout","stopRKey","evt","event","node","target","srcElement","keyCode","onkeypress","updateLinkPosition","centre","getCenter","targetlocation","getZoom","lng","maplink","href","getAttribute","splitstr","setAttribute","newlink","on","vars","parts","location","m","L_Hash","L_Draw","editableLayers","drawControl","placeMarker","popupText","allowNewMarker","markerValue","options","position","draw","polyline","polygon","rectangle","circle","edit","featureGroup","remove","Control","Draw","attrOsm","attrPois","leafletBgMaps","zoom","defaultlayer","center","baseMaps","tileLayer","attribution","maxZoom","noWrap","zoomControl","layers","ctrl","Layers","hash","Hash","FeatureGroup","Icon","extend","shadowUrl","iconAnchor","Point","iconSize","iconUrl","Event","CREATED","layerType","layer","bindPopup","_latlng","toFixed","removeControl","updateMarkerFromForm","coords","latLng","setLatLng","onblur","processStatus","response","Promise","resolve","reject","Error","statusText","parseJson","json","getWrappedPromise","wrappedPromise","promise","then","bind","catch","getWrappedFetch","args","Array","prototype","call","arguments","fetch","apply","MAX_WAITING_TIME","getJSON","params","wrappedFetch","Date","getTime","headers","timeoutId","clearTimeout","myGetJSON","successFunction","errorFunction","getJSONparams","redundantFetch","dataUrlArray","constructor","currentUrl","shift","localErrorFunction","localSuccessFunction","tax_query","encodeURIComponent","getLangs","language","navigator","languages","userLanguage","short_lang","indexOf","setFallbackLangs","fallback_langs","browser_languages","abbr","join","resetLang","abbr_langnames","switchToLang","langnames","langnames_abbr","returned_data","entities","Q5","labels","langstr","langstr_query","langstrings","langLabel","langcode","is_default","removeClass","addClass","wishedLang","matches"],"mappings":"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","file":"public/app.js","sourcesContent":["const editor = require('lib/editor')\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  // do your setup here\n  editor()\n  console.log('Initialized app')\n})\n","/* global alert, L, XMLHttpRequest, XDomainRequest */ // used by standardjs (linter)\n\nconst initMap = require('./map.js')\nconst getUrlVars = require('./getUrlVars.js')\nconst redFetch = require('./red_fetch.js')\nconst taxonomy = require('./taxonomy.js')\nconst translations = require('./translations.js')\nwindow.translations = translations\n\nvar map\nconst endpoint = 'https://data.transformap.co/place/'\n\nmodule.exports = function () {\n  console.log('editor initialize start')\n\n  map = initMap()\n\n  var urlVars = getUrlVars()\n  var dataUrls\n  const place = urlVars['place']\n  if (place) {\n    if (/^[0-9a-f-]{32,36}$/i.test(place)) {\n      const normalizedPlace = place.replace(/-/, '')\n      if (normalizedPlace.length === 32) {\n        dataUrls = [ endpoint + place, 'http://192.168.0.2:6000/place/' + place, place ]\n      } else {\n        dataUrls = [ place ]\n      }\n    } else {\n      dataUrls = [ place ]\n    }\n  }\n\n  function createToiArray (toiString) {\n    if (typeof (toiString) !== 'string') { return [] }\n    var toiArray = toiString.split(';')\n    for (var i = 0; i < toiArray.length; i++) {\n      toiArray[i] = toiArray[i].trim()\n    }\n    return toiArray\n  }\n\n  var startLang = translations.selectAllowedLang(translations.current_lang)\n  console.log(\"lang on start: \" + startLang)\n  console.log(translations.supported_languages)\n  var typeOfInintiatives = []\n  var toiHashtable = {}\n\n  function fillTransforMapTax (data) {\n    console.log('fillTransforMapTax called')\n\n    var dataArray = data.results.bindings\n    const current_lang = dataArray[0].itemLabel['xml:lang']\n\n    var needs = []\n    var interactions = []\n    var identities = []\n\n    dataArray.forEach(function (entry) {\n      if (!entry.subclass_of) {\n        return\n      }\n      var label = {}\n      label[current_lang] = entry.itemLabel.value\n      var currentObject = {\n        item: entry.item.value,\n        label: label\n      }\n      if(entry.subclass_of.value == 'https://base.transformap.co/entity/Q146') {\n        currentObject['needs_tag'] = entry.needs_tag.value\n        needs.push(currentObject)\n      } else if (entry.subclass_of.value == 'https://base.transformap.co/entity/Q150') {\n        currentObject['interaction_tag'] = entry.interaction_tag.value\n        interactions.push(currentObject)\n      } else if (entry.subclass_of.value == 'https://base.transformap.co/entity/Q176') {\n        currentObject['identity_tag'] = entry.identity_tag.value\n        identities.push(currentObject)\n      }\n    });\n\n    //needs\n    $('#_key_provides').empty()\n    needs.forEach(function (entry) {\n      var newOption = $('<option>')\n      newOption.attr('value', entry.needs_tag)\n\n      if (currentData.properties && currentData.properties.provides) {\n        var needs_array = createToiArray(currentData.properties.provides)\n        needs_array.forEach(function (need) {\n          if (need === entry.needs_tag) {\n            newOption.attr('selected','selected')\n          }\n        })\n      }\n      newOption.append(entry.label[current_lang])\n      $('#_key_provides').append(newOption)\n    })\n\n    //interaction\n    $('#_key_interaction').empty()\n    interactions.forEach(function (entry) {\n      var newOption = $('<option>')\n      newOption.attr('value', entry.interaction_tag)\n\n      if (currentData.properties && currentData.properties.interaction) {\n        var interactions_array = createToiArray(currentData.properties.interaction)\n        interactions_array.forEach(function (interact) {\n          if (interact === entry.interaction_tag) {\n            newOption.attr('selected','selected')\n          }\n        })\n      }\n      newOption.append(entry.label[current_lang])\n      $('#_key_interaction').append(newOption)\n    })\n\n    //identity\n    $('#_key_identity').empty()\n    identities.forEach(function (entry) {\n      var newOption = $('<option>')\n      newOption.attr('value', entry.identity_tag)\n\n      if (currentData.properties && currentData.properties.identity) {\n        var identity_array = createToiArray(currentData.properties.identity)\n        identity_array.forEach(function (identity) {\n          if (identity === entry.identity_tag) {\n            newOption.attr('selected','selected')\n          }\n        })\n      }\n      newOption.append(entry.label[current_lang])\n      $('#_key_identity').append(newOption)\n    })\n  }\n\n  function fillTOIs (data) {\n    $('#_key_type_of_initiative').empty()\n\n    typeOfInintiatives = []\n    toiHashtable = {}\n\n    var toiSelect = document.getElementById('_key_type_of_initiative')\n    var dataArray = data.results.bindings\n    const current_lang = dataArray[0].itemLabel['xml:lang']\n    dataArray.forEach(function (entry) {\n      if (!entry.type_of_initiative_tag) {\n        return\n      }\n      if (toiHashtable[entry.type_of_initiative_tag.value]) { // filter out duplicates\n        return\n      }\n      var label = {}\n      label[current_lang] = entry.itemLabel.value\n\n      var currentObject = {\n        item: entry.item.value,\n        label: label,\n        type_of_initiative_tag: entry.type_of_initiative_tag.value\n      }\n      typeOfInintiatives.push(currentObject)\n      toiHashtable[entry.type_of_initiative_tag.value] = currentObject\n    })\n    function labelCompare (a, b) {\n      // 'Others' cat should get sorted last\n      if (a.item === 'https://base.transformap.co/entity/Q20') return 1\n      if (b.item === 'https://base.transformap.co/entity/Q20') return -1\n\n      // in toi list, 'other*' should be last\n      if (a.type_of_initiative_tag && a.type_of_initiative_tag.match(/^other_/)) return 1\n      if (b.type_of_initiative_tag && b.type_of_initiative_tag.match(/^other_/)) return -1\n\n      if (a.label[current_lang] < b.label[current_lang]) {\n        return -1\n      } else {\n        return 1\n      }\n    }\n    typeOfInintiatives.sort(labelCompare)\n\n    typeOfInintiatives.forEach(function (entry) {\n      var newOption = document.createElement('option')\n      var optionValue = document.createAttribute('value')\n      optionValue.value = entry.type_of_initiative_tag\n      newOption.setAttributeNode(optionValue)\n\n      if (currentData.properties && currentData.properties.type_of_initiative) {\n        var tois = createToiArray(currentData.properties.type_of_initiative)\n        tois.forEach(function (toi) {\n          if (toi === entry.type_of_initiative_tag) {\n            var newSelected = document.createAttribute('selected')\n            newOption.setAttributeNode(newSelected)\n          }\n        })\n      }\n\n      var label = document.createTextNode(entry.label[current_lang]) // FIXME fallback langs\n      newOption.appendChild(label)\n\n      toiSelect.appendChild(newOption)\n    })\n  }\n\n  function addFreeTagsRow () {\n    var freetags = document.getElementById('freetags')\n\n    var lastRow = freetags.lastChild\n    while (lastRow.nodeType === 3) { // 3 = text-node\n      lastRow = lastRow.previousSibling\n    }\n\n    var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling\n    var newNr = parseInt(keyNode.id.slice(-1)) + 1\n\n    var newRow = document.createElement('div')\n    var divClass = document.createAttribute('class')\n    divClass.value = 'row'\n    newRow.setAttributeNode(divClass)\n    var newKey = document.createElement('input')\n    var bootstrapClass = document.createAttribute('class')\n    bootstrapClass.value = 'form-control';\n    newKey.setAttributeNode(bootstrapClass);\n    var bootstrapClass = document.createAttribute('class')\n    bootstrapClass.value = 'form-control';\n    var newValue = document.createElement('input')\n    newValue.setAttributeNode(bootstrapClass);\n    var keyId = document.createAttribute('id')\n    keyId.value = 'key' + newNr\n    var valueId = document.createAttribute('id')\n    valueId.value = 'value' + newNr\n    newKey.setAttributeNode(keyId)\n    newValue.setAttributeNode(valueId)\n\n    var elementName = document.createAttribute('name')\n    elementName.value = 'freetags'\n    newKey.setAttributeNode(elementName)\n    newValue.setAttributeNode(elementName.cloneNode(true))\n\n    newRow.appendChild(newKey)\n    newRow.appendChild(newValue)\n    freetags.appendChild(newRow)\n  }\n\n  var currentData = {}\n\n  function fillForm (placeData) {\n    currentData = placeData\n\n    if (currentData._deleted) {\n      document.getElementById('deleted').style.display = 'block'\n    }\n\n    if (currentData.properties) {\n      for (var key in currentData.properties) {\n        // ignore DB-generated fields\n        if (/^_/.test(key)) {\n          continue\n        }\n\n        var field = document.getElementById('_key_' + key)\n        var value = currentData.properties[key]\n\n        if (field) {\n          // console.log(field)\n          // console.log(value)\n          field.value = value\n        } else { // put it into \"free tags\"\n          // get last child\n          var freetags = document.getElementById('freetags')\n          var lastRow = freetags.lastChild\n          while (lastRow.nodeType === 3) { // 3 = text-node\n            lastRow = lastRow.previousSibling\n          }\n\n          // set data on last child\n          var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling\n          keyNode.value = key\n          var valueNode = (lastRow.lastChild.nodeType === 1) ? lastRow.lastChild : lastRow.lastChild.previousSibling\n          valueNode.value = value\n\n          addFreeTagsRow()\n        }\n      }\n    }\n    if (currentData.geometry && currentData.geometry.coordinates) {\n      var lon = currentData.geometry.coordinates[0]\n      var lat = currentData.geometry.coordinates[1]\n      if (lat === undefined || lon === undefined) {\n        console.error('lat or lon empty')\n        return\n      }\n\n      document.getElementById('_geometry_lon').value = lon\n      document.getElementById('_geometry_lat').value = lat\n\n      map.my_current_marker = new L.marker([lat, lon], { icon: new map.my_placeMarker() })\n      map.my_editableLayers.addLayer(map.my_current_marker)\n\n      map.my_drawControl = map.getDrawControl(false)\n      map.addControl(map.my_drawControl)\n\n      map.panTo(new L.LatLng(lat, lon))\n    } else { // allow adding a marker\n      map.my_drawControl = map.getDrawControl(true)\n      map.addControl(map.my_drawControl)\n    }\n    if (currentData.properties && currentData.properties._id) {\n      document.getElementById('_id').value = currentData.properties._id\n      $('#transformapapilink').attr('href', endpoint + currentData.properties._id)\n    } else if (currentData._id) {\n      document.getElementById('_id').value = currentData._id\n      $('#transformapapilink').attr('href', endpoint + currentData._id)\n    }\n    if(currentData.properties.osm) {\n      $('#osmlink').attr('href', currentData.properties.osm)\n    }\n  }\n\n  if (place) {\n    redFetch(dataUrls, fillForm, function (e) {\n      console.error(e)\n      map.my_drawControl = map.getDrawControl(true)\n      map.addControl(map.my_drawControl)\n    })\n  } else {\n    map.my_drawControl = map.getDrawControl(true)\n    map.addControl(map.my_drawControl)\n  }\n\n  //add languageswitcher\n  var menu = document.getElementById('menu')\n  $('#menu').append(\n      '<div id=languageSelector onClick=\"$(\\'#languageSelector ul\\').toggleClass(\\'open\\');\">' +\n        '<span lang=en>Choose Language:</span>' +\n        '<ul></ul>' +\n      '</div>')\n\n  function initializeTranslatedTOIs(Q5data) {\n    translations.initializeLanguageSwitcher(Q5data)\n    \n    var nowPossibleLang = translations.selectAllowedLang(translations.current_lang)\n    translations.current_lang = nowPossibleLang\n    fetchAndSetNewTranslation(nowPossibleLang)\n  }\n\n  function fetchAndSetNewTranslation(lang) {\n    redFetch([ taxonomy.getLangTaxURL(lang, 'Q8'), 'https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy.' + lang + '.json' ],\n        fillTOIs,\n        function (error) { console.error('none of the taxonomy data urls available') },\n        { cacheBusting: false })\n    redFetch([ taxonomy.getLangTaxURL(lang, 'Q4'), 'https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy.' + lang + '.json' ],\n        fillTransforMapTax,\n        function (error) { console.error('none of the taxonomy data urls available') },\n        { cacheBusting: false })\n  }\n  translations.fetchAndSetNewTranslation = fetchAndSetNewTranslation\n\n  redFetch( [ \"https://base.transformap.co/wiki/Special:EntityData/Q5.json\", \"https://raw.githubusercontent.com/TransforMap/transformap-viewer/Q5-fallback.json\" ],\n    initializeTranslatedTOIs,\n    function(error) { console.error(\"none of the lang init data urls available\") } );\n\n\n  function createCORSRequest (method, url) {\n    // taken from https://www.html5rocks.com/en/tutorials/cors/\n    var xhr = new XMLHttpRequest()\n    if ('withCredentials' in xhr) {\n      // Check if the XMLHttpRequest object has a \"withCredentials\" property.\n      // \"withCredentials\" only exists on XMLHTTPRequest2 objects.\n      xhr.open(method, url, true)\n    } else if (typeof XDomainRequest !== 'undefined') {\n      // Otherwise, check if XDomainRequest.\n      // XDomainRequest only exists in IE, and is IE's way of making CORS requests.\n      xhr = new XDomainRequest()\n      xhr.open(method, url)\n    } else {\n      // Otherwise, CORS is not supported by the browser.\n      xhr = null\n    }\n    return xhr\n  }\n\n  function clickSubmit () {\n    console.log('clickSubmit enter')\n    const requiredFields = [ '_key_type_of_initiative', '_key_name', '_geometry_lat', '_geometry_lon' ]\n    for (var i = 0; i < requiredFields.length; i++) {\n      var id = requiredFields[i]\n      var value = document.getElementById(id).value\n      if (!value || !value.length) {\n        console.error('submit: field ' + id + ' empty')\n        alert('Error on submit: field ' + id.replace(/^_key_/, '') + ' is not allowed to be empty')\n        return false\n      }\n    }\n\n    var data = {\n      'type': 'Feature',\n      'properties': {\n      },\n      'geometry': {\n        'type': 'Point',\n        'coordinates': [\n          parseFloat(document.getElementById('_geometry_lon').value),\n          parseFloat(document.getElementById('_geometry_lat').value)\n        ]\n      }\n    }\n\n    // all 'input type=text'\n    var allInputs = document.getElementsByTagName('input')\n    var freeTags = { keys: {}, values: {} }\n\n    console.log(allInputs)\n\n    for (var i = 0; i < allInputs.length; i++) {\n      var element = allInputs[i]\n      if (!element.type === 'text') {\n        continue\n      }\n      if (element.value && element.id) {\n        console.log(element.id + ': ' + element.value)\n        if (/^_key_/.test(element.id)) {\n          var key = element.id.replace(/^_key_/, '')\n          data.properties[key] = element.value.trim()\n       // element of 'free tags'\n        } else if (/^key[0-9]+$/.test(element.id) && element.name === 'freetags') {\n          var nr = element.id.replace(/^key/, '')\n          freeTags.keys[nr] = element.value\n        } else if (/^value[0-9]+$/.test(element.id) && element.name === 'freetags') {\n          var nr = element.id.replace(/^value/, '')\n          freeTags.values[nr] = element.value\n        }\n      }\n    }\n    console.log(freeTags)\n\n    for (var keynr in freeTags.keys) {\n      var key = freeTags.keys[keynr].trim()\n      if (key && freeTags.values[keynr]) { // only take if key and value are not \"\"\n        data.properties[key] = freeTags.values[keynr].trim()\n      }\n    }\n\n    // drop-down\n    var allSelects = document.getElementsByTagName('select')\n    for (var i = 0; i < allSelects.length; i++) {\n      var element = allSelects[i]\n      if (/^_key_/.test(element.id) && element.value) {\n        var key = element.id.replace(/^_key_/, '')\n\n        for (var childCounter = 0; childCounter < element.children.length; childCounter++) {\n          var child = element.children[childCounter]\n          if (child.selected === true) {\n            data.properties[key] = (data.properties[key] ? (data.properties[key] + ';') : '') + child.value\n          }\n        }\n      }\n    }\n\n    // textarea\n    var allTextareas = document.getElementsByTagName('textarea')\n    for (var i = 0; i < allTextareas.length; i++) {\n      var element = allTextareas[i]\n      if (/^_key_/.test(element.id) && element.value) {\n        var key = element.id.replace(/^_key_/, '')\n        data.properties[key] = element.value.trim()\n      }\n    }\n\n    console.log(data)\n\n    const uuid = document.getElementById('_id').value\n    const sendData = JSON.stringify(data)\n    console.log(sendData)\n\n    // PUT is for UPDATE, POST is for CREATE\n    var xhr = createCORSRequest(uuid ? 'PUT' : 'POST', endpoint + uuid)\n    xhr.setRequestHeader('Content-Type', 'application/json')\n    xhr.send(sendData)\n    console.log(xhr)\n\n    xhr.onreadystatechange = function () {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          var retJson = JSON.parse(xhr.responseText)\n          console.log(retJson)\n          if(retJson.id) {\n            document.getElementById('_id').value = retJson.id\n            $('#transformapapilink').attr('href', endpoint + retJson.id)\n            $('#osmlink').attr('href', $('#_key_osm').attr('value') )\n            alert('Save successful')\n          } else {\n            alert('Error: something wrent wrong on saving: ' + JSON.stringify(retJson) )\n          }\n        } else {\n          console.error(xhr)\n        }\n      }\n    }\n    document.getElementById('deleted').style.display = 'none'\n  }\n  document.getElementById('save').onclick = clickSubmit\n\n  function clickDelete () {\n    const uuid = document.getElementById('_id').value\n    if (!uuid) {\n      alert('nothing to delete')\n      return\n    }\n    if(!confirm('Do you really want to delete this POI? It will be only marked as deleted and can be restored later if you save the current Browser URL.')) {\n      console.log('user aborted delete')\n      return\n    }\n    var xhr = createCORSRequest('DELETE', endpoint + uuid)\n    xhr.send()\n    console.log(xhr)\n\n    xhr.onreadystatechange = function () {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          var retJson = JSON.parse(xhr.responseText)\n          console.log(retJson)\n        } else {\n          console.error(xhr)\n        }\n      }\n    }\n    document.getElementById('deleted').style.display = 'block'\n  }\n  document.getElementById('delete').onclick = clickDelete\n  document.getElementById('plus').onclick = addFreeTagsRow\n\n  function clickSearch () {\n    const country = document.getElementById('_key_addr:country').value\n    const city = document.getElementById('_key_addr:city').value\n    // const postcode = document.getElementById('_key_addr:postcode').value // postcode not used in nominatim, decreases result quality\n    const street = document.getElementById('_key_addr:street').value\n    const housenumber = document.getElementById('_key_addr:housenumber').value\n\n    var querystring = 'q='\n    if (street) {\n      if (housenumber) {\n        querystring += housenumber + '+'\n      }\n      querystring += street + ','\n    }\n    if (city) {\n      querystring += city + ','\n    }\n    querystring += country\n\n    var query = '//nominatim.openstreetmap.org/search?' + querystring + '&format=json&limit=1&email=mapping@transformap.co'\n    console.log(query)\n\n    redFetch([ query ],\n        function (successData) {\n          console.log(successData)\n          if (successData.length !== 1) {\n            console.error('error in Nominatim return data: length != 1')\n            alert('Sorry, Nothing found')\n            return\n          }\n          var result = successData[0]\n          if (result.class === 'building' ||\n              result.class === 'amenity' ||\n              result.class === 'shop' ||\n              (result.class === 'place' && result.type === 'house')\n            ) {\n            console.log('address found exactly')\n            document.getElementById('_geometry_lon').value = result.lon\n            document.getElementById('_geometry_lat').value = result.lat\n\n            // trigger update of place marker\n            document.getElementById('_geometry_lat').focus()\n            document.getElementById('_geometry_lon').focus()\n            map.setView(new L.LatLng(result.lat, result.lon), 18)\n          } else {\n            map.setView(new L.LatLng(result.lat, result.lon), 18)\n            console.log('address not found exactly')\n            setTimeout(function () { // wait for map to pan to location\n              alert('Attention: The address was not found exactly, please place the marker manually!')\n              document.getElementById('_geometry_lon').value = ''\n              document.getElementById('_geometry_lat').value = ''\n              document.getElementById('_geometry_lon').focus()\n              document.getElementById('_geometry_lat').focus()\n            }, 400)\n          }\n        },\n        function (error) {\n          console.log(error)\n          alert('Sorry, Address search did not work')\n        }\n        )\n  }\n  document.getElementById('coordsearch').onclick = clickSearch\n\n function stopRKey(evt) {\n    var evt = (evt) ? evt : ((event) ? event : null)\n    var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null)\n    if ((evt.keyCode == 13) && (node.type == 'text')) {\n      return false\n    } \n  }\n  document.onkeypress = stopRKey\n\n  function updateLinkPosition() {\n    var centre = map.getCenter()\n    var targetlocation = '#' + map.getZoom() + '/' + centre.lat + '/' + centre.lng\n\n    var maplink = document.getElementById('gotomap')\n    var href = maplink.getAttribute ('href')\n    var splitstr = href.split('#')\n    href = maplink.getAttribute ('href').split('#')[0] + targetlocation\n    maplink.setAttribute('href',href);\n\n    var newlink = document.getElementById('newbutton')\n    newlink.setAttribute('href','./' + targetlocation)\n\n\n  }\n  map.on('moveend', updateLinkPosition);\n\n  console.log('editor initialize end')\n}\n","/*\n * This library provides a simple function to parse URL parameters\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n *\n * returns object with key:value pairs\n\n This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\nfunction getUrlVars () {\n  var vars = {}\n  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {\n    vars[key] = value.replace(/#.*$/, '')\n  })\n  return vars\n}\n\nmodule.exports = getUrlVars\n","const L = require('leaflet')\nconst L_Hash = require('leaflet-hash')\nconst L_Draw = require('leaflet-draw')\n\nvar editableLayers\nvar drawControl\nvar placeMarker\nvar popupText = 'Press the edit button to move me. <img style=\"width:30px;height:30px;background-position:-150px -1px;background-image:url(\\'images/spritesheet.svg\\');background-size: 270px 30px;\"> <br><br> Find it on the bottom left corner of the map.'\n\nfunction getDrawControl (allowNewMarker) {\n  var markerValue = allowNewMarker ? { icon: new placeMarker() } : false\n  var options = {\n    position: 'bottomleft',\n    draw: {\n      polyline: false,\n      polygon: false,\n      rectangle: false,\n      circle: false,\n      marker: markerValue\n    },\n    edit: {\n      featureGroup: editableLayers, // REQUIRED!!\n      remove: false\n    }\n  }\n  return new L.Control.Draw(options)\n}\n\nfunction initMap () {\n  console.log('initMap start')\n  var map\n\n  var attrOsm = 'Map data by <a href=\"https://openstreetmap.org\">OpenStreetMap</a> contributors, under <a href=\"https://www.openstreetmap.org/copyright\">ODbL</a>. '\n  var attrPois = 'POIs by <a href=\"http://solidariteconomy.eu\">SUSY</a>, <a href=\"https://creativecommons.org/publicdomain/zero/1.0/\">CC-0</a>. '\n  var leafletBgMaps\n  var zoom\n  var defaultlayer\n  var center\n  var baseMaps = {}\n\n  baseMaps['mapnik'] = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n    attribution: attrOsm + attrPois,\n    maxZoom: 19,\n    noWrap: true\n  })\n  baseMaps['stamen_terrain'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  })\n  baseMaps['stamen_terrain_bg'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  })\n  baseMaps['hot'] = new L.tileLayer('http://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png', {\n    attribution: 'Tiles courtesy of <a href=\"http://hot.openstreetmap.org/\">Humanitarian OpenStreetMap Team</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 20,\n    noWrap: true\n  })\n\n  if (!leafletBgMaps) {\n    leafletBgMaps = {\n      'Stamen - Terrain': baseMaps['stamen_terrain'],\n      'Stamen - Terrain Background': baseMaps['stamen_terrain_bg'],\n      'OpenStreetMap - Mapnik': baseMaps['mapnik'],\n      'Humanitarian OpenStreetMap ': baseMaps['hot']\n    }\n  }\n  if (!defaultlayer) {\n    defaultlayer = baseMaps['mapnik']\n  }\n\n  map = L.map('map', {\n    zoomControl: true,\n    center: center ? center : new L.LatLng(28.6, 9),\n    zoom: zoom ? zoom : 2,\n    layers: defaultlayer\n  })\n\n  const ctrl = new L.Control.Layers(leafletBgMaps)\n  map.addControl(ctrl)\n  var hash = new L.Hash(map) // Leaflet persistent Url Hash function\n\n  // leaflet draw\n  editableLayers = new L.FeatureGroup()\n  map.addLayer(editableLayers)\n  placeMarker = L.Icon.extend({\n    options: {\n      shadowUrl: null,\n      iconAnchor: new L.Point(12, 40),\n      iconSize: new L.Point(25, 40),\n      iconUrl: 'marker-green.png'\n    }\n  })\n\n  map.on(L.Draw.Event.CREATED, function (e) {\n    var type = e.layerType\n    var layer = e.layer\n\n    if (type === 'marker') {\n      layer.bindPopup(popupText)\n    }\n\n    editableLayers.addLayer(layer)\n    map.my_current_marker = layer\n    document.getElementById('_geometry_lon').value = layer._latlng.lng.toFixed(6)\n    document.getElementById('_geometry_lat').value = layer._latlng.lat.toFixed(6)\n\n    map.removeControl(map.my_drawControl)\n    map.my_drawControl = getDrawControl(false) // deactivate \"add marker\" after the 1st one\n    map.addControl(map.my_drawControl)\n      // fixme instantly enable 'edit' mode of layer\n  })\n\n  map.on('draw:editmove', function (e) {\n    console.log('editmove')\n    console.log(e)\n    document.getElementById('_geometry_lon').value = e.layer._latlng.lng.toFixed(6)\n    document.getElementById('_geometry_lat').value = e.layer._latlng.lat.toFixed(6)\n  })\n\n  map.my_editableLayers = editableLayers\n // map.my_drawControl = drawControl\n  map.my_placeMarker = placeMarker\n  map.getDrawControl = getDrawControl\n\n  map.updateMarkerFromForm = function () {\n    const lat = document.getElementById('_geometry_lat').value\n    const lon = document.getElementById('_geometry_lon').value\n    console.log('new lat: ' + lat + ' lon: ' + lon)\n\n    if (lat && lon) {\n      const coords = L.latLng(lat, lon)\n      if(map.my_current_marker) {\n        map.my_current_marker.setLatLng(coords)\n      } else {\n        map.my_current_marker = new L.marker([lat, lon], { icon: new map.my_placeMarker() })\n        map.my_current_marker.bindPopup(popupText)\n        map.my_editableLayers.addLayer(map.my_current_marker)\n        map.removeControl(map.my_drawControl)\n        map.my_drawControl = getDrawControl(false)\n        map.addControl(map.my_drawControl)\n      }\n         \n      map.panTo(coords)\n    }\n    else\n    {\n      //delete marker\n      console.log('no coords, remove marker')\n      map.my_current_marker.remove()\n      delete(map.my_current_marker)\n      map.removeControl(map.my_drawControl)\n      map.my_drawControl = getDrawControl(true) // allow \"add marker\" again\n      map.addControl(map.my_drawControl)\n    }\n  }\n  document.getElementById('_geometry_lat').onblur = map.updateMarkerFromForm\n  document.getElementById('_geometry_lon').onblur = map.updateMarkerFromForm\n\n  // console.log(map)\n\n  console.log('initMap end')\n  return map\n}\n\nmodule.exports = initMap\n","/*\n * This library provides a 'fetch', where you can use fallback URIs, to build on redundant servers.\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n *\n * Give it an array of resources, that can be fetched from different urls.\n * Will try to fetch them in the provided order.\n * Execute successFunction on the first successful fetch, and errorFunction only if all resources fail to fetch.\n */\n\n/* This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\n/* new version of getting map data with promises\n\n  taken from https://blog.hospodarets.com/fetch_in_action\n*/\n\nvar processStatus = function (response) {\n  // status '0' to handle local files fetching (e.g. Cordova/Phonegap etc.)\n  if (response.status === 200 || response.status === 0) {\n    return Promise.resolve(response)\n  } else {\n    return Promise.reject(new Error(response.statusText))\n  }\n}\n\nvar parseJson = function (response) {\n  return response.json()\n}\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\n// It goes against Promise concept to not have external access to .resolve/.reject methods, but provides more flexibility\nvar getWrappedPromise = function () {\n  var wrappedPromise = {}\n  var promise = new Promise(function (resolve, reject) {\n    wrappedPromise.resolve = resolve\n    wrappedPromise.reject = reject\n  })\n  wrappedPromise.then = promise.then.bind(promise)\n  wrappedPromise.catch = promise.catch.bind(promise)\n  wrappedPromise.promise = promise// e.g. if you want to provide somewhere only promise, without .resolve/.reject/.catch methods\n  return wrappedPromise\n}\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\nvar getWrappedFetch = function () {\n  var wrappedPromise = getWrappedPromise()\n  var args = Array.prototype.slice.call(arguments)// arguments to Array\n\n  window.fetch.apply(null, args)// calling original fetch() method\n        .then(function (response) {\n          wrappedPromise.resolve(response)\n        }, function (error) {\n          wrappedPromise.reject(error)\n        })\n        .catch(function (error) {\n          wrappedPromise.catch(error)\n        })\n  return wrappedPromise\n}\n\n/**\n * Fetch JSON by url\n * @param { {\n *  url: {String},\n *  [cacheBusting]: {Boolean}\n * } } params\n * @returns {Promise}\n*/var MAX_WAITING_TIME = 5000// in ms\n\nvar getJSON = function (params) {\n  var wrappedFetch = getWrappedFetch(\n        params.cacheBusting ? params.url + '?' + new Date().getTime() : params.url,\n    {\n      method: 'get', // optional, 'GET' is default value\n      headers: {\n        'Accept': 'application/json'\n      }\n    })\n\n  var timeoutId = setTimeout(function () {\n    wrappedFetch.reject(new Error('Load timeout for resource: ' + params.url))// reject on timeout\n  }, MAX_WAITING_TIME)\n\n  return wrappedFetch.promise// getting clear promise from wrapped\n        .then(function (response) {\n          clearTimeout(timeoutId)\n          return response\n        })\n        .then(processStatus)\n        .then(parseJson)\n}\n\nfunction myGetJSON (url, successFunction, errorFunction) {\n  var getJSONparams = { url: url, cacheBusting: true }\n\n  getJSON(getJSONparams).then(\n    function (data) { successFunction(data) },\n    function (error) { errorFunction(error) }\n  )\n}\n\nfunction redundantFetch (dataUrlArray, successFunction, errorFunction, params) {\n  if (!(!!dataUrlArray && Array === dataUrlArray.constructor)) {\n    console.error('redundantFetch: argument is no array')\n    console.error(dataUrlArray)\n    return false\n  }\n  var currentUrl = dataUrlArray[0]\n  if (typeof (currentUrl) !== 'string') {\n    console.error('redundantFetch: url is no string')\n    return false\n  }\n\n  console.log('redundantFetch called, urls:')\n  console.log(dataUrlArray)\n\n  dataUrlArray.shift()\n\n  var localErrorFunction\n  var localSuccessFunction\n  if (dataUrlArray.length == 0) { // last iteration\n    localSuccessFunction = successFunction\n    localErrorFunction = errorFunction\n  } else {\n    localSuccessFunction = successFunction\n    localErrorFunction = function (error) {\n      redundantFetch(dataUrlArray, successFunction, errorFunction, params)\n    }\n  }\n\n  var getJSONparams = { url: currentUrl, cacheBusting: ((params && params.cacheBusting === false) ? false : true) }\n  getJSON(getJSONparams).then(\n    function (data) { localSuccessFunction(data); console.log('rfetch: success on '); console.log(data) },\n    function (error) { localErrorFunction(error); console.log('rfetch: fail on '); console.log(error) }\n  )\n}\n\nmodule.exports = redundantFetch\n","/*\n * This library handles taxonomy related stuff for the transformap editor\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\n/* takes the language (string:\"iso\"), and the wished taxonomy (string: \"Qnn\") */\nfunction getLangTaxURL (lang, taxonomy) {\n\n  if (!lang) {\n    console.error('setFilterLang: no lang given')\n    return false\n  }\n\n  if(!taxonomy)\n    taxonomy = \"Q8\";\n\n  var tax_query =\n    'prefix bd: <http://www.bigdata.com/rdf#> ' +\n    'prefix wikibase: <http://wikiba.se/ontology#> ' +\n    'prefix wdt: <https://base.transformap.co/prop/direct/>' +\n    'prefix wd: <https://base.transformap.co/entity/>' +\n    'SELECT ?item ?itemLabel ?instance_of ?subclass_of ?type_of_initiative_tag ?interaction_tag ?needs_tag ?identity_tag ?wikipedia ?description ' +\n    'WHERE {' +\n      '?item wdt:P8* wd:'+taxonomy+' .' +\n      '?item wdt:P8 ?subclass_of .' +\n      'OPTIONAL { ?item wdt:P4 ?instance_of . }' +\n      'OPTIONAL { ?item wdt:P15 ?type_of_initiative_tag }' +\n      'OPTIONAL { ?item wdt:P16 ?interaction_tag }' +\n      'OPTIONAL { ?item wdt:P17 ?needs_tag }' +\n      'OPTIONAL { ?item wdt:P18 ?identity_tag }' +\n      'OPTIONAL { ?item schema:description ?description FILTER(LANG(?description) = \"' + lang + '\") }' +\n      'OPTIONAL { ?wikipedia schema:about ?item . ?wikipedia schema:inLanguage \"en\"}' +\n      'SERVICE wikibase:label {bd:serviceParam wikibase:language \"' + lang + '\" }' +\n    '}'\n\n  return 'https://query.base.transformap.co/bigdata/namespace/transformap/sparql?query=' + encodeURIComponent(tax_query) + '&format=json'\n}\n\nmodule.exports = {\n  getLangTaxURL: getLangTaxURL\n}\n","// mostly taken from https://github.com/TransforMap/transformap-viewer/blob/gh-pages/scripts/map.js\n\nfunction getLangs () {\n  var language = window.navigator.languages ? window.navigator.languages[0] : (window.navigator.language || window.navigator.userLanguage);\n\n  if(typeof language === 'string')\n      language = [ language ];\n\n  // we need to have the following languages:\n  // browserlang\n  // a short one (de instead of de-AT) if not present\n  // en as fallback if not present\n\n  for(var i = 0; i < language.length; i++) {\n      if(language[i].match(/-/)) {\n          var short_lang = language[i].match(/^([a-zA-Z]*)-/)[1];\n          if(language.indexOf(short_lang) == -1) {\n              language.push(short_lang);\n              continue;\n          }\n      }\n  }\n\n  if(language.indexOf(\"en\") == -1)\n      language.push(\"en\");\n\n  console.log(language);\n  return language;\n}\n\nfunction setFallbackLangs() {\n  fallback_langs = [];\n  if(current_lang != \"en\") {\n    for(var i=0; i < browser_languages.length; i++) {\n      var abbr = browser_languages[i];\n      if(current_lang != abbr)\n        fallback_langs.push(abbr);\n    }\n  }\n  console.log(\"new fallback langs: \" + fallback_langs.join(\",\") + \".\");\n}\n\nfunction resetLang() {\n  current_lang = \"en\";\n  for(var i=0; i < browser_languages.length; i++) {\n    var abbr = browser_languages[i];\n    if(abbr_langnames[abbr]) {\n      current_lang = abbr;\n      break;\n    }\n  }\n  switchToLang(current_lang);\n}\n\n/* get languages for UI from our Wikibase, and pick languages that are translated there */\n\nvar supported_languages = [],\n    langnames = [],\n    abbr_langnames = {},\n    langnames_abbr = {};\nfunction initializeLanguageSwitcher(returned_data){\n  var lang;\n  for(lang in returned_data.entities.Q5.labels) { //Q5 is arbitrary. Choose one that gets translated for sure.\n    supported_languages.push(lang);\n  }\n  var langstr = supported_languages.join(\"|\");\n  \n  var langstr_query =\n    'SELECT ?lang ?langLabel ?abbr ' +\n    'WHERE' +\n    '{' +\n      '?lang wdt:P218 ?abbr;' +\n      'FILTER regex (?abbr, \"^('+langstr+')$\").' +\n      'SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }' +\n    '}';\n  \n  langstr_query = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql?query=' +encodeURIComponent(langstr_query) + \"&format=json\";\n  $.getJSON(langstr_query, function (langstrings){\n    \n    langstrings.results.bindings.forEach(function (item) {\n      abbr_langnames[item.abbr.value] = item.langLabel.value;\n      langnames_abbr[item.langLabel.value] = item.abbr.value;\n      langnames.push(item.langLabel.value);\n    });\n    langnames.sort();\n    \n    resetLang();\n    setFallbackLangs();\n    \n    langnames.forEach(function (item) {\n      var langcode = langnames_abbr[item];\n      var is_default = (langcode == current_lang) ? \" class=default\" : \"\";\n      console.log(\"adding lang '\" + langcode + \"' (\" + item + \")\"); \n      $(\"#languageSelector ul\").append(\"<li targetlang=\" + langcode + is_default + \" onClick='window.translations.switchToLang(\\\"\"+langcode+\"\\\");'>\"+item+\"</li>\");\n    });\n  });\n}\n\nfunction switchToLang(lang) {\n  $(\"#languageSelector li.default\").removeClass(\"default\");\n  $(\"#languageSelector li[targetlang=\"+lang+\"]\").addClass(\"default\");\n  current_lang = lang;\n  window.translations.current_lang = lang;\n  window.translations.fetchAndSetNewTranslation(lang);\n  setFallbackLangs();\n/*\n  //updateTranslatedTexts();\n\n  if(! dictionary[lang]) {\n    var dict_uri = \"https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/json/\"+lang+\".json\";\n\n    $.ajax({\n      url: dict_uri,\n      context: { lang: current_lang },\n      success: function(returned_data) {\n        var trans_jsonobj = JSON.parse(returned_data);\n\n        if(! dictionary[this.lang])\n          dictionary[this.lang] = {};\n        for (item in trans_jsonobj) {\n          var index = reverse_dic[item];\n          dictionary[this.lang][index] = trans_jsonobj[item];\n        }\n\n        console.log(\"successfully fetched \" + this.lang);\n        //updateTranslatedTexts();\n\n      }\n    });\n\n  }\n\n  // As rebuilding the filters does not yet support advanced mode by default,\n  // we switch to simple mode, as language switching is a very rare case.\n  if(getFilterMode() == \"advanced\")\n    toggleAdvancedFilterMode();\n\n  resetFilter();\n  setFilterLang(lang);\n*/\n  console.log(\"new lang:\" +lang);\n}\n\n// if wishedLang is in supported, OK\n// shorten wishedLang and see if in supported\n// take fallback\nfunction selectAllowedLang(wishedLang) {\n  console.log(\"selectAllowedLang(\" + wishedLang + \") called\")\n  if(wishedLang) {\n    if(supported_languages.indexOf(wishedLang) != -1) {\n      current_lang = wishedLang\n      return current_lang\n    }\n    console.log(\"not in supported, try shorten\")\n    var matches = wishedLang.match(/^([a-zA-Z]*)-/)\n    if(matches && matches[1]) {\n      var short_lang = matches[1];\n      console.log(\"short: \" + short_lang)\n      if(short_lang) {\n        if(supported_languages.indexOf(short_lang) != -1) {\n          current_lang = short_lang\n          console.log(\"current_lang set to \" + short_lang)\n          return current_lang\n        }\n      }\n    }\n  }\n  setFallbackLangs()\n  if(fallback_langs[0]) {\n    if(supported_languages.indexOf(fallback_langs[0]) != -1) {\n      current_lang = fallback_langs[0]\n      return current_lang\n    }\n  }\n  current_lang = 'en'\n  return current_lang\n}\n\nvar browser_languages = getLangs(),\n    current_lang = browser_languages[0],\n    fallback_langs = [];\n\nmodule.exports = {\n  getLangs: getLangs,\n  initializeLanguageSwitcher: initializeLanguageSwitcher,\n  supported_languages: supported_languages,\n  browser_languages: browser_languages,\n  current_lang: current_lang,\n  switchToLang: switchToLang,\n  selectAllowedLang: selectAllowedLang\n}\n"]}