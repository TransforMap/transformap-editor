{"version":3,"sources":["app/fixtures/fixtures.js","app/fixtures/intercept_ajax.js","app/initialize.js","app/lib/auth_api.js","app/lib/data_api.js","app/lib/editor.js","app/lib/map.js","app/lib/mms_api.js","app/lib/red_fetch.js","app/lib/taxonomy.js","app/lib/translations.js","app/lib/ui.js","app/lib/user_api.js","app/lib/utils.js"],"names":["module","exports","listOfMediaFilesForPOI","mediaFileMetadataBasic","mediaFileMetadataComplete","mediaFileMetadataCompleteDeleted","placeMetadata","listOfMediaFileVersions","listOfMediaFileVersionsUpdate","user","fixtures","require","xhook","after","request","response","method","url","match","status","text","JSON","stringify","utils","setCookie","editor","document","addEventListener","console","log","Cookies","endpoint","baseUrl","getAuthEndpoint","checkAuth","profile","lastLoginState","getLoginState","lastUserId","getUserId","loginStateChangeEvent","setloginStateChangeEvent","func","resetCheckAuth","setLoginState","bool","id","set","expires","remove","checkLoginStateChanged","setTimeout","state","get","clearLoginState","checkIfAuth","yesCallback","noCallback","cookieLoginState","$","done","data","_id","fail","always","logout","authToken","callback","xhr","createCORSRequest","setRequestHeader","withCredentials","send","onreadystatechange","readyState","parse","responseText","error","getDataEndpoint","createOrUpdatePOI","uuid","retJson","alert","getPOI","deletePOI","redFetch","translations","dataApi","authApi","userApi","ui","map","window","taxonomyTranslationsUrls","$ENVSTATIC_MOCK_AJAX","place","getUrlVars","startLang","selectAllowedLang","current_lang","supported_languages","getElementById","onclick","addFreeTagsRow","fillForm","addLanguageSwitcher","fetchAndSetNewTranslation","initializeTranslatedTOIs","clickSubmit","clickDelete","clickSearch","clickNewMedia","toggleLoginButton","onkeypress","stopRKey","clickMediaCancel","clickMediaSave","initMap","L","L_Hash","L_Draw","editableLayers","drawControl","placeMarker","popupText","getDrawControl","allowNewMarker","markerValue","icon","options","position","draw","polyline","polygon","rectangle","circle","marker","edit","featureGroup","Control","Draw","getMap","attrOsm","attrPois","leafletBgMaps","zoom","defaultlayer","center","baseMaps","tileLayer","attribution","maxZoom","noWrap","zoomControl","LatLng","layers","ctrl","Layers","addControl","hash","Hash","FeatureGroup","addLayer","Icon","extend","shadowUrl","iconAnchor","Point","iconSize","iconUrl","on","Event","CREATED","e","type","layerType","layer","bindPopup","my_current_marker","value","_latlng","lng","toFixed","lat","removeControl","my_drawControl","centre","getCenter","targetlocation","getZoom","maplink","href","getAttribute","splitstr","split","setAttribute","newlink","my_editableLayers","my_placeMarker","updateMarkerFromForm","lon","coords","latLng","setLatLng","panTo","onblur","RequestBody","getMMSEndpoint","createNewMediaFile","blob","append","name","contentType","contents","getContentType","getData","retrieveMetadataForMediaFile","mediaId","updateMediaFile","content","retrieveMediaFileVersions","setActiveMediaFileVersion","versionId","processStatus","Promise","resolve","reject","Error","statusText","parseJson","json","getWrappedPromise","wrappedPromise","promise","then","bind","catch","getWrappedFetch","args","Array","prototype","slice","call","arguments","fetch","apply","MAX_WAITING_TIME","getJSON","params","wrappedFetch","cacheBusting","Date","getTime","headers","timeoutId","clearTimeout","myGetJSON","successFunction","errorFunction","getJSONparams","redundantFetch","dataUrlArray","constructor","currentUrl","shift","localErrorFunction","localSuccessFunction","length","getLangTaxURL","lang","taxonomy","tax_query","encodeURIComponent","getLangs","language","navigator","languages","userLanguage","i","short_lang","indexOf","push","setFallbackLangs","fallback_langs","browser_languages","abbr","join","resetLang","abbr_langnames","switchToLang","langnames","langnames_abbr","initializeLanguageSwitcher","returned_data","entities","Q5","labels","langstr","langstr_query","langstrings","results","bindings","forEach","item","langLabel","sort","langcode","is_default","fillTOIs","fillTransforMapTax","Q5data","nowPossibleLang","removeClass","addClass","wishedLang","matches","mmsApi","currentData","placeData","_deleted","style","display","properties","key","test","field","freetags","lastRow","lastChild","nodeType","previousSibling","keyNode","firstChild","nextSibling","valueNode","retrieveAndRenderMediaFilesForPOI","geometry","coordinates","undefined","mapInstance","attr","osm","html","media_files","mediaFileIds","mediaFileId","mediaFile","row","info","description","removeButton","metadata","evt","confirm","dataAPI","removeMediaFileFromPOI","editButton","resetCurrentBlob","find","val","show","handleFileSelect","versionsArray","versionsList","version","versionInput","version_date","author","active","activateLink","versionData","modal","imageUrl","mimetype","newNr","parseInt","newRow","createElement","divClass","createAttribute","setAttributeNode","newKey","bootstrapClass","newValue","keyId","valueId","elementName","cloneNode","appendChild","createToiArray","toiString","toiArray","trim","dataArray","itemLabel","needs","interactions","identities","entry","subclass_of","label","currentObject","needs_tag","interaction_tag","identity_tag","empty","newOption","provides","needs_array","need","selectpicker","interaction","interactions_array","interact","identity","identity_array","typeOfInintiatives","toiHashtable","toiSelect","type_of_initiative_tag","labelCompare","a","b","optionValue","type_of_initiative","tois","toi","newSelected","createTextNode","requiredFields","replace","parseFloat","allInputs","getElementsByTagName","freeTags","keys","values","element","nr","keynr","allSelects","childCounter","children","child","selected","allTextareas","sendData","clickSubmitSuccess","clickDeleteSuccess","country","city","street","housenumber","querystring","query","successData","result","class","focus","setView","event","node","target","srcElement","keyCode","poi","versionDate","toISOString","getCurrentBlob","metadataChanged","nameField","descriptionField","hide","removeAttr","getUserEndpoint","getUser","userId","updateUser","currentBlob","$ENVSTATIC_BASE_URL","XMLHttpRequest","open","XDomainRequest","vars","parts","location","m","getUrlPath","reg","exec","generateUUID","d","c","r","Math","random","floor","toString","files","reader","FileReader","onload","onerror","code","accept","binary","file","readAsDataURL","getCookie","cname","decodedCookie","decodeURIComponent","cookie","ca","charAt","substring","cvalue","exdays","setTime","toUTCString"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,OAAP,GAAiB;AACfC,0BAAwB,CACtB;AACE,UAAM,sCADR;AAEE,YAAQ,gDAFV;AAGE,WAAO,sDAHT;AAIE,gBAAY,YAJd;AAKE,YAAQ,6EALV;AAME,mBAAe,kBANjB;AAOE,oBAAgB;AAPlB,GADsB,EAUtB;AACE,UAAM,sCADR;AAEE,gBAAY,WAFd;AAGE,YAAQ,kBAHV;AAIE,WAAO,oDAJT;AAKE,oBAAgB;AALlB,GAVsB,CADT;AAmBfC,0BAAwB;AACtB,YAAQ,YADc;AAEtB,mBAAe,kBAFO;AAGtB,gBAAY,WAHU;AAItB,WAAO;AAJe,GAnBT;AAyBfC,6BAA2B;AACzB,UAAM,sCADmB;AAEzB,YAAQ,YAFiB;AAGzB,mBAAe,kBAHU;AAIzB,gBAAY,WAJa;AAKzB,WAAO,oDALkB;AAMzB,oBAAgB;AANS,GAzBZ;AAiCfC,oCAAkC;AAChC,UAAM,sCAD0B;AAEhC,YAAQ,YAFwB;AAGhC,eAAW,IAHqB;AAIhC,mBAAe,kBAJiB;AAKhC,gBAAY,WALoB;AAMhC,WAAO,oDANyB;AAOhC,oBAAgB;AAPgB,GAjCnB;AA0CfC,iBAAe;AACb,YAAO,SADM;AAEb,kBAAa;AACX,cAAO,qBADI;AAEX,sBAAe,IAFJ;AAGX,qBAAc,mBAHH;AAIX,0BAAmB,KAJR;AAKX,uBAAgB,MALL;AAMX,mBAAY,OAND;AAOX,kBAAW,WAPA;AAQX,iBAAU,iBARC;AASX,wBAAiB,8PATN;AAUX,iBAAU,uBAVC;AAWX,uBAAgB,wBAXL;AAYX,iBAAU,IAZC;AAaX,oBAAa,IAbF;AAcX,kBAAW,KAdA;AAeX,uBAAgB,sBAfL;AAgBX,wBAAiB,MAhBN;AAiBX,qBAAc,mOAjBH;AAkBX,4BAAqB,+BAlBV;AAmBX,uBAAgB,gBAnBL;AAoBX,yBAAkB,WApBP;AAqBX,qBAAe,CACb,sCADa;AArBJ,KAFA;AA2Bb,gBAAW;AACT,cAAO,OADE;AAET,qBAAc,CAAC,cAAD,EAAgB,cAAhB;AAFL,KA3BE;AA+Bb,WAAM;AA/BO,GA1CA;AA2EfC,2BAAyB,CACvB;AACE,UAAM,sCADR;AAEE,YAAQ,gCAFV;AAGE,oBAAgB,2BAHlB;AAIE,gBAAY,WAJd;AAKE,cAAU,IALZ;AAME,WAAO,oDANT;AAOE,cAAU;AAPZ,GADuB,EAUvB;AACE,UAAM,sCADR;AAEE,YAAQ,qBAFV;AAGE,oBAAgB,2BAHlB;AAIE,gBAAY,WAJd;AAKE,WAAO,oDALT;AAME,cAAU;AANZ,GAVuB,CA3EV;AA8FfC,iCAA+B,CAC7B;AACE,YAAQ,gCADV;AAEE,mBAAe,qCAFjB;AAGE,oBAAgB,2BAHlB;AAIE,gBAAY,WAJd;AAKE,WAAO;AALT,GAD6B,EAQ7B;AACE,UAAM,sCADR;AAEE,YAAQ,qCAFV;AAGE,oBAAgB,2BAHlB;AAIE,gBAAY,WAJd;AAKE,WAAO;AALT,GAR6B,EAe7B;AACE,UAAM,sCADR;AAEE,YAAQ,8BAFV;AAGE,oBAAgB,2BAHlB;AAIE,gBAAY,WAJd;AAKE,WAAO;AALT,GAf6B,CA9FhB;AAqHfC,QAAM;AACJ,YAAQ,KADJ;AAEJ,aAAS;AAFL;AArHS,CAAjB;;;;;;ACAA,IAAIC,WAAWC,QAAQ,eAAR,CAAf;;AAEAC,MAAMC,KAAN,CAAY,UAASC,OAAT,EAAkBC,QAAlB,EAA4B;;AAEtC,MAAID,QAAQE,MAAR,KAAmB,KAAvB,EAA6B;;AAE3B;AACA,QAAGF,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASJ,aAAxB,CAAhB;AACD;;AAED;AACA,QAAGQ,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,sBAAlB,CAAH,EAA6C;AAC3CH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASR,sBAAxB,CAAhB;AACD;;AAED;AACA,QAAGY,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASN,yBAAxB,CAAhB;AACD;;AAED;AACA,QAAGU,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,yBAAlB,CAAH,EAAgD;AAC9CH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASH,uBAAxB,CAAhB;AACD;;AAED;AACA,QAAGO,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,WAAlB,CAAH,EAAkC;AAChCH,eAASI,MAAT,GAAkB,GAAlB;AACAI,YAAMC,SAAN,CAAgB,aAAhB,EAA8B,WAA9B;AACD;;AAED;AACA,QAAGV,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASD,IAAxB,CAAhB;AACD;AAEF,GAtCD,MAsCM,IAAIK,QAAQE,MAAR,KAAmB,MAAvB,EAA8B;;AAElC;AACA,QAAGF,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,YAAlB,CAAH,EAAmC;AACjCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASN,yBAAxB,CAAhB;AACD;;AAED;AACA,QAAGU,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,yBAAlB,CAAH,EAAgD;AAC9CH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASF,6BAAxB,CAAhB;AACD;;AAED;AACA,QAAGM,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,YAAlB,CAAH,EAAmC;AACjC;AACD;AAEF,GAnBK,MAmBA,IAAIJ,QAAQE,MAAR,KAAmB,KAAvB,EAA6B;;AAEjC;AACA,QAAGF,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASN,yBAAxB,CAAhB;AACD;;AAED;AACA,QAAGU,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACA;AACD;;AAED;AACA,QAAGL,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASD,IAAxB,CAAhB;AACD;AAEF,GApBK,MAoBA,IAAIK,QAAQE,MAAR,KAAmB,QAAvB,EAAgC;;AAEpC;AACA,QAAGF,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,gBAAlB,CAAH,EAAuC;AACrCH,eAASI,MAAT,GAAkB,GAAlB;AACA;AACD;;AAED;AACA,QAAGL,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,2BAAlB,CAAH,EAAkD;AAChDH,eAASI,MAAT,GAAkB,GAAlB;AACAJ,eAASK,IAAT,GAAgBC,KAAKC,SAAL,CAAeZ,SAASJ,aAAxB,CAAhB;AACD;;AAED;AACA,QAAGQ,QAAQG,GAAR,CAAYC,KAAZ,CAAkB,eAAlB,CAAH,EAAsC;AACpCH,eAASI,MAAT,GAAkB,GAAlB;AACD;AACF;AAEF,CAnGD;;;;;;ACFA,IAAMM,SAASd,QAAQ,YAAR,CAAf;;AAEAe,SAASC,gBAAT,CAA0B,kBAA1B,EAA8C,YAAM;AAClD;AACAF;AACAG,UAAQC,GAAR,CAAY,iBAAZ;AACD,CAJD;;;;;;ACUA;;IAAYC,O;;;;AAEZ,IAAMP,QAAQZ,QAAQ,YAAR,CAAd,C,CAdA;;;;;;;;;;;;AAgBA,IAAMoB,WAAWR,MAAMS,OAAN,GAAgB,QAAjC;;AAEA;AACA,SAASC,eAAT,GAA4B;AAC1B,SAAOF,QAAP;AACD;;AAED;;AAEA,IAAIG,YAAY,KAAhB;AACA,IAAIC,UAAU,IAAd;AACA,IAAIC,iBAAiBC,eAArB;AACA,IAAIC,aAAaC,WAAjB;AACA,IAAIC,wBAAwB,IAA5B;;AAEA,SAASC,wBAAT,CAAmCC,IAAnC,EAAyC;AACvCF,0BAAwBE,IAAxB;AACD;;AAED,SAASC,cAAT,GAA2B;AACzBT,cAAY,KAAZ;AACD;;AAED,SAASU,aAAT,CAAwBC,IAAxB,EAA8BC,EAA9B,EAAkC;AAChChB,UAAQiB,GAAR,CAAY,YAAZ,EAA0BF,IAA1B,EAAgC;AAC9BG,aAAS;AADqB,GAAhC;AAGA,MAAIF,EAAJ,EAAQ;AACNhB,YAAQiB,GAAR,CAAY,QAAZ,EAAsBD,EAAtB,EAA0B;AACxBE,eAAS;AADe,KAA1B;AAGD,GAJD,MAIO;AACLlB,YAAQmB,MAAR,CAAe,QAAf;AACD;AACDb,mBAAiBS,IAAjB;AACAP,eAAaQ,EAAb;AACAI;AACD;;AAED,SAASA,sBAAT,GAAmC;AACjC,MAAIb,oBAAoBD,cAApB,IAAsCG,gBAAgBD,UAA1D,EAAsE;AACpE,QAAIE,qBAAJ,EAA2BW,WAAWX,qBAAX,EAAkC,GAAlC;AAC3B,WAAO,IAAP;AACD,GAHD,MAGO;AACL,WAAO,KAAP;AACD;AACF;;AAED,SAASH,aAAT,GAA0B;AACxB,MAAMe,QAAQtB,QAAQuB,GAAR,CAAY,YAAZ,CAAd;AACA,SAAOD,UAAU,MAAV,IAAoBA,UAAU,IAArC;AACD;;AAED,SAASb,SAAT,GAAsB;AACpB,SAAOT,QAAQuB,GAAR,CAAY,QAAZ,CAAP;AACD;;AAED,SAASC,eAAT,GAA4B;AAC1BxB,UAAQmB,MAAR,CAAe,YAAf;AACD;;AAED,SAASM,WAAT,CAAsBC,WAAtB,EAAmCC,UAAnC,EAA+C;AAC7C,MAAMC,mBAAmBrB,eAAzB;AACA,MAAIa,wBAAJ,EAA8BhB,YAAY,KAAZ;AAC9B,MAAI,CAACA,SAAD,IAAc,OAAOwB,gBAAP,KAA4B,WAA9C,EAA2D;AACzDC,MAAEN,GAAF,CAAS9B,MAAMS,OAAf,YACS4B,IADT,CACc,gBAAQ;AACZ,UAAIC,QAAQA,KAAKC,GAAL,KAAa,IAAzB,EAA+B;AAC7B3B,kBAAU0B,IAAV;AACAL,oBAAYrB,OAAZ;AACAS,sBAAc,IAAd,EAAoBiB,KAAKC,GAAzB;AACD,OAJD,MAIO;AACLL;AACAb,sBAAc,KAAd;AACD;AACF,KAVT,EAWSmB,IAXT,CAWc,YAAM;AACVN;AACD,KAbT,EAcSO,MAdT,CAcgB,YAAM;AACZ9B,kBAAY,IAAZ;AACD,KAhBT;AAiBD,GAlBD,MAkBO,IAAIwB,gBAAJ,EAAsB;AAC3BF,gBAAYrB,OAAZ;AACD,GAFM,MAEA;AACLsB;AACD;AACF;;AAED;;;;;;AAMA,SAASQ,MAAT,CAAiBC,SAAjB,EAA2BC,QAA3B,EAAqC;AACnC,MAAI,CAACD,SAAL,EAAe;AACbtC,YAAQC,GAAR,CAAY,4BAAZ;AACA,WAAO,KAAP;AACD;;AAED,MAAIuC,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+BtC,QAA/B,CAAV;AACAqC,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAEDpE,OAAOC,OAAP,GAAiB;AACfsD,eAAaA,WADE;AAEfD,mBAAiBA,eAFF;AAGff,aAAWA,SAHI;AAIfF,iBAAeA,aAJA;AAKfa,0BAAwBA,sBALT;AAMfN,iBAAeA,aANA;AAOfD,kBAAgBA,cAPD;AAQfF,4BAA0BA,wBARX;AASfR,mBAAiBA,eATF;AAUfgC,UAAQA;AAVO,CAAjB;;;;;;ACrIA;;;;;;;;;;;;AAYA,IAAM1C,QAAQZ,QAAQ,YAAR,CAAd;;AAEA,IAAMoB,WAAWR,MAAMS,OAAN,GAAgB,SAAjC;;AAEA;AACA,SAAS8C,eAAT,GAA4B;AAC1B,SAAO/C,QAAP;AACD;;AAED;;;;;;;;AAQA,SAASgD,iBAAT,CAA4BC,IAA5B,EAAkCnB,IAAlC,EAAwCM,QAAxC,EAAkD;AAChD,MAAI,CAACN,IAAL,EAAW;AACTjC,YAAQiD,KAAR,CAAc,kCAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwBW,OAAO,KAAP,GAAe,MAAvC,EAA+CjD,WAAWiD,IAA1D,CAAV;AACAZ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ,CAASX,IAAT;;AAEAO,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtB,YAAI8D,UAAU5D,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAd;AACAhD,gBAAQC,GAAR,CAAYoD,OAAZ;AACA,YAAIA,QAAQnC,EAAZ,EAAgB;AACdqB,mBAASc,QAAQnC,EAAjB;AACAoC,gBAAM,iBAAN;AACD,SAHD,MAGO;AACLA,gBAAM,6CAA6C7D,KAAKC,SAAL,CAAe2D,OAAf,CAAnD;AACD;AACF,OATD,MASO;AACLrD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GAfD;AAgBD;;AAED;;;;;;;;AAQA,SAASe,MAAT,CAAiBH,IAAjB,EAAuBb,QAAvB,EAAiC;AAC/B,MAAI,CAACa,IAAL,EAAW;AACTpD,YAAQiD,KAAR,CAAc,uBAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+BS,oBAAoBE,IAAnD,CAAV;AACAZ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAGD;;;;;;;AAOA,SAASgB,SAAT,CAAoBJ,IAApB,EAA0Bb,QAA1B,EAAoC;AAClC,MAAI,CAACa,IAAL,EAAW;AACTpD,YAAQiD,KAAR,CAAc,0BAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwB,QAAxB,EAAkCtC,WAAWiD,IAA7C,CAAV;AACAZ,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAASa,IAAT;AACD,OAFD,MAEO;AACLpD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAEDpE,OAAOC,OAAP,GAAiB;AACf6E,mBAAiBA,eADF;AAEfC,qBAAmBA,iBAFJ;AAGfI,UAAQA,MAHO;AAIfC,aAAWA;AAJI,CAAjB;;;;;;ACpHA,qD,CAAsD;;AAEtD,IAAM7D,QAAQZ,QAAQ,YAAR,CAAd;AACA,IAAM0E,WAAW1E,QAAQ,gBAAR,CAAjB;AACA,IAAM2E,eAAe3E,QAAQ,mBAAR,CAArB;AACA,IAAM4E,UAAU5E,QAAQ,eAAR,CAAhB;AACA,IAAM6E,UAAU7E,QAAQ,eAAR,CAAhB;AACA,IAAM8E,UAAU9E,QAAQ,eAAR,CAAhB;AACA,IAAM+E,KAAK/E,QAAQ,SAAR,CAAX;AACA,IAAMgF,MAAMhF,QAAQ,UAAR,CAAZ;;AAEAiF,OAAON,YAAP,GAAsBA,YAAtB;AACA,IAAMO,2BAA2B,CAAE,6DAAF,EAAiE,mFAAjE,CAAjC;;AAEA,IAAIC,yBAAyB,MAA7B,EAAoC;AAClClE,UAAQC,GAAR,CAAY,0CAAZ;AACAlB,UAAQ,OAAR;AACAA,UAAQ,+BAAR;AACD;;AAEDX,OAAOC,OAAP,GAAiB,YAAY;AAC3B2B,UAAQC,GAAR,CAAY,yBAAZ;;AAEA,MAAMkE,QAAQxE,MAAMyE,UAAN,GAAmB,OAAnB,CAAd;;AAEA,MAAIC,YAAYX,aAAaY,iBAAb,CAA+BZ,aAAaa,YAA5C,CAAhB;AACAvE,UAAQC,GAAR,CAAY,oBAAoBoE,SAAhC;AACArE,UAAQC,GAAR,CAAYyD,aAAac,mBAAzB;;AAEA1E,WAAS2E,cAAT,CAAwB,MAAxB,EAAgCC,OAAhC,GAA0CZ,GAAGa,cAA7C;;AAEA,MAAIR,KAAJ,EAAW;AACTR,YAAQJ,MAAR,CAAeY,KAAf,EAAqBL,GAAGc,QAAxB;AACD;;AAEDd,KAAGe,mBAAH;AACAnB,eAAaoB,yBAAb,GAAyCpB,aAAaoB,yBAAtD;;AAEArB,WAASQ,wBAAT,EACEP,aAAaqB,wBADf,EAEE,UAAU9B,KAAV,EAAiB;AACfjD,YAAQiD,KAAR,CAAc,2CAAd;AACD,GAJH;;AAMAnD,WAAS2E,cAAT,CAAwB,MAAxB,EAAgCC,OAAhC,GAA0CZ,GAAGkB,WAA7C;AACAlF,WAAS2E,cAAT,CAAwB,QAAxB,EAAkCC,OAAlC,GAA4CZ,GAAGmB,WAA/C;AACAnF,WAAS2E,cAAT,CAAwB,aAAxB,EAAuCC,OAAvC,GAAiDZ,GAAGoB,WAApD;AACApF,WAAS2E,cAAT,CAAwB,UAAxB,EAAoCC,OAApC,GAA8CZ,GAAGqB,aAAjD;AACArF,WAAS2E,cAAT,CAAwB,aAAxB,EAAuCC,OAAvC,GAAiDZ,GAAGsB,iBAApD;AACAtF,WAASuF,UAAT,GAAsBvB,GAAGwB,QAAzB;AACAxF,WAAS2E,cAAT,CAAwB,aAAxB,EAAuCC,OAAvC,GAAiDZ,GAAGyB,gBAApD;AACAzF,WAAS2E,cAAT,CAAwB,WAAxB,EAAqCC,OAArC,GAA+CZ,GAAG0B,cAAlD;;AAEA1B,KAAGsB,iBAAH;;AAEArB,MAAI0B,OAAJ;;AAEAzF,UAAQC,GAAR,CAAY,uBAAZ;AAED,CAvCD;;;;;;ACpBA,IAAMyF,IAAI3G,QAAQ,SAAR,CAAV;AACA,IAAM4G,SAAS5G,QAAQ,cAAR,CAAf;AACA,IAAM6G,SAAS7G,QAAQ,cAAR,CAAf;;AAEA,IAAIgF,GAAJ;;AAEA,IAAI8B,cAAJ;AACA,IAAIC,WAAJ;AACA,IAAIC,WAAJ;AACA,IAAIC,YAAY,6OAAhB;AACA,SAASC,cAAT,CAAyBC,cAAzB,EAAyC;AACvC,MAAIC,cAAcD,iBAAiB,EAAEE,MAAM,IAAIL,WAAJ,EAAR,EAAjB,GAA+C,KAAjE;AACA,MAAIM,UAAU;AACZC,cAAU,YADE;AAEZC,UAAM;AACJC,gBAAU,KADN;AAEJC,eAAS,KAFL;AAGJC,iBAAW,KAHP;AAIJC,cAAQ,KAJJ;AAKJC,cAAQT;AALJ,KAFM;AASZU,UAAM;AACJC,oBAAcjB,cADV,EAC0B;AAC9BxE,cAAQ;AAFJ;AATM,GAAd;AAcA,SAAO,IAAIqE,EAAEqB,OAAF,CAAUC,IAAd,CAAmBX,OAAnB,CAAP;AACD;;AAED,SAASY,MAAT,GAAmB;AACjB,SAAOlD,GAAP;AACD;;AAED,SAAS0B,OAAT,GAAoB;AAClBzF,UAAQC,GAAR,CAAY,eAAZ;;AAEA,MAAIiH,UAAU,oJAAd;AACA,MAAIC,WAAW,gIAAf;AACA,MAAIC,aAAJ;AACA,MAAIC,IAAJ;AACA,MAAIC,YAAJ;AACA,MAAIC,MAAJ;AACA,MAAIC,WAAW,EAAf;;AAEAA,WAAS,QAAT,IAAqB,IAAI9B,EAAE+B,SAAN,CAAgB,oDAAhB,EAAsE;AACzFC,iBAAaR,UAAUC,QADkE;AAEzFQ,aAAS,EAFgF;AAGzFC,YAAQ;AAHiF,GAAtE,CAArB;AAKAJ,WAAS,gBAAT,IAA6B,IAAI9B,EAAE+B,SAAN,CAAgB,mEAAhB,EAAqF;AAChHC,iBAAa,kEACT,6EADS,GAETR,OAFS,GAECC,QAHkG;AAIhHQ,aAAS,EAJuG;AAKhHC,YAAQ;AALwG,GAArF,CAA7B;AAOAJ,WAAS,mBAAT,IAAgC,IAAI9B,EAAE+B,SAAN,CAAgB,8EAAhB,EAAgG;AAC9HC,iBAAa,kEACT,6EADS,GAETR,OAFS,GAECC,QAHgH;AAI9HQ,aAAS,EAJqH;AAK9HC,YAAQ;AALsH,GAAhG,CAAhC;AAOAJ,WAAS,KAAT,IAAkB,IAAI9B,EAAE+B,SAAN,CAAgB,sDAAhB,EAAwE;AACxFC,iBAAa,oGACTR,OADS,GACCC,QAF0E;AAGxFQ,aAAS,EAH+E;AAIxFC,YAAQ;AAJgF,GAAxE,CAAlB;;AAOA,MAAI,CAACR,aAAL,EAAoB;AAClBA,oBAAgB;AACd,0BAAoBI,SAAS,gBAAT,CADN;AAEd,qCAA+BA,SAAS,mBAAT,CAFjB;AAGd,gCAA0BA,SAAS,QAAT,CAHZ;AAId,qCAA+BA,SAAS,KAAT;AAJjB,KAAhB;AAMD;AACD,MAAI,CAACF,YAAL,EAAmB;AACjBA,mBAAeE,SAAS,QAAT,CAAf;AACD;;AAEDzD,QAAM2B,EAAE3B,GAAF,CAAM,KAAN,EAAa;AACjB8D,iBAAa,IADI;AAEjBN,YAAQA,UAAU,IAAI7B,EAAEoC,MAAN,CAAa,IAAb,EAAmB,CAAnB,CAFD;AAGjBT,UAAMA,QAAQ,CAHG;AAIjBU,YAAQT;AAJS,GAAb,CAAN;;AAOA,MAAMU,OAAO,IAAItC,EAAEqB,OAAF,CAAUkB,MAAd,CAAqBb,aAArB,CAAb;AACArD,MAAImE,UAAJ,CAAeF,IAAf;AACA,MAAIG,OAAO,IAAIzC,EAAE0C,IAAN,CAAWrE,GAAX,CAAX,CA1DkB,CA0DU;;AAE5B;AACA8B,mBAAiB,IAAIH,EAAE2C,YAAN,EAAjB;AACAtE,MAAIuE,QAAJ,CAAazC,cAAb;AACAE,gBAAcL,EAAE6C,IAAF,CAAOC,MAAP,CAAc;AAC1BnC,aAAS;AACPoC,iBAAW,IADJ;AAEPC,kBAAY,IAAIhD,EAAEiD,KAAN,CAAY,EAAZ,EAAgB,EAAhB,CAFL;AAGPC,gBAAU,IAAIlD,EAAEiD,KAAN,CAAY,EAAZ,EAAgB,EAAhB,CAHH;AAIPE,eAAS;AAJF;AADiB,GAAd,CAAd;;AASA9E,MAAI+E,EAAJ,CAAOpD,EAAEsB,IAAF,CAAO+B,KAAP,CAAaC,OAApB,EAA6B,UAAUC,CAAV,EAAa;AACxC,QAAIC,OAAOD,EAAEE,SAAb;AACA,QAAIC,QAAQH,EAAEG,KAAd;;AAEA,QAAIF,SAAS,QAAb,EAAuB;AACrBE,YAAMC,SAAN,CAAgBrD,SAAhB;AACD;;AAEDH,mBAAeyC,QAAf,CAAwBc,KAAxB;AACArF,QAAIuF,iBAAJ,GAAwBF,KAAxB;AACAtJ,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDH,MAAMI,OAAN,CAAcC,GAAd,CAAkBC,OAAlB,CAA0B,CAA1B,CAAjD;AACA5J,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDH,MAAMI,OAAN,CAAcG,GAAd,CAAkBD,OAAlB,CAA0B,CAA1B,CAAjD;;AAEA3F,QAAI6F,aAAJ,CAAkB7F,IAAI8F,cAAtB;AACA9F,QAAI8F,cAAJ,GAAqB5D,eAAe,KAAf,CAArB,CAdwC,CAcI;AAC5ClC,QAAImE,UAAJ,CAAenE,IAAI8F,cAAnB;AACE;AACH,GAjBD;;AAmBA9F,MAAI+E,EAAJ,CAAO,eAAP,EAAwB,UAAUG,CAAV,EAAa;AACnCjJ,YAAQC,GAAR,CAAY,UAAZ;AACAD,YAAQC,GAAR,CAAYgJ,CAAZ;AACAnJ,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDN,EAAEG,KAAF,CAAQI,OAAR,CAAgBC,GAAhB,CAAoBC,OAApB,CAA4B,CAA5B,CAAjD;AACA5J,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDN,EAAEG,KAAF,CAAQI,OAAR,CAAgBG,GAAhB,CAAoBD,OAApB,CAA4B,CAA5B,CAAjD;AACD,GALD;;AAOA3F,MAAI+E,EAAJ,CAAO,SAAP,EAAkB,UAASG,CAAT,EAAW;AAC3B,QAAIa,SAAS/F,IAAIgG,SAAJ,EAAb;AACA,QAAIC,iBAAiB,MAAMjG,IAAIkG,OAAJ,EAAN,GAAsB,GAAtB,GAA4BH,OAAOH,GAAnC,GAAyC,GAAzC,GAA+CG,OAAOL,GAA3E;;AAEA,QAAIS,UAAUpK,SAAS2E,cAAT,CAAwB,SAAxB,CAAd;AACA,QAAI0F,OAAOD,QAAQE,YAAR,CAAqB,MAArB,CAAX;AACA,QAAIC,WAAWF,KAAKG,KAAL,CAAW,GAAX,CAAf;AACAH,WAAOD,QAAQE,YAAR,CAAqB,MAArB,EAA6BE,KAA7B,CAAmC,GAAnC,EAAwC,CAAxC,IAA6CN,cAApD;AACAE,YAAQK,YAAR,CAAqB,MAArB,EAA6BJ,IAA7B;;AAEA,QAAIK,UAAU1K,SAAS2E,cAAT,CAAwB,WAAxB,CAAd;AACA+F,YAAQD,YAAR,CAAqB,MAArB,EAA6B,OAAOP,cAApC;AACD,GAZD;;AAcAjG,MAAI0G,iBAAJ,GAAwB5E,cAAxB;AACD;AACC9B,MAAI2G,cAAJ,GAAqB3E,WAArB;AACAhC,MAAIkC,cAAJ,GAAqBA,cAArB;;AAEAlC,MAAI4G,oBAAJ,GAA2B,YAAY;AACrC,QAAMhB,MAAM7J,SAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAArD;AACA,QAAMqB,MAAM9K,SAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAArD;AACAvJ,YAAQC,GAAR,CAAY,cAAc0J,GAAd,GAAoB,QAApB,GAA+BiB,GAA3C;;AAEA,QAAIjB,OAAOiB,GAAX,EAAgB;AACd,UAAMC,SAASnF,EAAEoF,MAAF,CAASnB,GAAT,EAAciB,GAAd,CAAf;AACA,UAAI7G,IAAIuF,iBAAR,EAA2B;AACzBvF,YAAIuF,iBAAJ,CAAsByB,SAAtB,CAAgCF,MAAhC;AACD,OAFD,MAEO;AACL9G,YAAIuF,iBAAJ,GAAwB,IAAI5D,EAAEkB,MAAN,CAAa,CAAC+C,GAAD,EAAMiB,GAAN,CAAb,EAAyB,EAAExE,MAAM,IAAIrC,IAAI2G,cAAR,EAAR,EAAzB,CAAxB;AACA3G,YAAIuF,iBAAJ,CAAsBD,SAAtB,CAAgCrD,SAAhC;AACAjC,YAAI0G,iBAAJ,CAAsBnC,QAAtB,CAA+BvE,IAAIuF,iBAAnC;AACAvF,YAAI6F,aAAJ,CAAkB7F,IAAI8F,cAAtB;AACA9F,YAAI8F,cAAJ,GAAqB5D,eAAe,KAAf,CAArB;AACAlC,YAAImE,UAAJ,CAAenE,IAAI8F,cAAnB;AACD;;AAED9F,UAAIiH,KAAJ,CAAUH,MAAV;AACD,KAdD,MAcO;AACL;AACA7K,cAAQC,GAAR,CAAY,0BAAZ;AACA8D,UAAIuF,iBAAJ,CAAsBjI,MAAtB;AACA,aAAQ0C,IAAIuF,iBAAZ;AACAvF,UAAI6F,aAAJ,CAAkB7F,IAAI8F,cAAtB;AACA9F,UAAI8F,cAAJ,GAAqB5D,eAAe,IAAf,CAArB,CANK,CAMsC;AAC3ClC,UAAImE,UAAJ,CAAenE,IAAI8F,cAAnB;AACD;AACF,GA5BD;AA6BA/J,WAAS2E,cAAT,CAAwB,eAAxB,EAAyCwG,MAAzC,GAAkDlH,IAAI4G,oBAAtD;AACA7K,WAAS2E,cAAT,CAAwB,eAAxB,EAAyCwG,MAAzC,GAAkDlH,IAAI4G,oBAAtD;;AAEA;;AAEA3K,UAAQC,GAAR,CAAY,aAAZ;AACA,SAAO8D,GAAP;AACD;;AAED3F,OAAOC,OAAP,GAAiB;AACf4I,UAAQA,MADO;AAEfxB,WAASA;AAFM,CAAjB;;;;;;AC5LA;;;;;;;;;;;;AAYA,IAAM9F,QAAQZ,QAAQ,YAAR,CAAd;AACA,IAAMmM,cAAcnM,QAAQ,WAAR,EAAqBmM,WAAzC;AACA,IAAM/K,WAAWR,MAAMS,OAAN,GAAgB,SAAjC;;AAEA;AACA,SAAS+K,cAAT,GAA2B;AACzB,SAAOhL,QAAP;AACD;;AAED;;;;;;;;AAQA,SAASiL,kBAAT,CAA6BnJ,IAA7B,EAAmCoJ,IAAnC,EAAyC9I,QAAzC,EAAmD;;AAEjD,MAAI,CAACN,IAAL,EAAW;AACTjC,YAAQiD,KAAR,CAAc,mCAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAI,CAACoI,IAAL,EAAW;AACTrL,YAAQiD,KAAR,CAAc,mCAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAI/D,UAAU,IAAIgM,WAAJ,EAAd;;AAEA,MAAIjJ,IAAJ,EAAS;AACP/C,YAAQoM,MAAR,CAAerJ,IAAf;AACD;;AAED,MAAIoJ,IAAJ,EAAS;AACPnM,YAAQoM,MAAR,CAAeD,KAAKE,IAApB,EAA0B;AACxBC,mBAAcH,KAAKnC,IADK;AAExBjH,YAAOoJ,KAAKI;AAFY,KAA1B;AAID;;AAED,MAAIjJ,MAAM7C,MAAM8C,iBAAN,CAAwB,MAAxB,EAAgC0I,gBAAhC,CAAV;AACA3I,MAAIE,gBAAJ,CAAqB,cAArB,EAAqCxD,QAAQwM,cAAR,EAArC;AACAlJ,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ,CAAS1D,QAAQyM,OAAR,EAAT;;AAEAnJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAED;;;;;;;AAOA,SAASoJ,4BAAT,CAAuCC,OAAvC,EAAgDtJ,QAAhD,EAA0D;AACxD,MAAI,CAACsJ,OAAL,EAAc;AACZ7L,YAAQiD,KAAR,CAAc,gDAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+B0I,mBAAmBU,OAAlD,CAAV;AACArJ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAED;;;;;;;;AAQA,SAASsJ,eAAT,CAA0B7J,IAA1B,EAAgCoJ,IAAhC,EAAsC9I,QAAtC,EAAgD;;AAE9C,MAAI,CAACN,IAAL,EAAW;AACTjC,YAAQiD,KAAR,CAAc,gCAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAI/D,UAAU,IAAIgM,WAAJ,EAAd;;AAEA,MAAIjJ,IAAJ,EAAS;AACP/C,YAAQoM,MAAR,CAAerJ,IAAf;AACD;;AAED,MAAIoJ,IAAJ,EAAS;AACPnM,YAAQoM,MAAR,CAAeD,KAAKE,IAApB,EAA0B;AACxBC,mBAAcH,KAAKnC,IADK;AAExBjH,YAAOoJ,KAAKU;AAFY,KAA1B;AAID;;AAED,MAAIvJ,MAAM7C,MAAM8C,iBAAN,CAAwB,MAAxB,EAAgC0I,gBAAhC,CAAV;AACA3I,MAAIE,gBAAJ,CAAqB,cAArB,EAAqCxD,QAAQwM,cAAR,EAArC;AACAlJ,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ,CAAS1D,QAAQyM,OAAR,EAAT;;AAEAnJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAED;;;;;;;AAOA,SAASwJ,yBAAT,CAAoCH,OAApC,EAA6CtJ,QAA7C,EAAuD;AACrD,MAAI,CAACsJ,OAAL,EAAc;AACZ7L,YAAQiD,KAAR,CAAc,6CAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+B0I,mBAAmBU,OAAnB,GAA6B,WAA5D,CAAV;AACArJ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAED;;;;;;;;AAQA,SAASyJ,yBAAT,CAAoCJ,OAApC,EAA6CK,SAA7C,EAAwD3J,QAAxD,EAAkE;AAChE,MAAI,CAACsJ,OAAL,EAAc;AACZ7L,YAAQiD,KAAR,CAAc,6CAAd;AACA,WAAO,KAAP;AACD;AACD,MAAI,CAACiJ,SAAL,EAAgB;AACdlM,YAAQiD,KAAR,CAAc,+CAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAIT,MAAM7C,MAAM8C,iBAAN,CAAwB,MAAxB,EAAgC0I,mBAAmBU,OAAnB,GAA6B,YAA7B,GAA4CK,SAA5E,CAAV;AACA1J,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAEDpE,OAAOC,OAAP,GAAiB;AACf8M,kBAAgBA,cADD;AAEfC,sBAAoBA,kBAFL;AAGfU,mBAAiBA,eAHF;AAIfF,gCAA8BA,4BAJf;AAKfI,6BAA2BA,yBALZ;AAMfC,6BAA2BA;AANZ,CAAjB;;;;;;AC9MA;;;;;;;;;;;AAWA;;;;;;AAMA;;;;;AAKA,IAAIE,gBAAgB,SAAhBA,aAAgB,CAAUhN,QAAV,EAAoB;AACtC;AACA,MAAIA,SAASI,MAAT,KAAoB,GAApB,IAA2BJ,SAASI,MAAT,KAAoB,CAAnD,EAAsD;AACpD,WAAO6M,QAAQC,OAAR,CAAgBlN,QAAhB,CAAP;AACD,GAFD,MAEO;AACL,WAAOiN,QAAQE,MAAR,CAAe,IAAIC,KAAJ,CAAUpN,SAASqN,UAAnB,CAAf,CAAP;AACD;AACF,CAPD;;AASA,IAAIC,YAAY,SAAZA,SAAY,CAAUtN,QAAV,EAAoB;AAClC,SAAOA,SAASuN,IAAT,EAAP;AACD,CAFD;;AAIA;AACA;AACA,IAAIC,oBAAoB,SAApBA,iBAAoB,GAAY;AAClC,MAAIC,iBAAiB,EAArB;AACA,MAAIC,UAAU,IAAIT,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AACnDM,mBAAeP,OAAf,GAAyBA,OAAzB;AACAO,mBAAeN,MAAf,GAAwBA,MAAxB;AACD,GAHa,CAAd;AAIAM,iBAAeE,IAAf,GAAsBD,QAAQC,IAAR,CAAaC,IAAb,CAAkBF,OAAlB,CAAtB;AACAD,iBAAeI,KAAf,GAAuBH,QAAQG,KAAR,CAAcD,IAAd,CAAmBF,OAAnB,CAAvB;AACAD,iBAAeC,OAAf,GAAyBA,OAAzB,CARkC,CAQA;AAClC,SAAOD,cAAP;AACD,CAVD;;AAYA;AACA,IAAIK,kBAAkB,SAAlBA,eAAkB,GAAY;AAChC,MAAIL,iBAAiBD,mBAArB;AACA,MAAIO,OAAOC,MAAMC,SAAN,CAAgBC,KAAhB,CAAsBC,IAAtB,CAA2BC,SAA3B,CAAX,CAFgC,CAEkB;;AAElDvJ,SAAOwJ,KAAP,CAAaC,KAAb,CAAmB,IAAnB,EAAyBP,IAAzB,EAA8B;AAA9B,GACOJ,IADP,CACY,UAAU3N,QAAV,EAAoB;AACxByN,mBAAeP,OAAf,CAAuBlN,QAAvB;AACD,GAHP,EAGS,UAAU8D,KAAV,EAAiB;AAClB2J,mBAAeN,MAAf,CAAsBrJ,KAAtB;AACD,GALP,EAMO+J,KANP,CAMa,UAAU/J,KAAV,EAAiB;AACtB2J,mBAAeI,KAAf,CAAqB/J,KAArB;AACD,GARP;AASA,SAAO2J,cAAP;AACD,CAdD;;AAgBA;;;;;;;EAOE,IAAIc,mBAAmB,IAAvB,C,CAA6B;;AAE/B,IAAIC,UAAU,SAAVA,OAAU,CAAUC,MAAV,EAAkB;AAC9B,MAAIC,eAAeZ,gBACbW,OAAOE,YAAP,GAAsBF,OAAOvO,GAAP,GAAa,GAAb,GAAmB,IAAI0O,IAAJ,GAAWC,OAAX,EAAzC,GAAgEJ,OAAOvO,GAD1D,EAEjB;AACED,YAAQ,KADV,EACiB;AACf6O,aAAS;AACP,gBAAU;AADH;AAFX,GAFiB,CAAnB;;AASA,MAAIC,YAAY3M,WAAW,YAAY;AACrCsM,iBAAavB,MAAb,CAAoB,IAAIC,KAAJ,CAAU,gCAAgCqB,OAAOvO,GAAjD,CAApB,EADqC,CACuC;AAC7E,GAFe,EAEbqO,gBAFa,CAAhB;;AAIA,SAAOG,aAAahB,OAAb,CAAoB;AAApB,GACAC,IADA,CACK,UAAU3N,QAAV,EAAoB;AACxBgP,iBAAaD,SAAb;AACA,WAAO/O,QAAP;AACD,GAJA,EAKA2N,IALA,CAKKX,aALL,EAMAW,IANA,CAMKL,SANL,CAAP;AAOD,CArBD;;AAuBA,SAAS2B,SAAT,CAAoB/O,GAApB,EAAyBgP,eAAzB,EAA0CC,aAA1C,EAAyD;AACvD,MAAIC,gBAAgB;AAClBlP,SAAKA,GADa,EACRyO,cAAc;AADN,GAApB;;AAIAH,UAAQY,aAAR,EAAuBzB,IAAvB,CACE,UAAU7K,IAAV,EAAgB;AACdoM,oBAAgBpM,IAAhB;AACD,GAHH,EAIE,UAAUgB,KAAV,EAAiB;AACfqL,kBAAcrL,KAAd;AACD,GANH;AAQD;;AAED,SAASuL,cAAT,CAAyBC,YAAzB,EAAuCJ,eAAvC,EAAwDC,aAAxD,EAAuEV,MAAvE,EAA+E;AAC7E,MAAI,EAAE,CAAC,CAACa,YAAF,IAAkBtB,UAAUsB,aAAaC,WAA3C,CAAJ,EAA6D;AAC3D1O,YAAQiD,KAAR,CAAc,sCAAd;AACAjD,YAAQiD,KAAR,CAAcwL,YAAd;AACA,WAAO,KAAP;AACD;AACD,MAAIE,aAAaF,aAAa,CAAb,CAAjB;AACA,MAAI,OAAQE,UAAR,KAAwB,QAA5B,EAAsC;AACpC3O,YAAQiD,KAAR,CAAc,kCAAd;AACA,WAAO,KAAP;AACD;;AAEDjD,UAAQC,GAAR,CAAY,8BAAZ;AACAD,UAAQC,GAAR,CAAYwO,YAAZ;;AAEAA,eAAaG,KAAb;;AAEA,MAAIC,kBAAJ;AACA,MAAIC,oBAAJ;AACA,MAAIL,aAAaM,MAAb,IAAuB,CAA3B,EAA8B;AAAE;AAC9BD,2BAAuBT,eAAvB;AACAQ,yBAAqBP,aAArB;AACD,GAHD,MAGO;AACLQ,2BAAuBT,eAAvB;AACAQ,yBAAqB,4BAAU5L,KAAV,EAAiB;AACpCuL,qBAAeC,YAAf,EAA6BJ,eAA7B,EAA8CC,aAA9C,EAA6DV,MAA7D;AACD,KAFD;AAGD;;AAED,MAAIW,gBAAgB;AAClBlP,SAAKsP,UADa;AAElBb,kBAAe,EAAGF,UAAUA,OAAOE,YAAP,KAAwB,KAArC;AAFG,GAApB;AAIAH,UAAQY,aAAR,EAAuBzB,IAAvB,CACE,UAAU7K,IAAV,EAAgB;AACd6M,yBAAqB7M,IAArB,EAA4BjC,QAAQC,GAAR,CAAY,qBAAZ,EAAoCD,QAAQC,GAAR,CAAYgC,IAAZ;AACjE,GAHH,EAIE,UAAUgB,KAAV,EAAiB;AACf4L,uBAAmB5L,KAAnB,EAA2BjD,QAAQC,GAAR,CAAY,kBAAZ,EAAiCD,QAAQC,GAAR,CAAYgD,KAAZ;AAC7D,GANH;AAQD;;AAED7E,OAAOC,OAAP,GAAiBmQ,cAAjB;;;;;;AC5JA;;;;;;;;;;;;AAYA;AACA,SAASQ,aAAT,CAAwBC,IAAxB,EAA8BC,QAA9B,EAAwC;AACtC,MAAI,CAACD,IAAL,EAAW;AACTjP,YAAQiD,KAAR,CAAc,8BAAd;AACA,WAAO,KAAP;AACD;;AAED,MAAI,CAACiM,QAAL,EAAe;AACZA,eAAW,IAAX;AACF;;AAED,MAAIC,YACF,8CACA,gDADA,GAEA,wDAFA,GAGA,kDAHA,GAIA,8IAJA,GAKA,SALA,GAME,mBANF,GAMwBD,QANxB,GAMmC,IANnC,GAOE,6BAPF,GAQE,0CARF,GASE,oDATF,GAUE,6CAVF,GAWE,uCAXF,GAYE,0CAZF,GAaE,gFAbF,GAaqFD,IAbrF,GAa4F,MAb5F,GAcE,+EAdF,GAeE,6DAfF,GAekEA,IAflE,GAeyE,KAfzE,GAgBA,GAjBF;;AAmBA,SAAO,kFAAkFG,mBAAmBD,SAAnB,CAAlF,GAAkH,cAAzH;AACD;;AAED/Q,OAAOC,OAAP,GAAiB;AACf2Q,iBAAeA;AADA,CAAjB;;;;;;AC7CA,IAAMvL,WAAW1E,QAAQ,gBAAR,CAAjB;AACA,IAAMmQ,WAAWnQ,QAAQ,eAAR,CAAjB;AACA,IAAM+E,KAAK/E,QAAQ,SAAR,CAAX;;AAEA;;AAEA,SAASsQ,QAAT,GAAqB;AACnB,MAAIC,WAAWtL,OAAOuL,SAAP,CAAiBC,SAAjB,GAA6BxL,OAAOuL,SAAP,CAAiBC,SAAjB,CAA2B,CAA3B,CAA7B,GAA8DxL,OAAOuL,SAAP,CAAiBD,QAAjB,IAA6BtL,OAAOuL,SAAP,CAAiBE,YAA3H;;AAEA,MAAI,OAAOH,QAAP,KAAoB,QAAxB,EAAkC;AAChCA,eAAW,CAAEA,QAAF,CAAX;AACD;;AAED;AACA;AACA;AACA;;AAEA,OAAK,IAAII,IAAI,CAAb,EAAgBA,IAAIJ,SAASP,MAA7B,EAAqCW,GAArC,EAA0C;AACxC,QAAIJ,SAASI,CAAT,EAAYpQ,KAAZ,CAAkB,GAAlB,CAAJ,EAA4B;AAC1B,UAAIqQ,aAAaL,SAASI,CAAT,EAAYpQ,KAAZ,CAAkB,eAAlB,EAAmC,CAAnC,CAAjB;AACA,UAAIgQ,SAASM,OAAT,CAAiBD,UAAjB,KAAgC,CAAC,CAArC,EAAwC;AACtCL,iBAASO,IAAT,CAAcF,UAAd;AACA;AACD;AACF;AACF;;AAED,MAAIL,SAASM,OAAT,CAAiB,IAAjB,KAA0B,CAAC,CAA/B,EAAkC;AAChCN,aAASO,IAAT,CAAc,IAAd;AACD;;AAED7P,UAAQC,GAAR,CAAYqP,QAAZ;AACA,SAAOA,QAAP;AACD;;AAED,SAASQ,gBAAT,GAA6B;AAC3BC,mBAAiB,EAAjB;AACA,MAAIxL,gBAAgB,IAApB,EAA0B;AACxB,SAAK,IAAImL,IAAI,CAAb,EAAgBA,IAAIM,kBAAkBjB,MAAtC,EAA8CW,GAA9C,EAAmD;AACjD,UAAIO,OAAOD,kBAAkBN,CAAlB,CAAX;AACA,UAAInL,gBAAgB0L,IAApB,EAA0B;AACxBF,uBAAeF,IAAf,CAAoBI,IAApB;AACD;AACF;AACF;AACDjQ,UAAQC,GAAR,CAAY,yBAAyB8P,eAAeG,IAAf,CAAoB,GAApB,CAAzB,GAAoD,GAAhE;AACD;;AAED,SAASC,SAAT,GAAsB;AACpB5L,iBAAe,IAAf;AACA,OAAK,IAAImL,IAAI,CAAb,EAAgBA,IAAIM,kBAAkBjB,MAAtC,EAA8CW,GAA9C,EAAmD;AACjD,QAAIO,OAAOD,kBAAkBN,CAAlB,CAAX;AACA,QAAIU,eAAeH,IAAf,CAAJ,EAA0B;AACxB1L,qBAAe0L,IAAf;AACA;AACD;AACF;AACDI,eAAa9L,YAAb;AACD;;AAED;;AAEA,IAAIC,sBAAsB,EAA1B;AAAA,IACE8L,YAAY,EADd;AAAA,IAEEF,iBAAiB,EAFnB;AAAA,IAGEG,iBAAiB,EAHnB;;AAKA,SAASC,0BAAT,CAAqCC,aAArC,EAAoD;AAClD,MAAIxB,IAAJ;AACA,OAAKA,IAAL,IAAawB,cAAcC,QAAd,CAAuBC,EAAvB,CAA0BC,MAAvC,EAA+C;AAAE;AAC/CpM,wBAAoBqL,IAApB,CAAyBZ,IAAzB;AACD;AACD,MAAI4B,UAAUrM,oBAAoB0L,IAApB,CAAyB,GAAzB,CAAd;;AAEA,MAAIY,gBACF,mCACA,OADA,GAEA,GAFA,GAGE,uBAHF,GAIE,0BAJF,GAI+BD,OAJ/B,GAIyC,OAJzC,GAKE,oEALF,GAMA,GAPF;;AASAC,kBAAgB,mEAAmE1B,mBAAmB0B,aAAnB,CAAnE,GAAuG,cAAvH;AACA/O,IAAE4L,OAAF,CAAUmD,aAAV,EAAyB,UAAUC,WAAV,EAAuB;AAC9CA,gBAAYC,OAAZ,CAAoBC,QAApB,CAA6BC,OAA7B,CAAqC,UAAUC,IAAV,EAAgB;AACnDf,qBAAee,KAAKlB,IAAL,CAAU1G,KAAzB,IAAkC4H,KAAKC,SAAL,CAAe7H,KAAjD;AACAgH,qBAAeY,KAAKC,SAAL,CAAe7H,KAA9B,IAAuC4H,KAAKlB,IAAL,CAAU1G,KAAjD;AACA+G,gBAAUT,IAAV,CAAesB,KAAKC,SAAL,CAAe7H,KAA9B;AACD,KAJD;AAKA+G,cAAUe,IAAV;;AAEAlB;AACAL;;AAEAQ,cAAUY,OAAV,CAAkB,UAAUC,IAAV,EAAgB;AAChC,UAAIG,WAAWf,eAAeY,IAAf,CAAf;AACA,UAAII,aAAcD,YAAY/M,YAAb,GAA6B,gBAA7B,GAAgD,EAAjE;AACAvE,cAAQC,GAAR,CAAY,kBAAkBqR,QAAlB,GAA6B,KAA7B,GAAqCH,IAArC,GAA4C,GAAxD;AACApP,QAAE,sBAAF,EAA0BuJ,MAA1B,CAAiC,oBAAoBgG,QAApB,GAA+BC,UAA/B,GAA4C,+CAA5C,GAA8FD,QAA9F,GAAyG,QAAzG,GAAoHH,IAApH,GAA2H,OAA5J;AACD,KALD;AAMD,GAjBD;AAkBD;;AAED,SAASrM,yBAAT,CAAoCmK,IAApC,EAA0C;AACxCxL,WAAS,CAAEyL,SAASF,aAAT,CAAuBC,IAAvB,EAA6B,IAA7B,CAAF,EAAsC,wHAAwHA,IAAxH,GAA+H,OAArK,CAAT,EACInL,GAAG0N,QADP,EAEI,UAAUvO,KAAV,EAAiB;AACfjD,YAAQiD,KAAR,CAAc,0CAAd;AACD,GAJL,EAKI,EAAE6K,cAAc,KAAhB,EALJ;AAMArK,WAAS,CAAEyL,SAASF,aAAT,CAAuBC,IAAvB,EAA6B,IAA7B,CAAF,EAAsC,wHAAwHA,IAAxH,GAA+H,OAArK,CAAT,EACInL,GAAG2N,kBADP,EAEI,UAAUxO,KAAV,EAAiB;AACfjD,YAAQiD,KAAR,CAAc,0CAAd;AACD,GAJL,EAKI,EAAE6K,cAAc,KAAhB,EALJ;AAMD;;AAED,SAAS/I,wBAAT,CAAmC2M,MAAnC,EAA2C;AACzChO,eAAa8M,0BAAb,CAAwCkB,MAAxC;;AAEA,MAAIC,kBAAkBjO,aAAaY,iBAAb,CAA+BZ,aAAaa,YAA5C,CAAtB;AACAb,eAAaa,YAAb,GAA4BoN,eAA5B;AACA7M,4BAA0B6M,eAA1B;AACD;;AAED,SAAStB,YAAT,CAAuBpB,IAAvB,EAA6B;AAC3BlN,IAAE,8BAAF,EAAkC6P,WAAlC,CAA8C,SAA9C;AACA7P,IAAE,qCAAqCkN,IAArC,GAA4C,GAA9C,EAAmD4C,QAAnD,CAA4D,SAA5D;AACAtN,iBAAe0K,IAAf;AACAjL,SAAON,YAAP,CAAoBa,YAApB,GAAmC0K,IAAnC;AACAjL,SAAON,YAAP,CAAoBoB,yBAApB,CAA8CmK,IAA9C;AACAa;AACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmCE9P,UAAQC,GAAR,CAAY,cAAcgP,IAA1B;AACD;;AAED;AACA;AACA;AACA,SAAS3K,iBAAT,CAA4BwN,UAA5B,EAAwC;AACtC9R,UAAQC,GAAR,CAAY,uBAAuB6R,UAAvB,GAAoC,UAAhD;AACA,MAAIA,UAAJ,EAAgB;AACd,QAAItN,oBAAoBoL,OAApB,CAA4BkC,UAA5B,KAA2C,CAAC,CAAhD,EAAmD;AACjDvN,qBAAeuN,UAAf;AACA,aAAOvN,YAAP;AACD;AACDvE,YAAQC,GAAR,CAAY,+BAAZ;AACA,QAAI8R,UAAUD,WAAWxS,KAAX,CAAiB,eAAjB,CAAd;AACA,QAAIyS,WAAWA,QAAQ,CAAR,CAAf,EAA2B;AACzB,UAAIpC,aAAaoC,QAAQ,CAAR,CAAjB;AACA/R,cAAQC,GAAR,CAAY,YAAY0P,UAAxB;AACA,UAAIA,UAAJ,EAAgB;AACd,YAAInL,oBAAoBoL,OAApB,CAA4BD,UAA5B,KAA2C,CAAC,CAAhD,EAAmD;AACjDpL,yBAAeoL,UAAf;AACA3P,kBAAQC,GAAR,CAAY,yBAAyB0P,UAArC;AACA,iBAAOpL,YAAP;AACD;AACF;AACF;AACF;AACDuL;AACA,MAAIC,eAAe,CAAf,CAAJ,EAAuB;AACrB,QAAIvL,oBAAoBoL,OAApB,CAA4BG,eAAe,CAAf,CAA5B,KAAkD,CAAC,CAAvD,EAA0D;AACxDxL,qBAAewL,eAAe,CAAf,CAAf;AACA,aAAOxL,YAAP;AACD;AACF;AACDA,iBAAe,IAAf;AACA,SAAOA,YAAP;AACD;;AAED,IAAIyL,oBAAoBX,UAAxB;AAAA,IACE9K,eAAeyL,kBAAkB,CAAlB,CADjB;AAAA,IAEED,iBAAiB,EAFnB;;AAIA3R,OAAOC,OAAP,GAAiB;AACfgR,YAAUA,QADK;AAEfmB,8BAA4BA,0BAFb;AAGfzL,4BAA0BA,wBAHX;AAIfP,uBAAqBA,mBAJN;AAKfwL,qBAAmBA,iBALJ;AAMfzL,gBAAcA,YANC;AAOf8L,gBAAcA,YAPC;AAQf/L,qBAAmBA,iBARJ;AASfQ,6BAA2BA;AATZ,CAAjB;;;;;;ACpNA,IAAMnB,UAAU5E,QAAQ,eAAR,CAAhB;AACA,IAAMiT,SAASjT,QAAQ,cAAR,CAAf;AACA,IAAM6E,UAAU7E,QAAQ,eAAR,CAAhB;AACA,IAAM8E,UAAU9E,QAAQ,eAAR,CAAhB;AACA,IAAMgF,MAAMhF,QAAQ,UAAR,CAAZ;AACA,IAAMY,QAAQZ,QAAQ,YAAR,CAAd;;AAEA,IAAIkT,cAAc,EAAlB;;AAEA,SAASrN,QAAT,CAAmBsN,SAAnB,EAA8B;;AAE5BD,gBAAcC,SAAd;;AAEA,MAAID,YAAYE,QAAhB,EAA0B;AACxBrS,aAAS2E,cAAT,CAAwB,SAAxB,EAAmC2N,KAAnC,CAAyCC,OAAzC,GAAmD,OAAnD;AACD;;AAED,MAAIJ,YAAYK,UAAhB,EAA4B;AAC1B,SAAK,IAAIC,GAAT,IAAgBN,YAAYK,UAA5B,EAAwC;AACtC;AACA,UAAI,KAAKE,IAAL,CAAUD,GAAV,CAAJ,EAAoB;AAClB;AACD;;AAED,UAAIE,QAAQ3S,SAAS2E,cAAT,CAAwB,UAAU8N,GAAlC,CAAZ;AACA,UAAIhJ,QAAQ0I,YAAYK,UAAZ,CAAuBC,GAAvB,CAAZ;;AAEA,UAAIE,KAAJ,EAAW;AACT;AACA;AACAA,cAAMlJ,KAAN,GAAcA,KAAd;AACD,OAJD,MAIO;AAAE;AACP;AACA,YAAImJ,WAAW5S,SAAS2E,cAAT,CAAwB,UAAxB,CAAf;AACA,YAAIkO,UAAUD,SAASE,SAAvB;AACA,eAAOD,QAAQE,QAAR,KAAqB,CAA5B,EAA+B;AAAE;AAC/BF,oBAAUA,QAAQG,eAAlB;AACD;;AAED;AACA,YAAIC,UAAWJ,QAAQK,UAAR,CAAmBH,QAAnB,KAAgC,CAAjC,GAAsCF,QAAQK,UAA9C,GAA2DL,QAAQK,UAAR,CAAmBC,WAA5F;AACAF,gBAAQxJ,KAAR,GAAgBgJ,GAAhB;AACA,YAAIW,YAAaP,QAAQC,SAAR,CAAkBC,QAAlB,KAA+B,CAAhC,GAAqCF,QAAQC,SAA7C,GAAyDD,QAAQC,SAAR,CAAkBE,eAA3F;AACAI,kBAAU3J,KAAV,GAAkBA,KAAlB;;AAEA5E;AACD;AACF;AACF;;AAEDwO,oCAAkClB,WAAlC;;AAEA,MAAIA,YAAYmB,QAAZ,IAAwBnB,YAAYmB,QAAZ,CAAqBC,WAAjD,EAA8D;AAC5D,QAAIzI,MAAMqH,YAAYmB,QAAZ,CAAqBC,WAArB,CAAiC,CAAjC,CAAV;AACA,QAAI1J,MAAMsI,YAAYmB,QAAZ,CAAqBC,WAArB,CAAiC,CAAjC,CAAV;AACA,QAAI1J,QAAQ2J,SAAR,IAAqB1I,QAAQ0I,SAAjC,EAA4C;AAC1CtT,cAAQiD,KAAR,CAAc,kBAAd;AACA;AACD;;AAEDnD,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDqB,GAAjD;AACA9K,aAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDI,GAAjD;;AAEA,QAAI4J,cAAcxP,IAAIkD,MAAJ,EAAlB;AACAsM,gBAAYjK,iBAAZ,GAAgC,IAAI5D,EAAEkB,MAAN,CAAa,CAAC+C,GAAD,EAAMiB,GAAN,CAAb,EAAyB;AACvDxE,YAAM,IAAImN,YAAY7I,cAAhB;AADiD,KAAzB,CAAhC;AAGA6I,gBAAY9I,iBAAZ,CAA8BnC,QAA9B,CAAuCiL,YAAYjK,iBAAnD;;AAEAiK,gBAAY1J,cAAZ,GAA6B0J,YAAYtN,cAAZ,CAA2B,KAA3B,CAA7B;AACAsN,gBAAYrL,UAAZ,CAAuBqL,YAAY1J,cAAnC;;AAEA0J,gBAAYvI,KAAZ,CAAkB,IAAItF,EAAEoC,MAAN,CAAa6B,GAAb,EAAkBiB,GAAlB,CAAlB;AACD,GArBD,MAqBO;AAAE;AACP2I,gBAAY1J,cAAZ,GAA6B0J,YAAYtN,cAAZ,CAA2B,IAA3B,CAA7B;AACAsN,gBAAYrL,UAAZ,CAAuBqL,YAAY1J,cAAnC;AACD;;AAED,MAAIoI,YAAYK,UAAZ,IAA0BL,YAAYK,UAAZ,CAAuBpQ,GAArD,EAA0D;AACxDpC,aAAS2E,cAAT,CAAwB,KAAxB,EAA+B8E,KAA/B,GAAuC0I,YAAYK,UAAZ,CAAuBpQ,GAA9D;AACAH,MAAE,qBAAF,EAAyByR,IAAzB,CAA8B,MAA9B,EAAsC7P,QAAQT,eAAR,KAA4B+O,YAAYK,UAAZ,CAAuBpQ,GAAzF;AACD,GAHD,MAGO,IAAI+P,YAAY/P,GAAhB,EAAqB;AAC1BpC,aAAS2E,cAAT,CAAwB,KAAxB,EAA+B8E,KAA/B,GAAuC0I,YAAY/P,GAAnD;AACAH,MAAE,qBAAF,EAAyByR,IAAzB,CAA8B,MAA9B,EAAsC7P,QAAQT,eAAR,KAA4B+O,YAAY/P,GAA9E;AACD;;AAED,MAAI+P,YAAYK,UAAZ,CAAuBmB,GAA3B,EAAgC;AAC9B1R,MAAE,UAAF,EAAcyR,IAAd,CAAmB,MAAnB,EAA2BvB,YAAYK,UAAZ,CAAuBmB,GAAlD;AACD;AAEF;;AAED,SAASN,iCAAT,CAA2ClB,WAA3C,EAAuD;AACrDlQ,IAAE,QAAF,EAAY2R,IAAZ,CAAiB,EAAjB;AACA,MAAIzB,YAAYK,UAAZ,CAAuBqB,WAA3B,EAAuC;AACrC,QAAIC,eAAe3B,YAAYK,UAAZ,CAAuBqB,WAA1C;AACA5R,MAAE,oBAAF,EAAwBvC,IAAxB,CAA6B,wBAAwB,IAAxB,GAA+BoU,aAAa7E,MAA5C,GAAqD,GAAlF;AACA,SAAK,IAAIW,IAAE,CAAX,EAAcA,IAAGkE,aAAa7E,MAA9B,EAAsCW,GAAtC,EAA0C;AACxC,UAAImE,cAAcD,aAAalE,CAAb,CAAlB;AACAsC,aAAOpG,4BAAP,CAAoCiI,WAApC,EAAiD,UAASC,SAAT,EAAmB;;AAElE,YAAIC,MAAMhS,EAAE,+BAA8B+R,UAAUjI,OAAxC,GAAkD,UAApD,CAAV;;AAEA,YAAImI,OAAOjS,EAAE,mCAAF,CAAX;AACA,YAAI+R,UAAUvI,IAAd,EAAmB;AACjByI,eAAK1I,MAAL,CAAY,QAAQwI,UAAUvI,IAAlB,GAAyB,MAArC;AACD;AACD,YAAIuI,UAAUG,WAAd,EAA0B;AACxBD,eAAK1I,MAAL,CAAY,QAAQwI,UAAUG,WAAlB,GAAgC,MAA5C;AACD;;AAED,YAAI5N,UAAUtE,EAAE,yBAAF,CAAd;;AAEA,YAAImS,eAAenS,EAAE,2CAAF,CAAnB;AACAmS,qBAAapL,EAAb,CAAgB,OAAhB,EAAwB,EAAEqL,UAAWL,SAAb,EAAwB7B,aAAaA,WAArC,EAAxB,EAA2E,UAAUmC,GAAV,EAAc;AACvF,cAAInS,OAAOmS,IAAInS,IAAf;AACAjC,kBAAQC,GAAR,CAAY,gDAAgDgC,KAAKkS,QAAL,CAActI,OAA1E;AACA,cAAIwI,QAAQ,kDAAR,CAAJ,EAAiE;AAC/DC,oBAAQC,sBAAR,CAA+BtS,KAAKgQ,WAAL,CAAiB/P,GAAhD,EAAoDD,KAAKkS,QAAL,CAActI,OAAlE,EAA0E,YAAU;AAClF9J,gBAAE,MAAIE,KAAKkS,QAAL,CAActI,OAApB,EAA6BxK,MAA7B;AACA8R,gDAAkClB,WAAlC;AACD,aAHD;AAID;AACF,SATD;;AAWA,YAAIuC,aAAazS,EAAE,6FAA6F+R,UAAUjI,OAAvG,GAAiH,aAAnH,CAAjB;AACA2I,mBAAW1L,EAAX,CAAc,OAAd,EAAsB,EAAEqL,UAAWL,SAAb,EAAwB7B,aAAaA,WAArC,EAAtB,EAA0E,UAAUmC,GAAV,EAAc;AACtF,cAAInS,OAAOmS,IAAInS,IAAf;;AAEAtC,gBAAM8U,gBAAN;;AAEAzU,kBAAQC,GAAR,CAAY,8CAA8CgC,KAAKkS,QAAL,CAAcjT,EAAxE;AACAa,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,iBAAlC,EAAqDlV,IAArD,CAA0D,QAA1D;AACAuC,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,UAAlC,EAA8ClV,IAA9C,CAAmDyC,KAAKkS,QAAL,CAAcjT,EAAjE;AACAa,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,OAAlC,EAA2CC,GAA3C,CAA+C1S,KAAKkS,QAAL,CAAc5I,IAA7D;AACAxJ,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,cAAlC,EAAkDC,GAAlD,CAAsD1S,KAAKkS,QAAL,CAAcF,WAApE;AACAlS,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,KAAlC,EAAyClB,IAAzC,CAA8C,KAA9C,EAAoDvR,KAAKkS,QAAL,CAAc9U,GAAlE;AACA0C,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,KAAlC,EAAyCE,IAAzC;AACA7S,YAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,WAAlC,EAA+ClV,IAA/C,CAAoDC,KAAKC,SAAL,CAAeuC,KAAKkS,QAApB,CAApD;;AAEArU,mBAAS2E,cAAT,CAAwB,aAAxB,EAAuC1E,gBAAvC,CAAwD,QAAxD,EAAkEJ,MAAMkV,gBAAxE,EAA0F,KAA1F;;AAEA7C,iBAAOhG,yBAAP,CAAiC/J,KAAKkS,QAAL,CAAcjT,EAA/C,EAAmD,UAAS4T,aAAT,EAAuB;AACxE,gBAAIA,cAAc/F,MAAd,GAAuB,CAA3B,EAA6B;AAC3B,kBAAIgG,eAAehT,EAAE,uBAAF,CAAnB;AACA,mBAAK,IAAI2N,IAAE,CAAX,EAAcA,IAAIoF,cAAc/F,MAAhC,EAAwCW,GAAxC,EAA4C;AAC1C,oBAAIsF,UAAUF,cAAcpF,CAAd,CAAd;AACA,oBAAIuF,eAAelT,EAAE,kBAAkBiT,QAAQ9T,EAA1B,GAA+B,2BAA/B,GAA6D8T,QAAQE,YAArE,GAAoF,SAApF,GAAgGF,QAAQzJ,IAAxG,GAA+G,KAA/G,GAAuHyJ,QAAQG,MAA/H,GAAwI,YAA1I,CAAnB;AACA,oBAAIH,QAAQI,MAAZ,EAAmB;AACjBH,+BAAa3J,MAAb,CAAoB,GAApB,EAAyBA,MAAzB,CAAgC,iBAAhC;AACD,iBAFD,MAEK;AACH,sBAAI+J,eAAetT,EAAE,iBAAiBiT,QAAQ9T,EAAzB,GAA8B,yBAAhC,CAAnB;AACAmU,+BAAavM,EAAb,CAAgB,OAAhB,EAAwB,EAAEkM,SAAUA,OAAZ,EAAxB,EAA8C,UAASZ,GAAT,EAAa;AACzD,wBAAIkB,cAAclB,IAAInS,IAAtB;AACA+P,2BAAO/F,yBAAP,CAAiChK,KAAKkS,QAAL,CAAcjT,EAA/C,EAAkDoU,YAAYN,OAAZ,CAAoB9T,EAAtE,EAA0E,YAAU;AAClFa,wBAAE,kBAAF,EAAsBwT,KAAtB,CAA4B,QAA5B;AACD,qBAFD;AAGD,mBALD;AAMAN,+BAAa3J,MAAb,CAAoB,GAApB,EAAyBA,MAAzB,CAAgC+J,YAAhC;AACD;AACDN,6BAAazJ,MAAb,CAAoB2J,YAApB;AACD;AACDlT,gBAAE,gBAAF,EAAoB2R,IAApB,CAAyBqB,YAAzB;AACD;AACF,WAtBD;AAuBD,SAvCD;;AAyCA1O,gBAAQiF,MAAR,CAAe4I,YAAf;AACA7N,gBAAQiF,MAAR,CAAekJ,UAAf;AACAR,aAAK1I,MAAL,CAAYjF,OAAZ;;AAEA,YAAImP,WAAW,6DAAf;AACA,YAAI1B,UAAU2B,QAAV,KAAuB,WAAvB,IAAsC3B,UAAU2B,QAAV,KAAuB,YAAjE,EAA8E;AAC5ED,qBAAW1B,UAAUzU,GAArB;AACD;AACD0U,YAAIzI,MAAJ,CAAW,kCAAkCkK,QAAlC,GAA6C,KAAxD;AACAzB,YAAIzI,MAAJ,CAAW0I,IAAX;;AAEAjS,UAAE,QAAF,EAAYuJ,MAAZ,CAAmByI,GAAnB,EAAwBzI,MAAxB,CAA+B,MAA/B;AACD,OAhFD;AAiFD;AACF;AACF;;AAED,SAASzG,mBAAT,GAA8B;AAC5B;AACA9C,IAAE,OAAF,EAAWuJ,MAAX,CACE,2FACE,uCADF,GAEE,WAFF,GAGA,QAJF;AAMD;;AAED,SAAS3G,cAAT,GAAyB;AACvB,MAAI+N,WAAW5S,SAAS2E,cAAT,CAAwB,UAAxB,CAAf;;AAEA,MAAIkO,UAAUD,SAASE,SAAvB;AACA,SAAOD,QAAQE,QAAR,KAAqB,CAA5B,EAA+B;AAAE;AAC/BF,cAAUA,QAAQG,eAAlB;AACD;;AAED,MAAIC,UAAWJ,QAAQK,UAAR,CAAmBH,QAAnB,KAAgC,CAAjC,GAAsCF,QAAQK,UAA9C,GAA2DL,QAAQK,UAAR,CAAmBC,WAA5F;AACA,MAAIyC,QAAQC,SAAS5C,QAAQ7R,EAAR,CAAWmM,KAAX,CAAiB,CAAC,CAAlB,CAAT,IAAiC,CAA7C;;AAEA,MAAIuI,SAAS9V,SAAS+V,aAAT,CAAuB,KAAvB,CAAb;AACA,MAAIC,WAAWhW,SAASiW,eAAT,CAAyB,OAAzB,CAAf;AACAD,WAASvM,KAAT,GAAiB,KAAjB;AACAqM,SAAOI,gBAAP,CAAwBF,QAAxB;AACA,MAAIG,SAASnW,SAAS+V,aAAT,CAAuB,OAAvB,CAAb;AACA,MAAIK,iBAAiBpW,SAASiW,eAAT,CAAyB,OAAzB,CAArB;AACAG,iBAAe3M,KAAf,GAAuB,cAAvB;AACA0M,SAAOD,gBAAP,CAAwBE,cAAxB;AACA,MAAIA,iBAAiBpW,SAASiW,eAAT,CAAyB,OAAzB,CAArB;AACAG,iBAAe3M,KAAf,GAAuB,cAAvB;AACA,MAAI4M,WAAWrW,SAAS+V,aAAT,CAAuB,OAAvB,CAAf;AACAM,WAASH,gBAAT,CAA0BE,cAA1B;AACA,MAAIE,QAAQtW,SAASiW,eAAT,CAAyB,IAAzB,CAAZ;AACAK,QAAM7M,KAAN,GAAc,QAAQmM,KAAtB;AACA,MAAIW,UAAUvW,SAASiW,eAAT,CAAyB,IAAzB,CAAd;AACAM,UAAQ9M,KAAR,GAAgB,UAAUmM,KAA1B;AACAO,SAAOD,gBAAP,CAAwBI,KAAxB;AACAD,WAASH,gBAAT,CAA0BK,OAA1B;;AAEA,MAAIC,cAAcxW,SAASiW,eAAT,CAAyB,MAAzB,CAAlB;AACAO,cAAY/M,KAAZ,GAAoB,UAApB;AACA0M,SAAOD,gBAAP,CAAwBM,WAAxB;AACAH,WAASH,gBAAT,CAA0BM,YAAYC,SAAZ,CAAsB,IAAtB,CAA1B;;AAEAX,SAAOY,WAAP,CAAmBP,MAAnB;AACAL,SAAOY,WAAP,CAAmBL,QAAnB;AACAzD,WAAS8D,WAAT,CAAqBZ,MAArB;AACD;;AAED,SAASa,cAAT,CAAyBC,SAAzB,EAAoC;AAClC,MAAI,OAAQA,SAAR,KAAuB,QAA3B,EAAqC;AACnC,WAAO,EAAP;AACD;AACD,MAAIC,WAAWD,UAAUpM,KAAV,CAAgB,GAAhB,CAAf;AACA,OAAK,IAAIoF,IAAI,CAAb,EAAgBA,IAAIiH,SAAS5H,MAA7B,EAAqCW,GAArC,EAA0C;AACxCiH,aAASjH,CAAT,IAAciH,SAASjH,CAAT,EAAYkH,IAAZ,EAAd;AACD;AACD,SAAOD,QAAP;AACD;;AAED,SAASlF,kBAAT,CAA6BxP,IAA7B,EAAmC;AACjCjC,UAAQC,GAAR,CAAY,2BAAZ;;AAEA,MAAI4W,YAAY5U,KAAK+O,OAAL,CAAaC,QAA7B;AACA,MAAM1M,eAAesS,UAAU,CAAV,EAAaC,SAAb,CAAuB,UAAvB,CAArB;;AAEA,MAAIC,QAAQ,EAAZ;AACA,MAAIC,eAAe,EAAnB;AACA,MAAIC,aAAa,EAAjB;;AAEAJ,YAAU3F,OAAV,CAAkB,UAAUgG,KAAV,EAAiB;AACjC,QAAI,CAACA,MAAMC,WAAX,EAAwB;AACtB;AACD;AACD,QAAIC,QAAQ,EAAZ;AACAA,UAAM7S,YAAN,IAAsB2S,MAAMJ,SAAN,CAAgBvN,KAAtC;AACA,QAAI8N,gBAAgB;AAClBlG,YAAM+F,MAAM/F,IAAN,CAAW5H,KADC;AAElB6N,aAAOA;AAFW,KAApB;AAIA,QAAIF,MAAMC,WAAN,CAAkB5N,KAAlB,IAA2B,yCAA/B,EAA0E;AACxE8N,oBAAc,WAAd,IAA6BH,MAAMI,SAAN,CAAgB/N,KAA7C;AACAwN,YAAMlH,IAAN,CAAWwH,aAAX;AACD,KAHD,MAGO,IAAIH,MAAMC,WAAN,CAAkB5N,KAAlB,IAA2B,yCAA/B,EAA0E;AAC/E8N,oBAAc,iBAAd,IAAmCH,MAAMK,eAAN,CAAsBhO,KAAzD;AACAyN,mBAAanH,IAAb,CAAkBwH,aAAlB;AACD,KAHM,MAGA,IAAIH,MAAMC,WAAN,CAAkB5N,KAAlB,IAA2B,yCAA/B,EAA0E;AAC/E8N,oBAAc,cAAd,IAAgCH,MAAMM,YAAN,CAAmBjO,KAAnD;AACA0N,iBAAWpH,IAAX,CAAgBwH,aAAhB;AACD;AACF,GApBD;;AAsBA;AACAtV,IAAE,gBAAF,EAAoB0V,KAApB;AACAV,QAAM7F,OAAN,CAAc,UAAUgG,KAAV,EAAiB;AAC7B,QAAIQ,YAAY3V,EAAE,UAAF,CAAhB;AACA2V,cAAUlE,IAAV,CAAe,OAAf,EAAwB0D,MAAMI,SAA9B;;AAEA,QAAIrF,YAAYK,UAAZ,IAA0BL,YAAYK,UAAZ,CAAuBqF,QAArD,EAA+D;AAC7D,UAAIC,cAAcnB,eAAexE,YAAYK,UAAZ,CAAuBqF,QAAtC,CAAlB;AACAC,kBAAY1G,OAAZ,CAAoB,UAAU2G,IAAV,EAAgB;AAClC,YAAIA,SAASX,MAAMI,SAAnB,EAA8B;AAC5BI,oBAAUlE,IAAV,CAAe,UAAf,EAA2B,UAA3B;AACD;AACF,OAJD;AAKD;AACDkE,cAAUpM,MAAV,CAAiB4L,MAAME,KAAN,CAAY7S,YAAZ,CAAjB;AACAxC,MAAE,gBAAF,EAAoBuJ,MAApB,CAA2BoM,SAA3B;AACA3V,MAAE,gBAAF,EAAoB+V,YAApB,CAAiC,SAAjC;AACD,GAfD;;AAiBA;AACA/V,IAAE,mBAAF,EAAuB0V,KAAvB;AACAT,eAAa9F,OAAb,CAAqB,UAAUgG,KAAV,EAAiB;AACpC,QAAIQ,YAAY3V,EAAE,UAAF,CAAhB;AACA2V,cAAUlE,IAAV,CAAe,OAAf,EAAwB0D,MAAMK,eAA9B;;AAEA,QAAItF,YAAYK,UAAZ,IAA0BL,YAAYK,UAAZ,CAAuByF,WAArD,EAAkE;AAChE,UAAIC,qBAAqBvB,eAAexE,YAAYK,UAAZ,CAAuByF,WAAtC,CAAzB;AACAC,yBAAmB9G,OAAnB,CAA2B,UAAU+G,QAAV,EAAoB;AAC7C,YAAIA,aAAaf,MAAMK,eAAvB,EAAwC;AACtCG,oBAAUlE,IAAV,CAAe,UAAf,EAA2B,UAA3B;AACD;AACF,OAJD;AAKD;AACDkE,cAAUpM,MAAV,CAAiB4L,MAAME,KAAN,CAAY7S,YAAZ,CAAjB;AACAxC,MAAE,mBAAF,EAAuBuJ,MAAvB,CAA8BoM,SAA9B;AACA3V,MAAE,mBAAF,EAAuB+V,YAAvB,CAAoC,SAApC;AACD,GAfD;;AAiBA;AACA/V,IAAE,gBAAF,EAAoB0V,KAApB;AACAR,aAAW/F,OAAX,CAAmB,UAAUgG,KAAV,EAAiB;AAClC,QAAIQ,YAAY3V,EAAE,UAAF,CAAhB;AACA2V,cAAUlE,IAAV,CAAe,OAAf,EAAwB0D,MAAMM,YAA9B;;AAEA,QAAIvF,YAAYK,UAAZ,IAA0BL,YAAYK,UAAZ,CAAuB4F,QAArD,EAA+D;AAC7D,UAAIC,iBAAiB1B,eAAexE,YAAYK,UAAZ,CAAuB4F,QAAtC,CAArB;AACAC,qBAAejH,OAAf,CAAuB,UAAUgH,QAAV,EAAoB;AACzC,YAAIA,aAAahB,MAAMM,YAAvB,EAAqC;AACnCE,oBAAUlE,IAAV,CAAe,UAAf,EAA2B,UAA3B;AACD;AACF,OAJD;AAKD;AACDkE,cAAUpM,MAAV,CAAiB4L,MAAME,KAAN,CAAY7S,YAAZ,CAAjB;AACAxC,MAAE,gBAAF,EAAoBuJ,MAApB,CAA2BoM,SAA3B;AACA3V,MAAE,gBAAF,EAAoB+V,YAApB,CAAiC,SAAjC;AACD,GAfD;AAgBD;;AAED,SAAStG,QAAT,CAAmBvP,IAAnB,EAAyB;AACvBF,IAAE,0BAAF,EAA8B0V,KAA9B;;AAEA,MAAIW,qBAAqB,EAAzB;AACA,MAAIC,eAAe,EAAnB;;AAEA,MAAIC,YAAYxY,SAAS2E,cAAT,CAAwB,yBAAxB,CAAhB;AACA,MAAIoS,YAAY5U,KAAK+O,OAAL,CAAaC,QAA7B;AACA,MAAM1M,eAAesS,UAAU,CAAV,EAAaC,SAAb,CAAuB,UAAvB,CAArB;AACAD,YAAU3F,OAAV,CAAkB,UAAUgG,KAAV,EAAiB;AACjC,QAAI,CAACA,MAAMqB,sBAAX,EAAmC;AACjC;AACD;AACD,QAAIF,aAAanB,MAAMqB,sBAAN,CAA6BhP,KAA1C,CAAJ,EAAsD;AAAE;AACtD;AACD;AACD,QAAI6N,QAAQ,EAAZ;AACAA,UAAM7S,YAAN,IAAsB2S,MAAMJ,SAAN,CAAgBvN,KAAtC;;AAEA,QAAI8N,gBAAgB;AAClBlG,YAAM+F,MAAM/F,IAAN,CAAW5H,KADC;AAElB6N,aAAOA,KAFW;AAGlBmB,8BAAwBrB,MAAMqB,sBAAN,CAA6BhP;AAHnC,KAApB;AAKA6O,uBAAmBvI,IAAnB,CAAwBwH,aAAxB;AACAgB,iBAAanB,MAAMqB,sBAAN,CAA6BhP,KAA1C,IAAmD8N,aAAnD;AACD,GAjBD;AAkBA,WAASmB,YAAT,CAAuBC,CAAvB,EAA0BC,CAA1B,EAA6B;AAC3B;AACA,QAAID,EAAEtH,IAAF,KAAW,wCAAf,EAAyD,OAAO,CAAP;AACzD,QAAIuH,EAAEvH,IAAF,KAAW,wCAAf,EAAyD,OAAO,CAAC,CAAR;;AAEzD;AACA,QAAIsH,EAAEF,sBAAF,IAA4BE,EAAEF,sBAAF,CAAyBjZ,KAAzB,CAA+B,SAA/B,CAAhC,EAA2E,OAAO,CAAP;AAC3E,QAAIoZ,EAAEH,sBAAF,IAA4BG,EAAEH,sBAAF,CAAyBjZ,KAAzB,CAA+B,SAA/B,CAAhC,EAA2E,OAAO,CAAC,CAAR;;AAE3E,QAAImZ,EAAErB,KAAF,CAAQ7S,YAAR,IAAwBmU,EAAEtB,KAAF,CAAQ7S,YAAR,CAA5B,EAAmD;AACjD,aAAO,CAAC,CAAR;AACD,KAFD,MAEO;AACL,aAAO,CAAP;AACD;AACF;AACD6T,qBAAmB/G,IAAnB,CAAwBmH,YAAxB;;AAEAJ,qBAAmBlH,OAAnB,CAA2B,UAAUgG,KAAV,EAAiB;AAC1C,QAAIQ,YAAY5X,SAAS+V,aAAT,CAAuB,QAAvB,CAAhB;AACA,QAAI8C,cAAc7Y,SAASiW,eAAT,CAAyB,OAAzB,CAAlB;AACA4C,gBAAYpP,KAAZ,GAAoB2N,MAAMqB,sBAA1B;AACAb,cAAU1B,gBAAV,CAA2B2C,WAA3B;;AAEA,QAAI1G,YAAYK,UAAZ,IAA0BL,YAAYK,UAAZ,CAAuBsG,kBAArD,EAAyE;AACvE,UAAIC,OAAOpC,eAAexE,YAAYK,UAAZ,CAAuBsG,kBAAtC,CAAX;AACAC,WAAK3H,OAAL,CAAa,UAAU4H,GAAV,EAAe;AAC1B,YAAIA,QAAQ5B,MAAMqB,sBAAlB,EAA0C;AACxC,cAAIQ,cAAcjZ,SAASiW,eAAT,CAAyB,UAAzB,CAAlB;AACA2B,oBAAU1B,gBAAV,CAA2B+C,WAA3B;AACD;AACF,OALD;AAMD;;AAED,QAAI3B,QAAQtX,SAASkZ,cAAT,CAAwB9B,MAAME,KAAN,CAAY7S,YAAZ,CAAxB,CAAZ,CAhB0C,CAgBsB;AAChEmT,cAAUlB,WAAV,CAAsBY,KAAtB;;AAEAkB,cAAU9B,WAAV,CAAsBkB,SAAtB;AACA3V,MAAE,0BAAF,EAA8B+V,YAA9B,CAA2C,SAA3C;AACD,GArBD;AAsBD;;AAED,SAAS9S,WAAT,GAAwB;AACtBhF,UAAQC,GAAR,CAAY,mBAAZ;AACA,MAAMgZ,iBAAiB,CAAE,yBAAF,EAA6B,WAA7B,EAA0C,eAA1C,EAA2D,eAA3D,CAAvB;AACA,OAAK,IAAIvJ,IAAI,CAAb,EAAgBA,IAAIuJ,eAAelK,MAAnC,EAA2CW,GAA3C,EAAgD;AAC9C,QAAIxO,KAAK+X,eAAevJ,CAAf,CAAT;AACA,QAAInG,QAAQzJ,SAAS2E,cAAT,CAAwBvD,EAAxB,EAA4BqI,KAAxC;AACA,QAAI,CAACA,KAAD,IAAU,CAACA,MAAMwF,MAArB,EAA6B;AAC3B/O,cAAQiD,KAAR,CAAc,mBAAmB/B,EAAnB,GAAwB,QAAtC;AACAoC,YAAM,4BAA4BpC,GAAGgY,OAAH,CAAW,QAAX,EAAqB,EAArB,CAA5B,GAAuD,6BAA7D;AACA,aAAO,KAAP;AACD;AACF;;AAED,MAAIjX,OAAO;AACT,YAAQ,SADC;AAET,kBAAc,EAFL;AAIT,gBAAY;AACV,cAAQ,OADE;AAEV,qBAAe,CACbkX,WAAWrZ,SAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAApD,CADa,EAEb4P,WAAWrZ,SAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAApD,CAFa;AAFL;AAJH,GAAX;;AAaA;AACA,MAAI6P,YAAYtZ,SAASuZ,oBAAT,CAA8B,OAA9B,CAAhB;AACA,MAAIC,WAAW;AACbC,UAAM,EADO,EACHC,QAAQ;AADL,GAAf;;AAIAxZ,UAAQC,GAAR,CAAYmZ,SAAZ;;AAEA,OAAK,IAAI1J,IAAI,CAAb,EAAgBA,IAAI0J,UAAUrK,MAA9B,EAAsCW,GAAtC,EAA2C;AACzC,QAAI+J,UAAUL,UAAU1J,CAAV,CAAd;AACA,QAAI+J,QAAQvQ,IAAR,KAAiB,MAArB,EAA6B;AAC3B;AACD;AACD,QAAIuQ,QAAQlQ,KAAR,IAAiBkQ,QAAQvY,EAA7B,EAAiC;AAC/BlB,cAAQC,GAAR,CAAYwZ,QAAQvY,EAAR,GAAa,IAAb,GAAoBuY,QAAQlQ,KAAxC;AACA,UAAI,SAASiJ,IAAT,CAAciH,QAAQvY,EAAtB,CAAJ,EAA+B;AAC7B,YAAIqR,MAAMkH,QAAQvY,EAAR,CAAWgY,OAAX,CAAmB,QAAnB,EAA6B,EAA7B,CAAV;AACAjX,aAAKqQ,UAAL,CAAgBC,GAAhB,IAAuBkH,QAAQlQ,KAAR,CAAcqN,IAAd,EAAvB;AACH;AACE,OAJD,MAIO,IAAI,cAAcpE,IAAd,CAAmBiH,QAAQvY,EAA3B,KAAkCuY,QAAQlO,IAAR,KAAiB,UAAvD,EAAmE;AACxE,YAAImO,KAAKD,QAAQvY,EAAR,CAAWgY,OAAX,CAAmB,MAAnB,EAA2B,EAA3B,CAAT;AACAI,iBAASC,IAAT,CAAcG,EAAd,IAAoBD,QAAQlQ,KAA5B;AACD,OAHM,MAGA,IAAI,gBAAgBiJ,IAAhB,CAAqBiH,QAAQvY,EAA7B,KAAoCuY,QAAQlO,IAAR,KAAiB,UAAzD,EAAqE;AAC1E,YAAImO,KAAKD,QAAQvY,EAAR,CAAWgY,OAAX,CAAmB,QAAnB,EAA6B,EAA7B,CAAT;AACAI,iBAASE,MAAT,CAAgBE,EAAhB,IAAsBD,QAAQlQ,KAA9B;AACD;AACF;AACF;AACDvJ,UAAQC,GAAR,CAAYqZ,QAAZ;;AAEA,OAAK,IAAIK,KAAT,IAAkBL,SAASC,IAA3B,EAAiC;AAC/B,QAAIhH,MAAM+G,SAASC,IAAT,CAAcI,KAAd,EAAqB/C,IAArB,EAAV;AACA,QAAIrE,OAAO+G,SAASE,MAAT,CAAgBG,KAAhB,CAAX,EAAmC;AAAE;AACnC1X,WAAKqQ,UAAL,CAAgBC,GAAhB,IAAuB+G,SAASE,MAAT,CAAgBG,KAAhB,EAAuB/C,IAAvB,EAAvB;AACD;AACF;;AAED;AACA,MAAIgD,aAAa9Z,SAASuZ,oBAAT,CAA8B,QAA9B,CAAjB;AACA,OAAK,IAAI3J,IAAI,CAAb,EAAgBA,IAAIkK,WAAW7K,MAA/B,EAAuCW,GAAvC,EAA4C;AAC1C,QAAI+J,UAAUG,WAAWlK,CAAX,CAAd;AACA,QAAI,SAAS8C,IAAT,CAAciH,QAAQvY,EAAtB,KAA6BuY,QAAQlQ,KAAzC,EAAgD;AAC9C,UAAIgJ,MAAMkH,QAAQvY,EAAR,CAAWgY,OAAX,CAAmB,QAAnB,EAA6B,EAA7B,CAAV;;AAEA,WAAK,IAAIW,eAAe,CAAxB,EAA2BA,eAAeJ,QAAQK,QAAR,CAAiB/K,MAA3D,EAAmE8K,cAAnE,EAAmF;AACjF,YAAIE,QAAQN,QAAQK,QAAR,CAAiBD,YAAjB,CAAZ;AACA,YAAIE,MAAMC,QAAN,KAAmB,IAAvB,EAA6B;AAC3B/X,eAAKqQ,UAAL,CAAgBC,GAAhB,IAAuB,CAACtQ,KAAKqQ,UAAL,CAAgBC,GAAhB,IAAwBtQ,KAAKqQ,UAAL,CAAgBC,GAAhB,IAAuB,GAA/C,GAAsD,EAAvD,IAA6DwH,MAAMxQ,KAA1F;AACD;AACF;AACF;AACF;;AAED;AACA,MAAI0Q,eAAena,SAASuZ,oBAAT,CAA8B,UAA9B,CAAnB;AACA,OAAK,IAAI3J,IAAI,CAAb,EAAgBA,IAAIuK,aAAalL,MAAjC,EAAyCW,GAAzC,EAA8C;AAC5C,QAAI+J,UAAUQ,aAAavK,CAAb,CAAd;AACA,QAAI,SAAS8C,IAAT,CAAciH,QAAQvY,EAAtB,KAA6BuY,QAAQlQ,KAAzC,EAAgD;AAC9C,UAAIgJ,MAAMkH,QAAQvY,EAAR,CAAWgY,OAAX,CAAmB,QAAnB,EAA6B,EAA7B,CAAV;AACAjX,WAAKqQ,UAAL,CAAgBC,GAAhB,IAAuBkH,QAAQlQ,KAAR,CAAcqN,IAAd,EAAvB;AACD;AACF;;AAED5W,UAAQC,GAAR,CAAYgC,IAAZ;;AAEA,MAAMmB,OAAOtD,SAAS2E,cAAT,CAAwB,KAAxB,EAA+B8E,KAA5C;AACA,MAAM2Q,WAAWza,KAAKC,SAAL,CAAeuC,IAAf,CAAjB;AACAjC,UAAQC,GAAR,CAAYia,QAAZ;;AAEAvW,UAAQR,iBAAR,CAA0BC,IAA1B,EAAgC8W,QAAhC,EAA0CC,kBAA1C;;AAEAra,WAAS2E,cAAT,CAAwB,SAAxB,EAAmC2N,KAAnC,CAAyCC,OAAzC,GAAmD,MAAnD;AACD;;AAED,SAAS8H,kBAAT,CAA6B/W,IAA7B,EAAmC;AACjCtD,WAAS2E,cAAT,CAAwB,KAAxB,EAA+B8E,KAA/B,GAAuCnG,IAAvC;AACArB,IAAE,qBAAF,EAAyByR,IAAzB,CAA8B,MAA9B,EAAsC7P,QAAQT,eAAR,KAA4BE,IAAlE;AACArB,IAAE,UAAF,EAAcyR,IAAd,CAAmB,MAAnB,EAA2BzR,EAAE,WAAF,EAAeyR,IAAf,CAAoB,OAApB,CAA3B;AACD;;AAED,SAASvO,WAAT,GAAwB;AACtB,MAAM7B,OAAOtD,SAAS2E,cAAT,CAAwB,KAAxB,EAA+B8E,KAA5C;;AAEA5F,UAAQH,SAAR,CAAkBJ,IAAlB,EAAwBgX,kBAAxB;;AAEAta,WAAS2E,cAAT,CAAwB,SAAxB,EAAmC2N,KAAnC,CAAyCC,OAAzC,GAAmD,OAAnD;AACD;;AAED,SAAS+H,kBAAT,CAA6BhX,IAA7B,EAAmC;AACjCpD,UAAQC,GAAR,CAAY,+BAA+BmD,IAA3C;AACD;;AAED,SAAS8B,WAAT,GAAwB;AACtB,MAAMmV,UAAUva,SAAS2E,cAAT,CAAwB,mBAAxB,EAA6C8E,KAA7D;AACA,MAAM+Q,OAAOxa,SAAS2E,cAAT,CAAwB,gBAAxB,EAA0C8E,KAAvD;AACA;AACA,MAAMgR,SAASza,SAAS2E,cAAT,CAAwB,kBAAxB,EAA4C8E,KAA3D;AACA,MAAMiR,cAAc1a,SAAS2E,cAAT,CAAwB,uBAAxB,EAAiD8E,KAArE;;AAEA,MAAIkR,cAAc,IAAlB;AACA,MAAIF,MAAJ,EAAY;AACV,QAAIC,WAAJ,EAAiB;AACfC,qBAAeD,cAAc,GAA7B;AACD;AACDC,mBAAeF,SAAS,GAAxB;AACD;AACD,MAAID,IAAJ,EAAU;AACRG,mBAAeH,OAAO,GAAtB;AACD;AACDG,iBAAeJ,OAAf;;AAEA,MAAIK,QAAQ,0CAA0CD,WAA1C,GAAwD,mDAApE;AACAza,UAAQC,GAAR,CAAYya,KAAZ;;AAEAjX,WAAS,CAAEiX,KAAF,CAAT,EAAoB,UAAUC,WAAV,EAAuB;AACzC3a,YAAQC,GAAR,CAAY0a,WAAZ;AACA,QAAIA,YAAY5L,MAAZ,KAAuB,CAA3B,EAA8B;AAC5B/O,cAAQiD,KAAR,CAAc,6CAAd;AACAK,YAAM,sBAAN;AACA;AACD;AACD,QAAIsX,SAASD,YAAY,CAAZ,CAAb;AACA,QAAIC,OAAOC,KAAP,KAAiB,UAAjB,IACAD,OAAOC,KAAP,KAAiB,SADjB,IAEAD,OAAOC,KAAP,KAAiB,MAFjB,IAGCD,OAAOC,KAAP,KAAiB,OAAjB,IAA4BD,OAAO1R,IAAP,KAAgB,OAHjD,EAII;AACFlJ,cAAQC,GAAR,CAAY,uBAAZ;AACAH,eAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDqR,OAAOhQ,GAAxD;AACA9K,eAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiDqR,OAAOjR,GAAxD;;AAEA;AACA7J,eAAS2E,cAAT,CAAwB,eAAxB,EAAyCqW,KAAzC;AACAhb,eAAS2E,cAAT,CAAwB,eAAxB,EAAyCqW,KAAzC;AACA/W,UAAIkD,MAAJ,GAAa8T,OAAb,CAAqB,IAAIrV,EAAEoC,MAAN,CAAa8S,OAAOjR,GAApB,EAAyBiR,OAAOhQ,GAAhC,CAArB,EAA2D,EAA3D;AACD,KAbD,MAaO;AACL7G,UAAIkD,MAAJ,GAAa8T,OAAb,CAAqB,IAAIrV,EAAEoC,MAAN,CAAa8S,OAAOjR,GAApB,EAAyBiR,OAAOhQ,GAAhC,CAArB,EAA2D,EAA3D;AACA5K,cAAQC,GAAR,CAAY,2BAAZ;AACAsB,iBAAW,YAAY;AAAE;AACvB+B,cAAM,iFAAN;AACAxD,iBAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiD,EAAjD;AACAzJ,iBAAS2E,cAAT,CAAwB,eAAxB,EAAyC8E,KAAzC,GAAiD,EAAjD;AACAzJ,iBAAS2E,cAAT,CAAwB,eAAxB,EAAyCqW,KAAzC;AACAhb,iBAAS2E,cAAT,CAAwB,eAAxB,EAAyCqW,KAAzC;AACD,OAND,EAMG,GANH;AAOD;AACF,GAhCD,EAgCG,UAAU7X,KAAV,EAAiB;AAClBjD,YAAQC,GAAR,CAAYgD,KAAZ;AACAK,UAAM,oCAAN;AACD,GAnCD;AAoCD;;AAED,SAASgC,QAAT,CAAmB8O,GAAnB,EAAwB;AACtB,MAAIA,MAAOA,GAAD,IAAW4G,KAAD,IAAW,IAA/B;AACA,MAAIC,OAAQ7G,IAAI8G,MAAL,GAAe9G,IAAI8G,MAAnB,GAA8B9G,IAAI+G,UAAL,GAAmB/G,IAAI+G,UAAvB,GAAoC,IAA5E;AACA,MAAK/G,IAAIgH,OAAJ,IAAe,EAAhB,IAAwBH,KAAK/R,IAAL,IAAa,MAAzC,EAAkD;AAChD,WAAO,KAAP;AACD;AACF;;AAED,SAAS1D,cAAT,GAA2B;AACzB,MAAI6V,MAAM5b,KAAKsD,KAAL,CAAWhB,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,MAAlC,EAA0ClV,IAA1C,EAAX,CAAV;AACA,MAAIqM,UAAU9J,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,UAAlC,EAA8ClV,IAA9C,EAAd;;AAEA,MAAIuC,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,iBAAlC,EAAqDlV,IAArD,MAA+D,QAAnE,EAA4E;AAC1E,QAAIyC,OAAO;AACTsJ,YAAMxJ,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,OAAlC,EAA2CC,GAA3C,EADG;AAETV,mBAAalS,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,OAAlC,EAA2CC,GAA3C,EAFJ;AAGT2G,mBAAa,IAAIvN,IAAJ,GAAWwN,WAAX;AAHJ,KAAX;AAKA,QAAI5b,MAAM6b,cAAN,EAAJ,EAA2B;AACzBxJ,aAAO5G,kBAAP,CAA0BnJ,IAA1B,EAAgCtC,MAAM6b,cAAN,EAAhC,EAAwD,YAAU;AAChEzZ,UAAE,kBAAF,EAAsBwT,KAAtB,CAA4B,QAA5B;AACD,OAFD;AAGD,KAJD,MAIK;AACHjS,YAAM,qBAAN;AACD;AACF,GAbD,MAaM,IAAIvB,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,iBAAlC,EAAqDlV,IAArD,MAA+D,QAAnE,EAA4E;AAChF,QAAIic,kBAAkB,KAAtB;AACA,QAAIxZ,OAAOxC,KAAKsD,KAAL,CAAWhB,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,WAAlC,EAA+ClV,IAA/C,EAAX,CAAX;AACA,QAAIkc,YAAY3Z,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,OAAlC,EAA2CC,GAA3C,EAAhB;AACA,QAAI1S,KAAKsJ,IAAL,IAAamQ,SAAjB,EAA2B;AACzBzZ,WAAKsJ,IAAL,GAAYmQ,SAAZ;AACD;AACD,QAAIC,mBAAmB5Z,EAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,cAAlC,EAAkDC,GAAlD,EAAvB;AACA,QAAI1S,KAAKgS,WAAL,IAAoB0H,gBAAxB,EAAyC;AACvC1Z,WAAKgS,WAAL,GAAmB0H,gBAAnB;AACD;AACD3J,WAAOlG,eAAP,CAAuBD,OAAvB,EAAgC5J,IAAhC,EAAsCtC,MAAM6b,cAAN,EAAtC,EAA8D,YAAU;AACtEzZ,QAAE,kBAAF,EAAsBwT,KAAtB,CAA4B,QAA5B;AACD,KAFD;AAGD;AAEF;;AAED,SAAShQ,gBAAT,GAA6B;AAC3BxD,IAAE,kBAAF,EAAsBwT,KAAtB,CAA4B,QAA5B;AACD;;AAED,SAASpQ,aAAT,GAAwB;;AAEtBxF,QAAM8U,gBAAN;;AAEAzU,UAAQC,GAAR,CAAY,yBAAZ;AACA8B,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,iBAAlC,EAAqDlV,IAArD,CAA0D,QAA1D;AACAuC,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,MAAlC,EAA0ClV,IAA1C,CAA+CC,KAAKC,SAAL,CAAeuS,WAAf,CAA/C;AACAlQ,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,OAAlC,EAA2CC,GAA3C,CAA+C,EAA/C;AACA5S,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,cAAlC,EAAkDC,GAAlD,CAAsD,EAAtD;AACA5S,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,KAAlC,EAAyCkH,IAAzC;AACA7Z,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,WAAlC,EAA+ClV,IAA/C,CAAoD,EAApD;AACAuC,IAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,gBAAlC,EAAoDhB,IAApD,CAAyD,EAAzD;;AAEA5T,WAAS2E,cAAT,CAAwB,aAAxB,EAAuC1E,gBAAvC,CAAwD,QAAxD,EAAkEJ,MAAMkV,gBAAxE,EAA0F,KAA1F;AACD;;AAED,SAASzP,iBAAT,GAA4B;AAC1BxB,UAAQjC,WAAR,CAAoB,gBAAQ;AAC1BI,MAAE,cAAF,EAAkBvC,IAAlB,CAAuB,QAAvB;AACAuC,MAAE,cAAF,EAAkByR,IAAlB,CAAuB,MAAvB,EAA8B,GAA9B;AACAzR,MAAE,OAAF,EAAW8Z,UAAX,CAAsB,UAAtB;AACD,GAJD,EAIE,YAAM;AACN9Z,MAAE,cAAF,EAAkBvC,IAAlB,CAAuB,OAAvB;AACAuC,MAAE,cAAF,EAAkByR,IAAlB,CAAuB,MAAvB,EAA8B5P,QAAQvD,eAAR,EAA9B;AACA0B,MAAE,OAAF,EAAWyR,IAAX,CAAgB,UAAhB,EAA2B,UAA3B;AACD,GARD;AASD;;AAEDpV,OAAOC,OAAP,GAAiB;AACfuG,YAAUA,QADK;AAEfC,uBAAqBA,mBAFN;AAGfF,kBAAgBA,cAHD;AAIf8M,sBAAoBA,kBAJL;AAKfD,YAAUA,QALK;AAMfzN,OAAKA,GANU;AAOfiB,eAAaA,WAPE;AAQfC,eAAaA,WARE;AASfC,eAAaA,WATE;AAUfI,YAAUA,QAVK;AAWfE,kBAAeA,cAXA;AAYfD,oBAAkBA,gBAZH;AAafJ,iBAAeA,aAbA;AAcfC,qBAAmBA;AAdJ,CAAjB;;;;;;AChpBA;;;;;;;;;;;;AAYA,IAAMzF,QAAQZ,QAAQ,YAAR,CAAd;;AAEA,IAAMoB,WAAWR,MAAMS,OAAN,GAAgB,SAAjC;;AAEA;AACA,SAAS0b,eAAT,GAA4B;AAC1B,SAAO3b,QAAP;AACD;;AAED;;;;;;;AAOA,SAAS4b,OAAT,CAAkBC,MAAlB,EAAyBzZ,QAAzB,EAAmC;AACjC,MAAI,CAACyZ,MAAL,EAAY;AACVhc,YAAQC,GAAR,CAAY,0BAAZ;AACA,WAAO,KAAP;AACD;;AAED,MAAIuC,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+BtC,WAAW6b,MAA1C,CAAV;AACAxZ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ;;AAEAJ,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAED;;;;;;;AAOA,SAASyZ,UAAT,CAAqBD,MAArB,EAA4B/Z,IAA5B,EAAiCM,QAAjC,EAA2C;AACzC,MAAI,CAACyZ,MAAL,EAAY;AACVhc,YAAQC,GAAR,CAAY,6BAAZ;AACA,WAAO,KAAP;AACD;;AAED,MAAI,CAACgC,IAAL,EAAU;AACRjC,YAAQC,GAAR,CAAY,2BAAZ;AACA,WAAO,KAAP;AACD;;AAED,MAAIuC,MAAM7C,MAAM8C,iBAAN,CAAwB,KAAxB,EAA+BtC,WAAW6b,MAA1C,CAAV;AACAxZ,MAAIE,gBAAJ,CAAqB,cAArB,EAAqC,kBAArC;AACAF,MAAIG,eAAJ,GAAsB,IAAtB;AACAH,MAAII,IAAJ,CAASX,IAAT;;AAEAO,MAAIK,kBAAJ,GAAyB,YAAY;AACnC,QAAIL,IAAIM,UAAJ,KAAmB,CAAvB,EAA0B;AACxB,UAAIN,IAAIjD,MAAJ,KAAe,GAAnB,EAAwB;AACtBgD,iBAAS9C,KAAKsD,KAAL,CAAWP,IAAIQ,YAAf,CAAT;AACD,OAFD,MAEO;AACLhD,gBAAQiD,KAAR,CAAcT,GAAd;AACD;AACF;AACF,GARD;AASD;;AAEDpE,OAAOC,OAAP,GAAiB;AACfyd,mBAAiBA,eADF;AAEfC,WAASA;AAFM,CAAjB;;;;;;ACpFA,IAAIG,WAAJ;;AAEA,IAAM9b,UAAU+b,wBAAwB,aAAxB,GAAwCA,mBAAxC,GAA8D,EAA9E;AACA;;;;;;;;;;;;;;;;AAgBA,SAAS1Z,iBAAT,CAA4BrD,MAA5B,EAAoCC,GAApC,EAAyC;AACvC;AACA,MAAImD,MAAM,IAAI4Z,cAAJ,EAAV;AACA,MAAI,qBAAqB5Z,GAAzB,EAA8B;AAC5B;AACA;AACAA,QAAI6Z,IAAJ,CAASjd,MAAT,EAAiBC,GAAjB,EAAsB,IAAtB;AACD,GAJD,MAIO,IAAI,OAAOid,cAAP,KAA0B,WAA9B,EAA2C;AAChD;AACA;AACA9Z,UAAM,IAAI8Z,cAAJ,EAAN;AACA9Z,QAAI6Z,IAAJ,CAASjd,MAAT,EAAiBC,GAAjB;AACD,GALM,MAKA;AACL;AACAmD,UAAM,IAAN;AACD;AACD,SAAOA,GAAP;AACD;;AAED,SAAS4B,UAAT,GAAuB;AACrB,MAAImY,OAAO,EAAX;AACA,MAAIC,QAAQxY,OAAOyY,QAAP,CAAgBtS,IAAhB,CAAqB+O,OAArB,CAA6B,yBAA7B,EAAwD,UAAUwD,CAAV,EAAanK,GAAb,EAAkBhJ,KAAlB,EAAyB;AAC3FgT,SAAKhK,GAAL,IAAYhJ,MAAM2P,OAAN,CAAc,MAAd,EAAsB,EAAtB,CAAZ;AACD,GAFW,CAAZ;AAGA,SAAOqD,IAAP;AACD;;AAED,SAASI,UAAT,CAAoBtd,GAApB,EAAwB;AACtB,MAAIud,MAAM,+BAAV;AACA,SAAOA,IAAIC,IAAJ,CAASxd,GAAT,EAAc,CAAd,CAAP;AACD;;AAED,SAASyd,YAAT,GAAwB;AACpB,MAAIC,IAAI,IAAIhP,IAAJ,GAAWC,OAAX,EAAR;AACA,MAAI5K,OAAO,uCAAuC8V,OAAvC,CAA+C,OAA/C,EAAwD,UAAS8D,CAAT,EAAY;AAC3E,QAAIC,IAAI,CAACF,IAAIG,KAAKC,MAAL,KAAc,EAAnB,IAAuB,EAAvB,GAA4B,CAApC;AACAJ,QAAIG,KAAKE,KAAL,CAAWL,IAAE,EAAb,CAAJ;AACA,WAAO,CAACC,KAAG,GAAH,GAASC,CAAT,GAAcA,IAAE,GAAF,GAAM,GAArB,EAA2BI,QAA3B,CAAoC,EAApC,CAAP;AACH,GAJU,CAAX;AAKA,SAAOja,IAAP;AACH;;AAED,SAASyR,gBAAT,CAA0BT,GAA1B,EAA8B7R,QAA9B,EAAwC;AACtC,MAAI+a,QAAQlJ,IAAI8G,MAAJ,CAAWoC,KAAvB;AACA,MAAIC,SAAS,IAAIC,UAAJ,EAAb;;AAEAD,SAAOE,MAAP,GAAgB,UAASzC,KAAT,EAAgB;AAC9B,QAAIvP,WAAWuP,MAAME,MAAN,CAAaN,MAA5B;AACAsB,kBAAc;AACZ3Q,YAAM+R,MAAM,CAAN,EAAS/R,IADH;AAEZrC,YAAMoU,MAAM,CAAN,EAASpU,IAFH;AAGZuC,gBAAUA;AAHE,KAAd;AAKA1J,MAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,KAAlC,EAAyClB,IAAzC,CAA8C,KAA9C,EAAqD/H,QAArD;AACA1J,MAAE,yBAAF,EAA6B2S,IAA7B,CAAkC,KAAlC,EAAyCE,IAAzC;AACD,GATD;;AAWA2I,SAAOG,OAAP,GAAiB,UAAS1C,KAAT,EAAgB;AAC/Bhb,YAAQiD,KAAR,CAAc,kCAAkC+X,MAAME,MAAN,CAAajY,KAAb,CAAmB0a,IAAnE;AACA7Z,OAAGoY,WAAH,GAAiB5I,SAAjB;AACD,GAHD;;AAKA,MAAIsK,SAAS;AACXC,YAAS,CAAC,WAAD,EAAc,YAAd;AADE,GAAb;;AAIA,MAAIC,IAAJ;;AAEA,OAAK,IAAIpO,IAAI,CAAb,EAAgBA,IAAI4N,MAAMvO,MAA1B,EAAkCW,GAAlC,EAAuC;AACrCoO,WAAOR,MAAM5N,CAAN,CAAP;;AAEA,QAAIoO,SAAS,IAAb,EAAmB;AACjB,UAAIF,OAAOC,MAAP,CAAcjO,OAAd,CAAsBkO,KAAK5U,IAA3B,IAAmC,CAAC,CAAxC,EAA2C;AACzCqU,eAAOQ,aAAP,CAAqBD,IAArB;AACD;AACF;AACF;AACF;;AAED,SAAStC,cAAT,GAAyB;AACvB,SAAOU,WAAP;AACD;;AAED,SAASzH,gBAAT,GAA2B;AACzByH,gBAAc5I,SAAd;AACD;;AAED,SAAS0K,SAAT,CAAmBC,KAAnB,EAA0B;AACtB,MAAI1S,OAAO0S,QAAQ,GAAnB;AACA,MAAIC,gBAAgBC,mBAAmBre,SAASse,MAA5B,CAApB;AACA,MAAIC,KAAKH,cAAc5T,KAAd,CAAoB,GAApB,CAAT;AACA,OAAI,IAAIoF,IAAI,CAAZ,EAAeA,IAAG2O,GAAGtP,MAArB,EAA6BW,GAA7B,EAAkC;AAC9B,QAAIsN,IAAIqB,GAAG3O,CAAH,CAAR;AACA,WAAOsN,EAAEsB,MAAF,CAAS,CAAT,KAAe,GAAtB,EAA2B;AACvBtB,UAAIA,EAAEuB,SAAF,CAAY,CAAZ,CAAJ;AACH;AACD,QAAIvB,EAAEpN,OAAF,CAAUrE,IAAV,KAAmB,CAAvB,EAA0B;AACtB,aAAOyR,EAAEuB,SAAF,CAAYhT,KAAKwD,MAAjB,EAAyBiO,EAAEjO,MAA3B,CAAP;AACH;AACJ;AACD,SAAO,EAAP;AACH;;AAED,SAASnP,SAAT,CAAmBqe,KAAnB,EAA0BO,MAA1B,EAAkCC,MAAlC,EAA0C;AACtC,MAAI1B,IAAI,IAAIhP,IAAJ,EAAR;AACAgP,IAAE2B,OAAF,CAAU3B,EAAE/O,OAAF,KAAeyQ,SAAO,EAAP,GAAU,EAAV,GAAa,EAAb,GAAgB,IAAzC;AACA,MAAIrd,UAAU,aAAY2b,EAAE4B,WAAF,EAA1B;AACA7e,WAASse,MAAT,GAAkBH,QAAQ,GAAR,GAAcO,MAAd,GAAuB,GAAvB,GAA6Bpd,OAA7B,GAAuC,SAAzD;AACH;;AAEDhD,OAAOC,OAAP,GAAiB;AACfoE,qBAAmBA,iBADJ;AAEf2B,cAAYA,UAFG;AAGfuY,cAAYA,UAHG;AAIfG,gBAAcA,YAJC;AAKfjI,oBAAkBA,gBALH;AAMf2G,kBAAgBA,cAND;AAOfpb,WAASA,OAPM;AAQfqU,oBAAkBA,gBARH;AASfuJ,aAAWA,SATI;AAUfpe,aAAWA;AAVI,CAAjB","file":"public/app.js","sourcesContent":["module.exports = {\n  listOfMediaFilesForPOI: [\n    {\n      \"id\": \"d07d6ab3-4e3f-44ce-accc-b3efc96b3f04\",\n      \"ipfs\": \"QmVXmy59f5QqKDGyhpHbRiGnba5SfHaooDPCWhd8Xtgwz2\",\n      \"url\": \"https://ipfs.io/images/ipfs-illustration-history.svg\",\n      \"mimetype\": \"image/jpeg\",\n      \"name\": \"Chaotic connectome replacement image for the large image on the main screen\",\n      \"description\": \"some description\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\"\n    },\n    {\n      \"id\": \"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060\",\n      \"mimetype\": \"image/png\",\n      \"name\": \"Transformap Base\",\n      \"url\": \"https://base.transformap.co/images/transformap.png\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\"\n    }\n  ],\n  mediaFileMetadataBasic: {\n    \"name\": \"some title\",\n    \"description\": \"some description\",\n    \"mimetype\": \"image/png\",\n    \"url\": \"https://base.transformap.co/images/transformap.png\",\n  },\n  mediaFileMetadataComplete: {\n    \"id\": \"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060\",\n    \"name\": \"some title\",\n    \"description\": \"some description\",\n    \"mimetype\": \"image/png\",\n    \"url\": \"https://base.transformap.co/images/transformap.png\",\n    \"version_date\": \"2017-07-30T16:01:34+00:00\"\n  },\n  mediaFileMetadataCompleteDeleted: {\n    \"id\": \"0a6afb5c-70b1-40f7-8f46-8dd7e0d94060\",\n    \"name\": \"some title\",\n    \"deleted\": true,\n    \"description\": \"some description\",\n    \"mimetype\": \"image/png\",\n    \"url\": \"https://base.transformap.co/images/transformap.png\",\n    \"version_date\": \"2017-07-30T16:01:34+00:00\"\n  },\n  placeMetadata: {\n    \"type\":\"Feature\",\n    \"properties\":{\n      \"name\":\"Bulgarian Food Bank\",\n      \"addr:country\":\"BG\",\n      \"addr:street\":\"бул. Васил Левски\",\n      \"addr:housenumber\":\"106\",\n      \"addr:postcode\":\"1000\",\n      \"addr:city\":\"София\",\n      \"POI_TYPE\":\"food bank\",\n      \"amenity\":\"social_facility\",\n      \"description:bg\":\"Организацията работи като свързващо звено между хранителната индустрия и социалните организации, за да увеличи многократно достъпа до хранително подпомагане в България. Тя създава системи за сигурност и контрол на храните, които постъпват като дарения.\",\n      \"website\":\"http://bgfoodbank.org\",\n      \"contact:email\":\"contact@bgfoodbank.org\",\n      \"organic\":\"no\",\n      \"fair-trade\":\"no\",\n      \"regional\":\"yes\",\n      \"free_keywords\":\"food bank;food waste\",\n      \"SSEDAS_PARTNER\":\"BILS\",\n      \"description\":\"The organisation acts as an interface between the food industry and social welfare organisations to increase access to food aid in Bulgaria. It sets up routines for guaranteeing that donated food is safe and properly managed.\",\n      \"type_of_initiative\":\"foodbank; recycling_foodwaste\",\n      \"contact:phone\":\"+3592 953 4100\",\n      \"social_facility\":\"food_bank\",\n      \"media_files\": [\n        \"6abf3336-4441-458f-a24f-ed76f7f53533\"\n      ]\n    },\n    \"geometry\":{\n      \"type\":\"Point\",\n      \"coordinates\":[23.33513259888,42.69809702239]\n    },\n    \"_id\":\"2c10b95ea433712f0b06a3f7d310e7d5\"\n  },\n  listOfMediaFileVersions: [\n    {\n      \"id\": \"497123c0-f9d8-4e6c-acff-76ec9efcb265\",\n      \"name\": \"other version of the same file\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\",\n      \"mimetype\": \"image.png\",\n      \"active\": true,\n      \"url\": \"https://base.transformap.co/images/transformap.png\",\n      \"author\": \"alex\"\n    },\n    {\n      \"id\": \"c29c8d11-ec27-4fe1-9a23-dd10a3b37e11\",\n      \"name\": \"yet another version\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\",\n      \"mimetype\": \"image.png\",\n      \"url\": \"https://base.transformap.co/images/transformap.png\",\n      \"author\": \"jenny\"\n    }\n  ],\n  listOfMediaFileVersionsUpdate: [\n    {\n      \"name\": \"other version of the same file\",\n      \"description\": \"a new description for the same file\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\",\n      \"mimetype\": \"image.png\",\n      \"url\": \"https://base.transformap.co/images/transformap.png\"\n    },\n    {\n      \"id\": \"497123c0-f9d8-4e6c-acff-76ec9efcb265\",\n      \"name\": \"a previous version of the same file\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\",\n      \"mimetype\": \"image.png\",\n      \"url\": \"https://base.transformap.co/images/transformap.png\"\n    },\n    {\n      \"id\": \"c29c8d11-ec27-4fe1-9a23-dd10a3b37e11\",\n      \"name\": \"yet another previous version\",\n      \"version_date\": \"2017-07-30T16:01:34+00:00\",\n      \"mimetype\": \"image.png\",\n      \"url\": \"https://base.transformap.co/images/transformap.png\"\n    }\n  ],\n  user: {\n    \"name\": \"Joe\",\n    \"email\": \"joe@domain.com\"\n  }\n};\n","var fixtures = require('./fixtures.js')\n\nxhook.after(function(request, response) {\n\n  if (request.method === \"GET\"){\n\n    // /place/{uuid}\n    if(request.url.match(\".*?/place/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.placeMetadata);\n    }\n\n    // /place/{uuid}/media\n    if(request.url.match(\".*?/place/(.*)/media\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.listOfMediaFilesForPOI);\n    }\n\n    // /media/{uuid}\n    if(request.url.match(\".*?/media/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.mediaFileMetadataComplete);\n    }\n\n    // /media/{uuid}/versions\n    if(request.url.match(\".*?/media/(.*)/versions\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.listOfMediaFileVersions);\n    }\n\n    // /auth/\n    if(request.url.match(\".*?/auth/\")){\n      response.status = 200;\n      utils.setCookie(\"connect.sid\",\"123456789\");\n    }\n\n    // /users/{userId}\n    if(request.url.match(\".*?/users/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.user);\n    }\n\n  }else if (request.method === \"POST\"){\n\n    // /media\n    if(request.url.match(\".*?/media/\")){\n      response.status = 201;\n      response.text = JSON.stringify(fixtures.mediaFileMetadataComplete);\n    }\n\n    // /media\n    if(request.url.match(\".*?/media/(.*)/versions\")){\n      response.status = 201;\n      response.text = JSON.stringify(fixtures.listOfMediaFileVersionsUpdate);\n    }\n\n    // /place\n    if(request.url.match(\".*?/place/\")){\n      //TBD\n    }\n\n  }else if (request.method === \"PUT\"){\n\n    // /media/{uuid}\n    if(request.url.match(\".*?/media/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.mediaFileMetadataComplete);\n    }\n\n    // /place/{uuid}\n    if(request.url.match(\".*?/place/(.*)\")){\n      response.status = 200;\n      //TBD\n    }\n\n    // /users/{userId}\n    if(request.url.match(\".*?/users/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.user);\n    }\n\n  }else if (request.method === \"DELETE\"){\n\n    // /place/{uuid}\n    if(request.url.match(\".*?/place/(.*)\")){\n      response.status = 200;\n      //TBD\n    }\n\n    // /media/{uuid}\n    if(request.url.match(\".*?/place/(.*)/media/(.*)\")){\n      response.status = 200;\n      response.text = JSON.stringify(fixtures.placeMetadata);\n    }\n\n    // /auth/{token}\n    if(request.url.match(\".*?/auth/(.*)\")){\n      response.status = 200;\n    }\n  }\n\n});\n","const editor = require('lib/editor')\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  // do your setup here\n  editor();\n  console.log('Initialized app');\n})\n","/*\n * This library handles calls to the authorization RP api for the transformap editor\n *\n * Fri  21 Jul 14:30:00 UTC+1 2017\n * Alex Corbi (alexcorbi@posteo.net), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\nimport * as Cookies from \"js-cookie\";\n\nconst utils = require('./utils.js');\n\nconst endpoint = utils.baseUrl + '/auth/';\n\n/* returns the API's endpoint */\nfunction getAuthEndpoint () {\n  return endpoint;\n}\n\n/* taken \"a bit\" of inspiration from https://github.com/hackmdio/hackmd/blob/master/public/js/lib/common/login.js#L47 */\n\nlet checkAuth = false\nlet profile = null\nlet lastLoginState = getLoginState()\nlet lastUserId = getUserId()\nvar loginStateChangeEvent = null\n\nfunction setloginStateChangeEvent (func) {\n  loginStateChangeEvent = func\n}\n\nfunction resetCheckAuth () {\n  checkAuth = false\n}\n\nfunction setLoginState (bool, id) {\n  Cookies.set('loginstate', bool, {\n    expires: 365\n  })\n  if (id) {\n    Cookies.set('userid', id, {\n      expires: 365\n    })\n  } else {\n    Cookies.remove('userid')\n  }\n  lastLoginState = bool\n  lastUserId = id\n  checkLoginStateChanged()\n}\n\nfunction checkLoginStateChanged () {\n  if (getLoginState() !== lastLoginState || getUserId() !== lastUserId) {\n    if (loginStateChangeEvent) setTimeout(loginStateChangeEvent, 100)\n    return true\n  } else {\n    return false\n  }\n}\n\nfunction getLoginState () {\n  const state = Cookies.get('loginstate')\n  return state === 'true' || state === true\n}\n\nfunction getUserId () {\n  return Cookies.get('userid')\n}\n\nfunction clearLoginState () {\n  Cookies.remove('loginstate')\n}\n\nfunction checkIfAuth (yesCallback, noCallback) {\n  const cookieLoginState = getLoginState()\n  if (checkLoginStateChanged()) checkAuth = false\n  if (!checkAuth || typeof cookieLoginState === 'undefined') {\n    $.get(`${utils.baseUrl}/user`)\n            .done(data => {\n              if (data && data._id === true) {\n                profile = data\n                yesCallback(profile)\n                setLoginState(true, data._id)\n              } else {\n                noCallback()\n                setLoginState(false)\n              }\n            })\n            .fail(() => {\n              noCallback()\n            })\n            .always(() => {\n              checkAuth = true\n            })\n  } else if (cookieLoginState) {\n    yesCallback(profile)\n  } else {\n    noCallback()\n  }\n}\n\n/*\n * Decouples the auth token from the current session\n * Params:\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction logout (authToken,callback) {\n  if (!authToken){\n    console.log('logout: no authToken given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('GET', endpoint);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\nmodule.exports = {\n  checkIfAuth: checkIfAuth,\n  clearLoginState: clearLoginState,\n  getUserId: getUserId,\n  getLoginState: getLoginState,\n  checkLoginStateChanged: checkLoginStateChanged,\n  setLoginState: setLoginState,\n  resetCheckAuth: resetCheckAuth,\n  setloginStateChangeEvent: setloginStateChangeEvent,\n  getAuthEndpoint: getAuthEndpoint,\n  logout: logout\n};\n","/*\n * This library handles calls to the transformap data api for the transformap editor\n *\n * Fri  21 Jul 14:30:00 UTC+1 2017\n * Alex Corbi (alexcorbi@posteo.net), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\nconst utils = require('./utils.js');\n\nconst endpoint = utils.baseUrl + '/place/';\n\n/* returns the API's endpoint */\nfunction getDataEndpoint () {\n  return endpoint;\n}\n\n/*\n * Creates (if uuid is not set) or updates (if it is) a POI with the data passed as parameter\n * Params:\n *  - uuid: POI's uuid, null if does not exist\n *  - data: to create or update POI\n *  - callback: function to be called upon success. Receives the uuid of the POI\n * Returns: false if invalid call\n*/\nfunction createOrUpdatePOI (uuid, data, callback) {\n  if (!data) {\n    console.error('updateOrCreatePOI: no data given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest(uuid ? 'PUT' : 'POST', endpoint + uuid);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send(data);\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        var retJson = JSON.parse(xhr.responseText);\n        console.log(retJson);\n        if (retJson.id) {\n          callback(retJson.id);\n          alert('Save successful');\n        } else {\n          alert('Error: something wrent wrong on saving: ' + JSON.stringify(retJson));\n        }\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Gets the metadata of a certain POI\n * Params:\n *  - uuid: POI's uuid\n *  - data: to create or update POI\n *  - callback: function to be called upon success. Receives the uuid of the POI\n * Returns: false if invalid call\n*/\nfunction getPOI (uuid, callback) {\n  if (!uuid) {\n    console.error('getPOI: no uuid given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('GET', getDataEndpoint() + uuid);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n\n/*\n * Deletes the POI corresponding to the uuid passed as parameter\n * Params:\n *  - uuid: POI's uuid, null if does not exist\n *  - callback: function to be called upon success. Receives the uuid of the POI\n * Returns: false if invalid call\n*/\nfunction deletePOI (uuid, callback) {\n  if (!uuid) {\n    console.error('deletePOI: no uuid given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('DELETE', endpoint + uuid);\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(uuid);\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\nmodule.exports = {\n  getDataEndpoint: getDataEndpoint,\n  createOrUpdatePOI: createOrUpdatePOI,\n  getPOI: getPOI,\n  deletePOI: deletePOI\n};\n","/* global alert, L, XMLHttpRequest, XDomainRequest */ // used by standardjs (linter)\n\nconst utils = require('./utils.js');\nconst redFetch = require('./red_fetch.js');\nconst translations = require('./translations.js');\nconst dataApi = require('./data_api.js');\nconst authApi = require('./auth_api.js');\nconst userApi = require('./user_api.js');\nconst ui = require('./ui.js');\nconst map = require('./map.js');\n\nwindow.translations = translations\nconst taxonomyTranslationsUrls = [ 'https://base.transformap.co/wiki/Special:EntityData/Q5.json', 'https://raw.githubusercontent.com/TransforMap/transformap-viewer/Q5-fallback.json' ];\n\nif ($ENVSTATIC_MOCK_AJAX === \"true\"){\n  console.log(\"integrating xhook and mocking ajax calls\");\n  require('xhook');\n  require('../fixtures/intercept_ajax.js');\n}\n\nmodule.exports = function () {\n  console.log('editor initialize start');\n\n  const place = utils.getUrlVars()['place'];\n\n  var startLang = translations.selectAllowedLang(translations.current_lang);\n  console.log('lang on start: ' + startLang);\n  console.log(translations.supported_languages);\n\n  document.getElementById('plus').onclick = ui.addFreeTagsRow;\n\n  if (place) {\n    dataApi.getPOI(place,ui.fillForm);\n  }\n\n  ui.addLanguageSwitcher();\n  translations.fetchAndSetNewTranslation = translations.fetchAndSetNewTranslation;\n\n  redFetch(taxonomyTranslationsUrls,\n    translations.initializeTranslatedTOIs,\n    function (error) {\n      console.error('none of the lang init data urls available');\n    });\n\n  document.getElementById('save').onclick = ui.clickSubmit;\n  document.getElementById('delete').onclick = ui.clickDelete;\n  document.getElementById('coordsearch').onclick = ui.clickSearch;\n  document.getElementById('newmedia').onclick = ui.clickNewMedia;\n  document.getElementById('loginbutton').onclick = ui.toggleLoginButton;\n  document.onkeypress = ui.stopRKey;\n  document.getElementById('mediacancel').onclick = ui.clickMediaCancel;\n  document.getElementById('mediasave').onclick = ui.clickMediaSave;\n\n  ui.toggleLoginButton();\n\n  map.initMap();\n\n  console.log('editor initialize end');\n  \n};\n","const L = require('leaflet');\nconst L_Hash = require('leaflet-hash');\nconst L_Draw = require('leaflet-draw');\n\nvar map;\n\nvar editableLayers;\nvar drawControl;\nvar placeMarker;\nvar popupText = 'Press the edit button to move me. <img style=\"width:30px;height:30px;background-position:-150px -1px;background-image:url(\\'images/spritesheet.svg\\');background-size: 270px 30px;\"> <br><br> Find it on the bottom left corner of the map.';\nfunction getDrawControl (allowNewMarker) {\n  var markerValue = allowNewMarker ? { icon: new placeMarker() } : false;\n  var options = {\n    position: 'bottomleft',\n    draw: {\n      polyline: false,\n      polygon: false,\n      rectangle: false,\n      circle: false,\n      marker: markerValue\n    },\n    edit: {\n      featureGroup: editableLayers, // REQUIRED!!\n      remove: false\n    }\n  };\n  return new L.Control.Draw(options);\n}\n\nfunction getMap () {\n  return map;\n}\n\nfunction initMap () {\n  console.log('initMap start');\n\n  var attrOsm = 'Map data by <a href=\"https://openstreetmap.org\">OpenStreetMap</a> contributors, under <a href=\"https://www.openstreetmap.org/copyright\">ODbL</a>. ';\n  var attrPois = 'POIs by <a href=\"http://solidariteconomy.eu\">SUSY</a>, <a href=\"https://creativecommons.org/publicdomain/zero/1.0/\">CC-0</a>. ';\n  var leafletBgMaps;\n  var zoom;\n  var defaultlayer;\n  var center;\n  var baseMaps = {};\n\n  baseMaps['mapnik'] = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n    attribution: attrOsm + attrPois,\n    maxZoom: 19,\n    noWrap: true\n  });\n  baseMaps['stamen_terrain'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  });\n  baseMaps['stamen_terrain_bg'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  });\n  baseMaps['hot'] = new L.tileLayer('http://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png', {\n    attribution: 'Tiles courtesy of <a href=\"http://hot.openstreetmap.org/\">Humanitarian OpenStreetMap Team</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 20,\n    noWrap: true\n  });\n\n  if (!leafletBgMaps) {\n    leafletBgMaps = {\n      'Stamen - Terrain': baseMaps['stamen_terrain'],\n      'Stamen - Terrain Background': baseMaps['stamen_terrain_bg'],\n      'OpenStreetMap - Mapnik': baseMaps['mapnik'],\n      'Humanitarian OpenStreetMap ': baseMaps['hot']\n    };\n  }\n  if (!defaultlayer) {\n    defaultlayer = baseMaps['mapnik'];\n  }\n\n  map = L.map('map', {\n    zoomControl: true,\n    center: center || new L.LatLng(28.6, 9),\n    zoom: zoom || 2,\n    layers: defaultlayer\n  });\n\n  const ctrl = new L.Control.Layers(leafletBgMaps);\n  map.addControl(ctrl);\n  var hash = new L.Hash(map); // Leaflet persistent Url Hash function\n\n  // leaflet draw\n  editableLayers = new L.FeatureGroup();\n  map.addLayer(editableLayers);\n  placeMarker = L.Icon.extend({\n    options: {\n      shadowUrl: null,\n      iconAnchor: new L.Point(12, 40),\n      iconSize: new L.Point(25, 40),\n      iconUrl: 'marker-green.png'\n    }\n  });\n\n  map.on(L.Draw.Event.CREATED, function (e) {\n    var type = e.layerType;\n    var layer = e.layer;\n\n    if (type === 'marker') {\n      layer.bindPopup(popupText);\n    }\n\n    editableLayers.addLayer(layer);\n    map.my_current_marker = layer;\n    document.getElementById('_geometry_lon').value = layer._latlng.lng.toFixed(6);\n    document.getElementById('_geometry_lat').value = layer._latlng.lat.toFixed(6);\n\n    map.removeControl(map.my_drawControl);\n    map.my_drawControl = getDrawControl(false); // deactivate \"add marker\" after the 1st one\n    map.addControl(map.my_drawControl);\n      // fixme instantly enable 'edit' mode of layer\n  });\n\n  map.on('draw:editmove', function (e) {\n    console.log('editmove');\n    console.log(e);\n    document.getElementById('_geometry_lon').value = e.layer._latlng.lng.toFixed(6);\n    document.getElementById('_geometry_lat').value = e.layer._latlng.lat.toFixed(6);\n  });\n\n  map.on('moveend', function(e){\n    var centre = map.getCenter();\n    var targetlocation = '#' + map.getZoom() + '/' + centre.lat + '/' + centre.lng;\n\n    var maplink = document.getElementById('gotomap');\n    var href = maplink.getAttribute('href');\n    var splitstr = href.split('#');\n    href = maplink.getAttribute('href').split('#')[0] + targetlocation;\n    maplink.setAttribute('href', href);\n\n    var newlink = document.getElementById('newbutton');\n    newlink.setAttribute('href', './' + targetlocation);\n  });\n\n  map.my_editableLayers = editableLayers;\n // map.my_drawControl = drawControl\n  map.my_placeMarker = placeMarker;\n  map.getDrawControl = getDrawControl;\n\n  map.updateMarkerFromForm = function () {\n    const lat = document.getElementById('_geometry_lat').value;\n    const lon = document.getElementById('_geometry_lon').value;\n    console.log('new lat: ' + lat + ' lon: ' + lon);\n\n    if (lat && lon) {\n      const coords = L.latLng(lat, lon);\n      if (map.my_current_marker) {\n        map.my_current_marker.setLatLng(coords);\n      } else {\n        map.my_current_marker = new L.marker([lat, lon], { icon: new map.my_placeMarker() });\n        map.my_current_marker.bindPopup(popupText);\n        map.my_editableLayers.addLayer(map.my_current_marker);\n        map.removeControl(map.my_drawControl);\n        map.my_drawControl = getDrawControl(false);\n        map.addControl(map.my_drawControl);\n      }\n\n      map.panTo(coords);\n    } else {\n      // delete marker\n      console.log('no coords, remove marker');\n      map.my_current_marker.remove();\n      delete (map.my_current_marker);\n      map.removeControl(map.my_drawControl);\n      map.my_drawControl = getDrawControl(true); // allow \"add marker\" again\n      map.addControl(map.my_drawControl);\n    }\n  };\n  document.getElementById('_geometry_lat').onblur = map.updateMarkerFromForm;\n  document.getElementById('_geometry_lon').onblur = map.updateMarkerFromForm;\n\n  // console.log(map)\n\n  console.log('initMap end');\n  return map;\n}\n\nmodule.exports = {\n  getMap: getMap,\n  initMap: initMap\n};\n","/*\n * This library handles calls to the transformap MMS api for the transformap editor\n *\n * Fri  21 Jul 14:30:00 UTC+1 2017\n * Alex Corbi (alexcorbi@posteo.net), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\nconst utils = require('./utils.js');\nconst RequestBody = require('maltypart').RequestBody;\nconst endpoint = utils.baseUrl + '/media/';\n\n/* returns the API's endpoint */\nfunction getMMSEndpoint () {\n  return endpoint;\n}\n\n/*\n * Creates a new media file for a certain POI\n * Params:\n *  - data: the metadata to create the media file with\n *  - blob: the blob to upload along the metadata\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction createNewMediaFile (data, blob, callback) {\n\n  if (!data) {\n    console.error('createNewMediaFile: no data given');\n    return false;\n  }\n  \n  if (!blob) {\n    console.error('createNewMediaFile: no blob given');\n    return false;\n  }\n  \n  var request = new RequestBody();\n  \n  if (data){\n    request.append(data);\n  }\n  \n  if (blob){\n    request.append(blob.name, {\n      contentType : blob.type,\n      data : blob.contents\n    });\n  }\n\n  var xhr = utils.createCORSRequest('POST', getMMSEndpoint());\n  xhr.setRequestHeader('Content-Type', request.getContentType());\n  xhr.withCredentials = true;\n  xhr.send(request.getData());\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Retrieves the metadata of a particular media file\n * Params:\n *  - mediaId: Media file's uuid\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction retrieveMetadataForMediaFile (mediaId, callback) {\n  if (!mediaId) {\n    console.error('retrieveMetadataForMediaFile: no mediaId given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('GET', getMMSEndpoint() + mediaId);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Creates a new media file for a certain POI\n * Params:\n *  - data: the metadata to create the media file with\n *  - blob: the blob to upload along the metadata\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction updateMediaFile (data, blob, callback) {\n  \n  if (!data) {\n    console.error('updateMediaFile: no data given');\n    return false;\n  }\n  \n  var request = new RequestBody();\n  \n  if (data){\n    request.append(data);\n  }\n  \n  if (blob){\n    request.append(blob.name, {\n      contentType : blob.type,\n      data : blob.content\n    });\n  }\n\n  var xhr = utils.createCORSRequest('POST', getMMSEndpoint());\n  xhr.setRequestHeader('Content-Type', request.getContentType());\n  xhr.withCredentials = true;\n  xhr.send(request.getData());\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Returns an array with all the versions of a certain media file\n * Params:\n *  - mediaId: Media file's uuid\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction retrieveMediaFileVersions (mediaId, callback) {\n  if (!mediaId) {\n    console.error('retrieveMediaFileVersions: no mediaId given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('GET', getMMSEndpoint() + mediaId + '/versions');\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Sets a version as currently active\n * Params:\n *  - mediaId: Media file's uuid\n *  - versionId: The uuid of the version to set as currently active\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction setActiveMediaFileVersion (mediaId, versionId, callback) {\n  if (!mediaId) {\n    console.error('setActiveMediaFileVersion: no mediaId given');\n    return false;\n  }\n  if (!versionId) {\n    console.error('setActiveMediaFileVersion: no versionId given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('POST', getMMSEndpoint() + mediaId + '/versions/' + versionId);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\nmodule.exports = {\n  getMMSEndpoint: getMMSEndpoint,\n  createNewMediaFile: createNewMediaFile,\n  updateMediaFile: updateMediaFile,\n  retrieveMetadataForMediaFile: retrieveMetadataForMediaFile,\n  retrieveMediaFileVersions: retrieveMediaFileVersions,\n  setActiveMediaFileVersion: setActiveMediaFileVersion\n};\n","/*\n * This library provides a 'fetch', where you can use fallback URIs, to build on redundant servers.\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n *\n * Give it an array of resources, that can be fetched from different urls.\n * Will try to fetch them in the provided order.\n * Execute successFunction on the first successful fetch, and errorFunction only if all resources fail to fetch.\n */\n\n/* This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\n/* new version of getting map data with promises\n\n  taken from https://blog.hospodarets.com/fetch_in_action\n*/\n\nvar processStatus = function (response) {\n  // status '0' to handle local files fetching (e.g. Cordova/Phonegap etc.)\n  if (response.status === 200 || response.status === 0) {\n    return Promise.resolve(response);\n  } else {\n    return Promise.reject(new Error(response.statusText));\n  }\n};\n\nvar parseJson = function (response) {\n  return response.json();\n};\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\n// It goes against Promise concept to not have external access to .resolve/.reject methods, but provides more flexibility\nvar getWrappedPromise = function () {\n  var wrappedPromise = {};\n  var promise = new Promise(function (resolve, reject) {\n    wrappedPromise.resolve = resolve;\n    wrappedPromise.reject = reject;\n  });\n  wrappedPromise.then = promise.then.bind(promise);\n  wrappedPromise.catch = promise.catch.bind(promise);\n  wrappedPromise.promise = promise; // e.g. if you want to provide somewhere only promise, without .resolve/.reject/.catch methods\n  return wrappedPromise;\n};\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\nvar getWrappedFetch = function () {\n  var wrappedPromise = getWrappedPromise();\n  var args = Array.prototype.slice.call(arguments); // arguments to Array\n\n  window.fetch.apply(null, args)// calling original fetch() method\n        .then(function (response) {\n          wrappedPromise.resolve(response);\n        }, function (error) {\n          wrappedPromise.reject(error);\n        })\n        .catch(function (error) {\n          wrappedPromise.catch(error);\n        });\n  return wrappedPromise;\n};\n\n/**\n * Fetch JSON by url\n * @param { {\n *  url: {String},\n *  [cacheBusting]: {Boolean}\n * } } params\n * @returns {Promise}\n*/var MAX_WAITING_TIME = 5000; // in ms\n\nvar getJSON = function (params) {\n  var wrappedFetch = getWrappedFetch(\n        params.cacheBusting ? params.url + '?' + new Date().getTime() : params.url,\n    {\n      method: 'get', // optional, 'GET' is default value\n      headers: {\n        'Accept': 'application/json'\n      }\n    });\n\n  var timeoutId = setTimeout(function () {\n    wrappedFetch.reject(new Error('Load timeout for resource: ' + params.url)); // reject on timeout\n  }, MAX_WAITING_TIME);\n\n  return wrappedFetch.promise// getting clear promise from wrapped\n        .then(function (response) {\n          clearTimeout(timeoutId);\n          return response;\n        })\n        .then(processStatus)\n        .then(parseJson);\n};\n\nfunction myGetJSON (url, successFunction, errorFunction) {\n  var getJSONparams = {\n    url: url, cacheBusting: true\n  };\n\n  getJSON(getJSONparams).then(\n    function (data) {\n      successFunction(data);\n    },\n    function (error) {\n      errorFunction(error);\n    }\n  );\n}\n\nfunction redundantFetch (dataUrlArray, successFunction, errorFunction, params) {\n  if (!(!!dataUrlArray && Array === dataUrlArray.constructor)) {\n    console.error('redundantFetch: argument is no array');\n    console.error(dataUrlArray);\n    return false;\n  }\n  var currentUrl = dataUrlArray[0];\n  if (typeof (currentUrl) !== 'string') {\n    console.error('redundantFetch: url is no string');\n    return false;\n  }\n\n  console.log('redundantFetch called, urls:');\n  console.log(dataUrlArray);\n\n  dataUrlArray.shift();\n\n  var localErrorFunction;\n  var localSuccessFunction;\n  if (dataUrlArray.length == 0) { // last iteration\n    localSuccessFunction = successFunction;\n    localErrorFunction = errorFunction;\n  } else {\n    localSuccessFunction = successFunction;\n    localErrorFunction = function (error) {\n      redundantFetch(dataUrlArray, successFunction, errorFunction, params);\n    };\n  }\n\n  var getJSONparams = {\n    url: currentUrl,\n    cacheBusting: (!((params && params.cacheBusting === false)))\n  };\n  getJSON(getJSONparams).then(\n    function (data) {\n      localSuccessFunction(data); console.log('rfetch: success on '); console.log(data);\n    },\n    function (error) {\n      localErrorFunction(error); console.log('rfetch: fail on '); console.log(error);\n    }\n  );\n}\n\nmodule.exports = redundantFetch;\n","/*\n * This library handles taxonomy related stuff for the transformap editor\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\n/* takes the language (string:\"iso\"), and the wished taxonomy (string: \"Qnn\") */\nfunction getLangTaxURL (lang, taxonomy) {\n  if (!lang) {\n    console.error('setFilterLang: no lang given');\n    return false;\n  }\n\n  if (!taxonomy) {\n     taxonomy = 'Q8';\n  }\n\n  var tax_query =\n    'prefix bd: <http://www.bigdata.com/rdf#> ' +\n    'prefix wikibase: <http://wikiba.se/ontology#> ' +\n    'prefix wdt: <https://base.transformap.co/prop/direct/>' +\n    'prefix wd: <https://base.transformap.co/entity/>' +\n    'SELECT ?item ?itemLabel ?instance_of ?subclass_of ?type_of_initiative_tag ?interaction_tag ?needs_tag ?identity_tag ?wikipedia ?description ' +\n    'WHERE {' +\n      '?item wdt:P8* wd:' + taxonomy + ' .' +\n      '?item wdt:P8 ?subclass_of .' +\n      'OPTIONAL { ?item wdt:P4 ?instance_of . }' +\n      'OPTIONAL { ?item wdt:P15 ?type_of_initiative_tag }' +\n      'OPTIONAL { ?item wdt:P16 ?interaction_tag }' +\n      'OPTIONAL { ?item wdt:P17 ?needs_tag }' +\n      'OPTIONAL { ?item wdt:P18 ?identity_tag }' +\n      'OPTIONAL { ?item schema:description ?description FILTER(LANG(?description) = \"' + lang + '\") }' +\n      'OPTIONAL { ?wikipedia schema:about ?item . ?wikipedia schema:inLanguage \"en\"}' +\n      'SERVICE wikibase:label {bd:serviceParam wikibase:language \"' + lang + '\" }' +\n    '}';\n\n  return 'https://query.base.transformap.co/bigdata/namespace/transformap/sparql?query=' + encodeURIComponent(tax_query) + '&format=json';\n}\n\nmodule.exports = {\n  getLangTaxURL: getLangTaxURL\n};\n","const redFetch = require('./red_fetch.js');\nconst taxonomy = require('./taxonomy.js');\nconst ui = require('./ui.js');\n\n// mostly taken from https://github.com/TransforMap/transformap-viewer/blob/gh-pages/scripts/map.js\n\nfunction getLangs () {\n  var language = window.navigator.languages ? window.navigator.languages[0] : (window.navigator.language || window.navigator.userLanguage);\n\n  if (typeof language === 'string') {\n    language = [ language ];\n  }\n\n  // we need to have the following languages:\n  // browserlang\n  // a short one (de instead of de-AT) if not present\n  // en as fallback if not present\n\n  for (var i = 0; i < language.length; i++) {\n    if (language[i].match(/-/)) {\n      var short_lang = language[i].match(/^([a-zA-Z]*)-/)[1];\n      if (language.indexOf(short_lang) == -1) {\n        language.push(short_lang);\n        continue;\n      }\n    }\n  }\n\n  if (language.indexOf('en') == -1) {\n    language.push('en')\n  };\n\n  console.log(language);\n  return language;\n}\n\nfunction setFallbackLangs () {\n  fallback_langs = [];\n  if (current_lang != 'en') {\n    for (var i = 0; i < browser_languages.length; i++) {\n      var abbr = browser_languages[i];\n      if (current_lang != abbr) {\n        fallback_langs.push(abbr);\n      }\n    }\n  }\n  console.log('new fallback langs: ' + fallback_langs.join(',') + '.');\n}\n\nfunction resetLang () {\n  current_lang = 'en';\n  for (var i = 0; i < browser_languages.length; i++) {\n    var abbr = browser_languages[i];\n    if (abbr_langnames[abbr]) {\n      current_lang = abbr;\n      break;\n    }\n  }\n  switchToLang(current_lang);\n}\n\n/* get languages for UI from our Wikibase, and pick languages that are translated there */\n\nvar supported_languages = [],\n  langnames = [],\n  abbr_langnames = {},\n  langnames_abbr = {};\n\nfunction initializeLanguageSwitcher (returned_data) {\n  var lang;\n  for (lang in returned_data.entities.Q5.labels) { // Q5 is arbitrary. Choose one that gets translated for sure.\n    supported_languages.push(lang);\n  }\n  var langstr = supported_languages.join('|');\n\n  var langstr_query =\n    'SELECT ?lang ?langLabel ?abbr ' +\n    'WHERE' +\n    '{' +\n      '?lang wdt:P218 ?abbr;' +\n      'FILTER regex (?abbr, \"^(' + langstr + ')$\").' +\n      'SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }' +\n    '}';\n\n  langstr_query = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql?query=' + encodeURIComponent(langstr_query) + '&format=json';\n  $.getJSON(langstr_query, function (langstrings) {\n    langstrings.results.bindings.forEach(function (item) {\n      abbr_langnames[item.abbr.value] = item.langLabel.value;\n      langnames_abbr[item.langLabel.value] = item.abbr.value;\n      langnames.push(item.langLabel.value);\n    });\n    langnames.sort();\n\n    resetLang();\n    setFallbackLangs();\n\n    langnames.forEach(function (item) {\n      var langcode = langnames_abbr[item];\n      var is_default = (langcode == current_lang) ? ' class=default' : '';\n      console.log(\"adding lang '\" + langcode + \"' (\" + item + ')');\n      $('#languageSelector ul').append('<li targetlang=' + langcode + is_default + \" onClick='window.translations.switchToLang(\\\"\" + langcode + \"\\\");'>\" + item + '</li>');\n    });\n  });\n}\n\nfunction fetchAndSetNewTranslation (lang) {\n  redFetch([ taxonomy.getLangTaxURL(lang, 'Q8'), 'https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy.' + lang + '.json' ],\n      ui.fillTOIs,\n      function (error) {\n        console.error('none of the taxonomy data urls available');\n      },\n      { cacheBusting: false });\n  redFetch([ taxonomy.getLangTaxURL(lang, 'Q4'), 'https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy.' + lang + '.json' ],\n      ui.fillTransforMapTax,\n      function (error) {\n        console.error('none of the taxonomy data urls available');\n      },\n      { cacheBusting: false });\n}\n\nfunction initializeTranslatedTOIs (Q5data) {\n  translations.initializeLanguageSwitcher(Q5data);\n\n  var nowPossibleLang = translations.selectAllowedLang(translations.current_lang);\n  translations.current_lang = nowPossibleLang;\n  fetchAndSetNewTranslation(nowPossibleLang);\n}\n\nfunction switchToLang (lang) {\n  $('#languageSelector li.default').removeClass('default');\n  $('#languageSelector li[targetlang=' + lang + ']').addClass('default');\n  current_lang = lang;\n  window.translations.current_lang = lang;\n  window.translations.fetchAndSetNewTranslation(lang);\n  setFallbackLangs();\n/*\n  //updateTranslatedTexts();\n\n  if(! dictionary[lang]) {\n    var dict_uri = \"https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/json/\"+lang+\".json\";\n\n    $.ajax({\n      url: dict_uri,\n      context: { lang: current_lang },\n      success: function(returned_data) {\n        var trans_jsonobj = JSON.parse(returned_data);\n\n        if(! dictionary[this.lang])\n          dictionary[this.lang] = {};\n        for (item in trans_jsonobj) {\n          var index = reverse_dic[item];\n          dictionary[this.lang][index] = trans_jsonobj[item];\n        }\n\n        console.log(\"successfully fetched \" + this.lang);\n        //updateTranslatedTexts();\n\n      }\n    });\n\n  }\n\n  // As rebuilding the filters does not yet support advanced mode by default,\n  // we switch to simple mode, as language switching is a very rare case.\n  if(getFilterMode() == \"advanced\")\n    toggleAdvancedFilterMode();\n\n  resetFilter();\n  setFilterLang(lang);\n*/\n  console.log('new lang:' + lang);\n}\n\n// if wishedLang is in supported, OK\n// shorten wishedLang and see if in supported\n// take fallback\nfunction selectAllowedLang (wishedLang) {\n  console.log('selectAllowedLang(' + wishedLang + ') called');\n  if (wishedLang) {\n    if (supported_languages.indexOf(wishedLang) != -1) {\n      current_lang = wishedLang;\n      return current_lang;\n    }\n    console.log('not in supported, try shorten');\n    var matches = wishedLang.match(/^([a-zA-Z]*)-/);\n    if (matches && matches[1]) {\n      var short_lang = matches[1];\n      console.log('short: ' + short_lang);\n      if (short_lang) {\n        if (supported_languages.indexOf(short_lang) != -1) {\n          current_lang = short_lang;\n          console.log('current_lang set to ' + short_lang);\n          return current_lang;\n        }\n      }\n    }\n  }\n  setFallbackLangs();\n  if (fallback_langs[0]) {\n    if (supported_languages.indexOf(fallback_langs[0]) != -1) {\n      current_lang = fallback_langs[0];\n      return current_lang;\n    }\n  }\n  current_lang = 'en';\n  return current_lang;\n}\n\nvar browser_languages = getLangs(),\n  current_lang = browser_languages[0],\n  fallback_langs = [];\n\nmodule.exports = {\n  getLangs: getLangs,\n  initializeLanguageSwitcher: initializeLanguageSwitcher,\n  initializeTranslatedTOIs: initializeTranslatedTOIs,\n  supported_languages: supported_languages,\n  browser_languages: browser_languages,\n  current_lang: current_lang,\n  switchToLang: switchToLang,\n  selectAllowedLang: selectAllowedLang,\n  fetchAndSetNewTranslation: fetchAndSetNewTranslation\n};\n","const dataApi = require('./data_api.js');\nconst mmsApi = require('./mms_api.js');\nconst authApi = require('./auth_api.js');\nconst userApi = require('./user_api.js');\nconst map = require('./map.js');\nconst utils = require('./utils.js');\n\nvar currentData = {}\n\nfunction fillForm (placeData) {\n\n  currentData = placeData;\n\n  if (currentData._deleted) {\n    document.getElementById('deleted').style.display = 'block';\n  }\n\n  if (currentData.properties) {\n    for (var key in currentData.properties) {\n      // ignore DB-generated fields\n      if (/^_/.test(key)) {\n        continue;\n      }\n\n      var field = document.getElementById('_key_' + key);\n      var value = currentData.properties[key];\n\n      if (field) {\n        // console.log(field)\n        // console.log(value)\n        field.value = value;\n      } else { // put it into \"free tags\"\n        // get last child\n        var freetags = document.getElementById('freetags');\n        var lastRow = freetags.lastChild;\n        while (lastRow.nodeType === 3) { // 3 = text-node\n          lastRow = lastRow.previousSibling;\n        }\n\n        // set data on last child\n        var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling;\n        keyNode.value = key;\n        var valueNode = (lastRow.lastChild.nodeType === 1) ? lastRow.lastChild : lastRow.lastChild.previousSibling;\n        valueNode.value = value;\n\n        addFreeTagsRow();\n      }\n    }\n  }\n\n  retrieveAndRenderMediaFilesForPOI(currentData);\n\n  if (currentData.geometry && currentData.geometry.coordinates) {\n    var lon = currentData.geometry.coordinates[0];\n    var lat = currentData.geometry.coordinates[1];\n    if (lat === undefined || lon === undefined) {\n      console.error('lat or lon empty');\n      return;\n    }\n\n    document.getElementById('_geometry_lon').value = lon;\n    document.getElementById('_geometry_lat').value = lat;\n\n    var mapInstance = map.getMap();\n    mapInstance.my_current_marker = new L.marker([lat, lon], {\n      icon: new mapInstance.my_placeMarker()\n    });\n    mapInstance.my_editableLayers.addLayer(mapInstance.my_current_marker);\n\n    mapInstance.my_drawControl = mapInstance.getDrawControl(false);\n    mapInstance.addControl(mapInstance.my_drawControl);\n\n    mapInstance.panTo(new L.LatLng(lat, lon));\n  } else { // allow adding a marker\n    mapInstance.my_drawControl = mapInstance.getDrawControl(true);\n    mapInstance.addControl(mapInstance.my_drawControl);\n  }\n\n  if (currentData.properties && currentData.properties._id) {\n    document.getElementById('_id').value = currentData.properties._id;\n    $('#transformapapilink').attr('href', dataApi.getDataEndpoint() + currentData.properties._id);\n  } else if (currentData._id) {\n    document.getElementById('_id').value = currentData._id;\n    $('#transformapapilink').attr('href', dataApi.getDataEndpoint() + currentData._id);\n  }\n\n  if (currentData.properties.osm) {\n    $('#osmlink').attr('href', currentData.properties.osm);\n  }\n\n}\n\nfunction retrieveAndRenderMediaFilesForPOI(currentData){\n  $('#media').html(\"\");\n  if (currentData.properties.media_files){\n    var mediaFileIds = currentData.properties.media_files;\n    $('.relatedMediaTitle').text('Related media files' + ' (' + mediaFileIds.length + ')');\n    for (var i=0; i< mediaFileIds.length; i++){\n      var mediaFileId = mediaFileIds[i];\n      mmsApi.retrieveMetadataForMediaFile(mediaFileId, function(mediaFile){\n\n        var row = $('<div class=\"row mediaFile '+ mediaFile.mediaId + '\"></div>');\n\n        var info = $('<div class=\"row mediaInfo\"></div>');\n        if (mediaFile.name){\n          info.append(\"<b>\" + mediaFile.name + \"</b>\");\n        }\n        if (mediaFile.description){\n          info.append(\"<p>\" + mediaFile.description + \"</p>\");\n        }\n\n        var options = $('<div class=\"row\"></div>');\n\n        var removeButton = $('<a class=\"mediaOption remove\">Remove</h4>');\n        removeButton.on('click',{ metadata : mediaFile, currentData: currentData },function (evt){\n          var data = evt.data;\n          console.log(\"removeButton clicked for mediaFile with id:\" + data.metadata.mediaId);\n          if (confirm(\"Are you sure you want to delete this media file?\")) {\n            dataAPI.removeMediaFileFromPOI(data.currentData._id,data.metadata.mediaId,function(){\n              $('.'+data.metadata.mediaId).remove();\n              retrieveAndRenderMediaFilesForPOI(currentData);\n            });\n          }\n        });\n\n        var editButton = $('<a class=\"mediaOption edit\" data-toggle=\"modal\" data-target=\"#mediaFileDialog\" data-id=\"' + mediaFile.mediaId + '\">Edit</h4>');\n        editButton.on('click',{ metadata : mediaFile, currentData: currentData }, function (evt){\n          var data = evt.data;\n\n          utils.resetCurrentBlob();\n\n          console.log(\"editButton clicked for mediaFile with id:\" + data.metadata.id);\n          $('#mediaFileDialogContent').find('.createOrUpdate').text(\"update\");\n          $('#mediaFileDialogContent').find('.mediaId').text(data.metadata.id);\n          $('#mediaFileDialogContent').find('.name').val(data.metadata.name);\n          $('#mediaFileDialogContent').find('.description').val(data.metadata.description);\n          $('#mediaFileDialogContent').find('img').attr(\"src\",data.metadata.url);\n          $('#mediaFileDialogContent').find('img').show();\n          $('#mediaFileDialogContent').find('.metadata').text(JSON.stringify(data.metadata));\n\n          document.getElementById('mediaUpload').addEventListener('change', utils.handleFileSelect, false);\n\n          mmsApi.retrieveMediaFileVersions(data.metadata.id, function(versionsArray){\n            if (versionsArray.length > 0){\n              var versionsList = $('<ul class=\"row\"></ul>');\n              for (var i=0; i < versionsArray.length; i++){\n                var version = versionsArray[i];\n                var versionInput = $('<li data-id=\"' + version.id + '\" class=\"versionItem\"><b>' + version.version_date + '</b> - ' + version.name + ' - ' + version.author + '</li></br>');\n                if (version.active){\n                  versionInput.append(' ').append('<b>[Active]</b>');\n                }else{\n                  var activateLink = $('<a data-id=\"' + version.id + '\" href=\"#\">Activate</a>');\n                  activateLink.on(\"click\",{ version : version}, function(evt){\n                    var versionData = evt.data;\n                    mmsApi.setActiveMediaFileVersion(data.metadata.id,versionData.version.id, function(){\n                      $('#mediaFileDialog').modal('toggle');\n                    });\n                  });\n                  versionInput.append(' ').append(activateLink);\n                }\n                versionsList.append(versionInput);\n              }\n              $('.mediaVersions').html(versionsList);\n            }\n          });\n        });\n\n        options.append(removeButton);\n        options.append(editButton);\n        info.append(options);\n\n        var imageUrl = 'https://s3.amazonaws.com/FringeBucket/image_placeholder.png';\n        if (mediaFile.mimetype === \"image/png\" || mediaFile.mimetype === \"image/jpeg\"){\n          imageUrl = mediaFile.url;\n        }\n        row.append('<img class=\"mediaThumb\" src=\"' + imageUrl + '\"/>');\n        row.append(info);\n\n        $('#media').append(row).append('<hr>');\n      });\n    }\n  }\n}\n\nfunction addLanguageSwitcher(){\n  // add languageswitcher\n  $('#menu').append(\n    '<div id=languageSelector onClick=\"$(\\'#languageSelector ul\\').toggleClass(\\'open\\');\">' +\n      '<span lang=en>Choose Language:</span>' +\n      '<ul></ul>' +\n    '</div>'\n  );\n}\n\nfunction addFreeTagsRow(){\n  var freetags = document.getElementById('freetags');\n\n  var lastRow = freetags.lastChild;\n  while (lastRow.nodeType === 3) { // 3 = text-node\n    lastRow = lastRow.previousSibling;\n  }\n\n  var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling;\n  var newNr = parseInt(keyNode.id.slice(-1)) + 1;\n\n  var newRow = document.createElement('div');\n  var divClass = document.createAttribute('class');\n  divClass.value = 'row';\n  newRow.setAttributeNode(divClass);\n  var newKey = document.createElement('input');\n  var bootstrapClass = document.createAttribute('class');\n  bootstrapClass.value = 'form-control';\n  newKey.setAttributeNode(bootstrapClass);\n  var bootstrapClass = document.createAttribute('class');\n  bootstrapClass.value = 'form-control';\n  var newValue = document.createElement('input');\n  newValue.setAttributeNode(bootstrapClass);\n  var keyId = document.createAttribute('id');\n  keyId.value = 'key' + newNr;\n  var valueId = document.createAttribute('id');\n  valueId.value = 'value' + newNr;\n  newKey.setAttributeNode(keyId);\n  newValue.setAttributeNode(valueId);\n\n  var elementName = document.createAttribute('name');\n  elementName.value = 'freetags';\n  newKey.setAttributeNode(elementName);\n  newValue.setAttributeNode(elementName.cloneNode(true));\n\n  newRow.appendChild(newKey);\n  newRow.appendChild(newValue);\n  freetags.appendChild(newRow);\n}\n\nfunction createToiArray (toiString) {\n  if (typeof (toiString) !== 'string') {\n    return [];\n  }\n  var toiArray = toiString.split(';');\n  for (var i = 0; i < toiArray.length; i++) {\n    toiArray[i] = toiArray[i].trim();\n  }\n  return toiArray;\n}\n\nfunction fillTransforMapTax (data) {\n  console.log('fillTransforMapTax called');\n\n  var dataArray = data.results.bindings;\n  const current_lang = dataArray[0].itemLabel['xml:lang'];\n\n  var needs = [];\n  var interactions = [];\n  var identities = [];\n\n  dataArray.forEach(function (entry) {\n    if (!entry.subclass_of) {\n      return;\n    }\n    var label = {};\n    label[current_lang] = entry.itemLabel.value;\n    var currentObject = {\n      item: entry.item.value,\n      label: label\n    };\n    if (entry.subclass_of.value == 'https://base.transformap.co/entity/Q146') {\n      currentObject['needs_tag'] = entry.needs_tag.value;\n      needs.push(currentObject);\n    } else if (entry.subclass_of.value == 'https://base.transformap.co/entity/Q150') {\n      currentObject['interaction_tag'] = entry.interaction_tag.value;\n      interactions.push(currentObject);\n    } else if (entry.subclass_of.value == 'https://base.transformap.co/entity/Q176') {\n      currentObject['identity_tag'] = entry.identity_tag.value;\n      identities.push(currentObject);\n    }\n  });\n\n  // needs\n  $('#_key_provides').empty();\n  needs.forEach(function (entry) {\n    var newOption = $('<option>');\n    newOption.attr('value', entry.needs_tag);\n\n    if (currentData.properties && currentData.properties.provides) {\n      var needs_array = createToiArray(currentData.properties.provides);\n      needs_array.forEach(function (need) {\n        if (need === entry.needs_tag) {\n          newOption.attr('selected', 'selected');\n        }\n      });\n    }\n    newOption.append(entry.label[current_lang]);\n    $('#_key_provides').append(newOption);\n    $('#_key_provides').selectpicker('refresh');\n  });\n\n  // interaction\n  $('#_key_interaction').empty();\n  interactions.forEach(function (entry) {\n    var newOption = $('<option>');\n    newOption.attr('value', entry.interaction_tag);\n\n    if (currentData.properties && currentData.properties.interaction) {\n      var interactions_array = createToiArray(currentData.properties.interaction);\n      interactions_array.forEach(function (interact) {\n        if (interact === entry.interaction_tag) {\n          newOption.attr('selected', 'selected');\n        }\n      });\n    }\n    newOption.append(entry.label[current_lang]);\n    $('#_key_interaction').append(newOption);\n    $('#_key_interaction').selectpicker('refresh');\n  });\n\n  // identity\n  $('#_key_identity').empty();\n  identities.forEach(function (entry) {\n    var newOption = $('<option>');\n    newOption.attr('value', entry.identity_tag);\n\n    if (currentData.properties && currentData.properties.identity) {\n      var identity_array = createToiArray(currentData.properties.identity);\n      identity_array.forEach(function (identity) {\n        if (identity === entry.identity_tag) {\n          newOption.attr('selected', 'selected');\n        }\n      });\n    }\n    newOption.append(entry.label[current_lang]);\n    $('#_key_identity').append(newOption);\n    $('#_key_identity').selectpicker('refresh');\n  });\n}\n\nfunction fillTOIs (data) {\n  $('#_key_type_of_initiative').empty();\n\n  var typeOfInintiatives = [];\n  var toiHashtable = {};\n\n  var toiSelect = document.getElementById('_key_type_of_initiative');\n  var dataArray = data.results.bindings;\n  const current_lang = dataArray[0].itemLabel['xml:lang'];\n  dataArray.forEach(function (entry) {\n    if (!entry.type_of_initiative_tag) {\n      return;\n    }\n    if (toiHashtable[entry.type_of_initiative_tag.value]) { // filter out duplicates\n      return;\n    }\n    var label = {};\n    label[current_lang] = entry.itemLabel.value;\n\n    var currentObject = {\n      item: entry.item.value,\n      label: label,\n      type_of_initiative_tag: entry.type_of_initiative_tag.value\n    };\n    typeOfInintiatives.push(currentObject);\n    toiHashtable[entry.type_of_initiative_tag.value] = currentObject;\n  });\n  function labelCompare (a, b) {\n    // 'Others' cat should get sorted last\n    if (a.item === 'https://base.transformap.co/entity/Q20') return 1;\n    if (b.item === 'https://base.transformap.co/entity/Q20') return -1;\n\n    // in toi list, 'other*' should be last\n    if (a.type_of_initiative_tag && a.type_of_initiative_tag.match(/^other_/)) return 1;\n    if (b.type_of_initiative_tag && b.type_of_initiative_tag.match(/^other_/)) return -1;\n\n    if (a.label[current_lang] < b.label[current_lang]) {\n      return -1;\n    } else {\n      return 1;\n    }\n  }\n  typeOfInintiatives.sort(labelCompare);\n\n  typeOfInintiatives.forEach(function (entry) {\n    var newOption = document.createElement('option');\n    var optionValue = document.createAttribute('value');\n    optionValue.value = entry.type_of_initiative_tag;\n    newOption.setAttributeNode(optionValue);\n\n    if (currentData.properties && currentData.properties.type_of_initiative) {\n      var tois = createToiArray(currentData.properties.type_of_initiative);\n      tois.forEach(function (toi) {\n        if (toi === entry.type_of_initiative_tag) {\n          var newSelected = document.createAttribute('selected');\n          newOption.setAttributeNode(newSelected);\n        }\n      });\n    }\n\n    var label = document.createTextNode(entry.label[current_lang]); // FIXME fallback langs\n    newOption.appendChild(label);\n\n    toiSelect.appendChild(newOption);\n    $('#_key_type_of_initiative').selectpicker('refresh');\n  });\n}\n\nfunction clickSubmit () {\n  console.log('clickSubmit enter');\n  const requiredFields = [ '_key_type_of_initiative', '_key_name', '_geometry_lat', '_geometry_lon' ];\n  for (var i = 0; i < requiredFields.length; i++) {\n    var id = requiredFields[i];\n    var value = document.getElementById(id).value;\n    if (!value || !value.length) {\n      console.error('submit: field ' + id + ' empty');\n      alert('Error on submit: field ' + id.replace(/^_key_/, '') + ' is not allowed to be empty');\n      return false;\n    }\n  }\n\n  var data = {\n    'type': 'Feature',\n    'properties': {\n    },\n    'geometry': {\n      'type': 'Point',\n      'coordinates': [\n        parseFloat(document.getElementById('_geometry_lon').value),\n        parseFloat(document.getElementById('_geometry_lat').value)\n      ]\n    }\n  };\n\n  // all 'input type=text'\n  var allInputs = document.getElementsByTagName('input');\n  var freeTags = {\n    keys: {}, values: {}\n  };\n\n  console.log(allInputs);\n\n  for (var i = 0; i < allInputs.length; i++) {\n    var element = allInputs[i];\n    if (element.type !== 'text') {\n      continue;\n    }\n    if (element.value && element.id) {\n      console.log(element.id + ': ' + element.value);\n      if (/^_key_/.test(element.id)) {\n        var key = element.id.replace(/^_key_/, '');\n        data.properties[key] = element.value.trim();\n     // element of 'free tags'\n      } else if (/^key[0-9]+$/.test(element.id) && element.name === 'freetags') {\n        var nr = element.id.replace(/^key/, '');\n        freeTags.keys[nr] = element.value;\n      } else if (/^value[0-9]+$/.test(element.id) && element.name === 'freetags') {\n        var nr = element.id.replace(/^value/, '');\n        freeTags.values[nr] = element.value;\n      }\n    }\n  }\n  console.log(freeTags);\n\n  for (var keynr in freeTags.keys) {\n    var key = freeTags.keys[keynr].trim();\n    if (key && freeTags.values[keynr]) { // only take if key and value are not \"\"\n      data.properties[key] = freeTags.values[keynr].trim();\n    }\n  }\n\n  // drop-down\n  var allSelects = document.getElementsByTagName('select');\n  for (var i = 0; i < allSelects.length; i++) {\n    var element = allSelects[i];\n    if (/^_key_/.test(element.id) && element.value) {\n      var key = element.id.replace(/^_key_/, '');\n\n      for (var childCounter = 0; childCounter < element.children.length; childCounter++) {\n        var child = element.children[childCounter];\n        if (child.selected === true) {\n          data.properties[key] = (data.properties[key] ? (data.properties[key] + ';') : '') + child.value;\n        }\n      }\n    }\n  }\n\n  // textarea\n  var allTextareas = document.getElementsByTagName('textarea');\n  for (var i = 0; i < allTextareas.length; i++) {\n    var element = allTextareas[i];\n    if (/^_key_/.test(element.id) && element.value) {\n      var key = element.id.replace(/^_key_/, '');\n      data.properties[key] = element.value.trim();\n    }\n  }\n\n  console.log(data);\n\n  const uuid = document.getElementById('_id').value;\n  const sendData = JSON.stringify(data);\n  console.log(sendData);\n\n  dataApi.createOrUpdatePOI(uuid, sendData, clickSubmitSuccess);\n\n  document.getElementById('deleted').style.display = 'none';\n}\n\nfunction clickSubmitSuccess (uuid) {\n  document.getElementById('_id').value = uuid;\n  $('#transformapapilink').attr('href', dataApi.getDataEndpoint() + uuid);\n  $('#osmlink').attr('href', $('#_key_osm').attr('value'));\n}\n\nfunction clickDelete () {\n  const uuid = document.getElementById('_id').value;\n\n  dataApi.deletePOI(uuid, clickDeleteSuccess);\n\n  document.getElementById('deleted').style.display = 'block';\n}\n\nfunction clickDeleteSuccess (uuid) {\n  console.log('Successfully deleted POI: ' + uuid);\n}\n\nfunction clickSearch () {\n  const country = document.getElementById('_key_addr:country').value;\n  const city = document.getElementById('_key_addr:city').value;\n  // const postcode = document.getElementById('_key_addr:postcode').value // postcode not used in nominatim, decreases result quality\n  const street = document.getElementById('_key_addr:street').value;\n  const housenumber = document.getElementById('_key_addr:housenumber').value;\n\n  var querystring = 'q=';\n  if (street) {\n    if (housenumber) {\n      querystring += housenumber + '+';\n    }\n    querystring += street + ',';\n  }\n  if (city) {\n    querystring += city + ',';\n  }\n  querystring += country;\n\n  var query = '//nominatim.openstreetmap.org/search?' + querystring + '&format=json&limit=1&email=mapping@transformap.co';\n  console.log(query);\n\n  redFetch([ query ], function (successData) {\n    console.log(successData);\n    if (successData.length !== 1) {\n      console.error('error in Nominatim return data: length != 1');\n      alert('Sorry, Nothing found');\n      return;\n    }\n    var result = successData[0];\n    if (result.class === 'building' ||\n        result.class === 'amenity' ||\n        result.class === 'shop' ||\n        (result.class === 'place' && result.type === 'house')\n      ) {\n      console.log('address found exactly');\n      document.getElementById('_geometry_lon').value = result.lon;\n      document.getElementById('_geometry_lat').value = result.lat;\n\n      // trigger update of place marker\n      document.getElementById('_geometry_lat').focus();\n      document.getElementById('_geometry_lon').focus();\n      map.getMap().setView(new L.LatLng(result.lat, result.lon), 18);\n    } else {\n      map.getMap().setView(new L.LatLng(result.lat, result.lon), 18);\n      console.log('address not found exactly');\n      setTimeout(function () { // wait for map to pan to location\n        alert('Attention: The address was not found exactly, please place the marker manually!');\n        document.getElementById('_geometry_lon').value = '';\n        document.getElementById('_geometry_lat').value = '';\n        document.getElementById('_geometry_lon').focus();\n        document.getElementById('_geometry_lat').focus();\n      }, 400);\n    }\n  }, function (error) {\n    console.log(error);\n    alert('Sorry, Address search did not work');\n  })\n}\n\nfunction stopRKey (evt) {\n  var evt = (evt) || ((event) || null);\n  var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);\n  if ((evt.keyCode == 13) && (node.type == 'text')) {\n    return false;\n  }\n}\n\nfunction clickMediaSave () {\n  var poi = JSON.parse($('#mediaFileDialogContent').find('.poi').text());\n  var mediaId = $('#mediaFileDialogContent').find('.mediaId').text();\n\n  if ($('#mediaFileDialogContent').find('.createOrUpdate').text() == \"create\"){\n    var data = {\n      name: $('#mediaFileDialogContent').find('.name').val(),\n      description: $('#mediaFileDialogContent').find('.name').val(),\n      versionDate: new Date().toISOString()\n    };\n    if (utils.getCurrentBlob()){\n      mmsApi.createNewMediaFile(data, utils.getCurrentBlob(), function(){\n        $('#mediaFileDialog').modal('toggle');\n      });\n    }else{\n      alert(\"Please add an asset\");\n    }\n  }else if ($('#mediaFileDialogContent').find('.createOrUpdate').text() == \"update\"){\n    var metadataChanged = false;\n    var data = JSON.parse($('#mediaFileDialogContent').find('.metadata').text());\n    var nameField = $('#mediaFileDialogContent').find('.name').val();\n    if (data.name != nameField){\n      data.name = nameField;\n    }\n    var descriptionField = $('#mediaFileDialogContent').find('.description').val();\n    if (data.description != descriptionField){\n      data.description = descriptionField;\n    }\n    mmsApi.updateMediaFile(mediaId, data, utils.getCurrentBlob(), function(){\n      $('#mediaFileDialog').modal('toggle');\n    });\n  }\n\n}\n\nfunction clickMediaCancel () {\n  $('#mediaFileDialog').modal('toggle');\n}\n\nfunction clickNewMedia(){\n\n  utils.resetCurrentBlob();\n\n  console.log(\"newMedia button clicked\");\n  $('#mediaFileDialogContent').find('.createOrUpdate').text(\"create\");\n  $('#mediaFileDialogContent').find('.poi').text(JSON.stringify(currentData));\n  $('#mediaFileDialogContent').find('.name').val(\"\");\n  $('#mediaFileDialogContent').find('.description').val(\"\");\n  $('#mediaFileDialogContent').find('img').hide();\n  $('#mediaFileDialogContent').find('.metadata').text(\"\");\n  $('#mediaFileDialogContent').find('.mediaVersions').html(\"\");\n\n  document.getElementById('mediaUpload').addEventListener('change', utils.handleFileSelect, false);\n}\n\nfunction toggleLoginButton(){\n  authApi.checkIfAuth(data => {\n    $('#loginbutton').text(\"Logout\");\n    $('#loginbutton').attr(\"href\",\"#\");\n    $('#save').removeAttr(\"disabled\");\n  },() => {\n    $('#loginbutton').text(\"Login\");\n    $('#loginbutton').attr(\"href\",authApi.getAuthEndpoint());\n    $('#save').attr(\"disabled\",\"disabled\");\n  })\n}\n\nmodule.exports = {\n  fillForm: fillForm,\n  addLanguageSwitcher: addLanguageSwitcher,\n  addFreeTagsRow: addFreeTagsRow,\n  fillTransforMapTax: fillTransforMapTax,\n  fillTOIs: fillTOIs,\n  map: map,\n  clickSubmit: clickSubmit,\n  clickDelete: clickDelete,\n  clickSearch: clickSearch,\n  stopRKey: stopRKey,\n  clickMediaSave:clickMediaSave,\n  clickMediaCancel: clickMediaCancel,\n  clickNewMedia: clickNewMedia,\n  toggleLoginButton: toggleLoginButton,\n};\n","/*\n * This library handles calls to user api for the transformap editor\n *\n * Fri  21 Jul 14:30:00 UTC+1 2017\n * Alex Corbi (alexcorbi@posteo.net), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\nconst utils = require('./utils.js');\n\nconst endpoint = utils.baseUrl + '/users/';\n\n/* returns the API's endpoint */\nfunction getUserEndpoint () {\n  return endpoint;\n}\n\n/*\n * Gets the metadata of a certain user\n * Params:\n *  - userId: the id of the user to pull data from\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction getUser (userId,callback) {\n  if (!userId){\n    console.log('getUser: no userId given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('GET', endpoint + userId);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send();\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\n/*\n * Updates the metadata of a certain user\n * Params:\n *  - userId: the id of the user to update data from\n *  - callback: function to be called upon success.\n * Returns: false if invalid call\n*/\nfunction updateUser (userId,data,callback) {\n  if (!userId){\n    console.log('updateUser: no userId given');\n    return false;\n  }\n\n  if (!data){\n    console.log('updateUser: no data given');\n    return false;\n  }\n\n  var xhr = utils.createCORSRequest('PUT', endpoint + userId);\n  xhr.setRequestHeader('Content-Type', 'application/json');\n  xhr.withCredentials = true;\n  xhr.send(data);\n\n  xhr.onreadystatechange = function () {\n    if (xhr.readyState === 4) {\n      if (xhr.status === 200) {\n        callback(JSON.parse(xhr.responseText));\n      } else {\n        console.error(xhr);\n      }\n    }\n  };\n}\n\nmodule.exports = {\n  getUserEndpoint: getUserEndpoint,\n  getUser: getUser\n};\n","var currentBlob;\n\nconst baseUrl = $ENVSTATIC_BASE_URL !== \"//undefined\" ? $ENVSTATIC_BASE_URL : \"\";\n/*\n * This library provide utility functions\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n * Fri  21 Jul 14:30:00 UTC+1 2017\n * Alex Corbi (alexcorbi@posteo.net), WTFPL\n *\n * returns object with key:value pairs\n\n This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\nfunction createCORSRequest (method, url) {\n  // taken from https://www.html5rocks.com/en/tutorials/cors/\n  var xhr = new XMLHttpRequest();\n  if ('withCredentials' in xhr) {\n    // Check if the XMLHttpRequest object has a \"withCredentials\" property.\n    // \"withCredentials\" only exists on XMLHTTPRequest2 objects.\n    xhr.open(method, url, true);\n  } else if (typeof XDomainRequest !== 'undefined') {\n    // Otherwise, check if XDomainRequest.\n    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.\n    xhr = new XDomainRequest();\n    xhr.open(method, url);\n  } else {\n    // Otherwise, CORS is not supported by the browser.\n    xhr = null;\n  }\n  return xhr;\n}\n\nfunction getUrlVars () {\n  var vars = {};\n  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {\n    vars[key] = value.replace(/#.*$/, '');\n  });\n  return vars;\n}\n\nfunction getUrlPath(url){\n  var reg = /.+?\\:\\/\\/.+?(\\/.+?)(?:#|\\?|$)/;\n  return reg.exec(url)[1];\n}\n\nfunction generateUUID() {\n    var d = new Date().getTime();\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n    });\n    return uuid;\n}\n\nfunction handleFileSelect(evt,callback) {\n  var files = evt.target.files;\n  var reader = new FileReader();\n\n  reader.onload = function(event) {\n    var contents = event.target.result;\n    currentBlob = {\n      name: files[0].name,\n      type: files[0].type,\n      contents: contents\n    };\n    $('#mediaFileDialogContent').find('img').attr('src', contents);\n    $('#mediaFileDialogContent').find('img').show();\n  };\n\n  reader.onerror = function(event) {\n    console.error(\"File could not be read! Code \" + event.target.error.code);\n    ui.currentBlob = undefined;\n  };\n\n  var accept = {\n    binary : [\"image/png\", \"image/jpeg\"]\n  };\n\n  var file;\n\n  for (var i = 0; i < files.length; i++) {\n    file = files[i];\n\n    if (file !== null) {\n      if (accept.binary.indexOf(file.type) > -1) {\n        reader.readAsDataURL(file);\n      }\n    }\n  }\n}\n\nfunction getCurrentBlob(){\n  return currentBlob;\n}\n\nfunction resetCurrentBlob(){\n  currentBlob = undefined;\n}\n\nfunction getCookie(cname) {\n    var name = cname + \"=\";\n    var decodedCookie = decodeURIComponent(document.cookie);\n    var ca = decodedCookie.split(';');\n    for(var i = 0; i <ca.length; i++) {\n        var c = ca[i];\n        while (c.charAt(0) == ' ') {\n            c = c.substring(1);\n        }\n        if (c.indexOf(name) == 0) {\n            return c.substring(name.length, c.length);\n        }\n    }\n    return \"\";\n}\n\nfunction setCookie(cname, cvalue, exdays) {\n    var d = new Date();\n    d.setTime(d.getTime() + (exdays*24*60*60*1000));\n    var expires = \"expires=\"+ d.toUTCString();\n    document.cookie = cname + \"=\" + cvalue + \";\" + expires + \";path=/\";\n}\n\nmodule.exports = {\n  createCORSRequest: createCORSRequest,\n  getUrlVars: getUrlVars,\n  getUrlPath: getUrlPath,\n  generateUUID: generateUUID,\n  handleFileSelect: handleFileSelect,\n  getCurrentBlob: getCurrentBlob,\n  baseUrl: baseUrl,\n  resetCurrentBlob: resetCurrentBlob,\n  getCookie: getCookie,\n  setCookie: setCookie\n};\n"]}